    <!DOCTYPE html>
    <html lang="zh-TW">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>KTV ÊéíÈöäÁ≥ªÁµ±</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                background-attachment: fixed;
                min-height: 100vh;
                padding: 20px;
                color: #333;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            /* Header */
            header {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                margin-bottom: 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 20px;
                border: 2px solid rgba(255, 255, 255, 0.3);
            }

            header h1 {
                font-size: 2.5em;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                text-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            }

            .header-buttons {
                display: flex;
                gap: 10px;
            }

            /* Buttons */
            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 10px;
                font-size: 1em;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                position: relative;
                overflow: hidden;
            }

            .btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }

            .btn:active::before {
                width: 300px;
                height: 300px;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            }

            .btn:active {
                transform: translateY(0);
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .btn-secondary {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
            }

            .btn-control {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                font-size: 1.2em;
                padding: 15px 30px;
            }

            .btn-warning {
                background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
                color: white;
                width: 100%;
                margin-top: 10px;
            }

            .btn-danger {
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                color: white;
                width: 100%;
                margin-top: 10px;
            }

            .btn-large {
                width: 100%;
                padding: 15px;
                font-size: 1.1em;
            }

            /* Tab Navigation */
            .tab-navigation {
                display: flex;
                gap: 0;
                margin-bottom: 20px;
                background: rgba(224, 224, 224, 0.3);
                backdrop-filter: blur(10px);
                border-radius: 12px;
                padding: 4px;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .tab-btn {
                flex: 1;
                padding: 12px 20px;
                border: none;
                background: transparent;
                color: #666;
                font-size: 1em;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border-radius: 10px;
                position: relative;
            }

            .tab-btn::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                width: 0;
                height: 2px;
                background: linear-gradient(90deg, #667eea, #764ba2);
                transform: translateX(-50%);
                transition: width 0.3s ease;
            }

            .tab-btn.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                transform: translateY(-2px);
            }

            .tab-btn.active::after {
                width: 80%;
            }

            .tab-btn:hover:not(.active) {
                background: rgba(255, 255, 255, 0.5);
                transform: translateY(-1px);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            /* Sections */
            section {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                margin-bottom: 30px;
                border: 2px solid rgba(255, 255, 255, 0.3);
            }

            section h2 {
                font-size: 1.8em;
                margin-bottom: 20px;
                color: #667eea;
            }

            /* Now Playing */
            .current-song-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 30px;
                border-radius: 15px;
                color: white;
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
                animation: fadeIn 0.5s ease;
                position: relative;
                overflow: hidden;
            }

            .current-song-card::before {
                content: '';
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                animation: pulse 3s ease-in-out infinite;
            }

            @keyframes pulse {
                0%, 100% { transform: scale(1); opacity: 0.5; }
                50% { transform: scale(1.1); opacity: 0.8; }
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .current-song-card .song-info {
                position: relative;
                z-index: 1;
            }

            .current-song-card .song-info h3 {
                font-size: 2em;
                margin-bottom: 10px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }

            .current-song-card .song-info p {
                font-size: 1.2em;
                opacity: 0.9;
                margin-bottom: 5px;
                text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            }

            .current-song-thumbnail {
                width: 200px;
                height: 150px;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                flex-shrink: 0;
                position: relative;
                z-index: 1;
                border: 3px solid rgba(255,255,255,0.3);
                transition: transform 0.3s ease;
            }

            .current-song-thumbnail:hover {
                transform: scale(1.05);
            }

            .current-song-thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .control-panel-thumbnail {
                width: 120px;
                height: 90px;
            }

            .control-panel-thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                border: 2px solid rgba(255, 255, 255, 0.5);
            }

            .no-song {
                text-align: center;
                padding: 40px;
                font-size: 1.2em;
                opacity: 0.7;
            }

            /* Player */
            .player-section {
                background: #000;
                position: relative;
                transition: all 0.5s ease;
            }

            /* ÂÅáÂÖ®Ëû¢ÂπïÊ®°Âºè */
            .player-section.fake-fullscreen {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 9999 !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .player-section.fake-fullscreen #player-container {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                padding-bottom: 0 !important;
            }

            .player-section.fake-fullscreen .lyrics-section {
                position: fixed !important;
                bottom: -50px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                z-index: 10000 !important;
                width: 90% !important;
                max-width: 1200px !important;
            }
            
            .player-section.fake-fullscreen .lyrics-container {
                display: block !important;
                text-align: center !important;
            }

            .player-section.fake-fullscreen .lyrics-line.active {
                font-size: 3em !important;
                text-shadow: 3px 3px 15px rgba(0, 0, 0, 0.95),
                            0 0 30px rgba(0, 0, 0, 0.9),
                            0 0 10px rgba(255, 255, 255, 0.4) !important;
            }
            
            .player-section.fake-fullscreen .lyrics-countdown.active {
                font-size: 2em !important;
            }

            #player-container {
                position: relative;
                padding-bottom: 56.25%; /* 16:9 */
                height: 0;
                overflow: hidden;
            }

            #player {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            /* Queue List */
            .queue-list {
                display: flex;
                flex-direction: column;
                gap: 15px;
                max-height: 600px;
                overflow-y: auto;
                padding-right: 10px;
            }

            .queue-list::-webkit-scrollbar {
                width: 8px;
            }

            .queue-list::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            .queue-list::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
            }

            .queue-list::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            }

            .queue-item {
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                padding: 15px;
                border-radius: 15px;
                display: flex;
                gap: 15px;
                align-items: center;
                transition: all 0.3s ease;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                cursor: move;
                user-select: none;
            }

            .queue-item.playing {
                background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
                box-shadow: 0 5px 20px rgba(253, 203, 110, 0.5);
                border: 2px solid #fdcb6e;
            }

            .queue-item.completed {
                background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
                opacity: 0.6;
                cursor: default;
            }

            .queue-item:hover {
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            }

            .queue-item.completed:hover {
                transform: none;
            }

            .queue-item.sortable-chosen {
                cursor: grabbing;
            }

            .queue-item.sortable-ghost {
                opacity: 0.3;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .queue-item.sortable-drag {
                opacity: 1;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                transform: rotate(2deg) scale(1.05);
            }

            .queue-item-thumbnail {
                flex-shrink: 0;
                width: 120px;
                height: 90px;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                position: relative;
            }

            .queue-item-thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }



            .queue-item-info {
                flex: 1;
                min-width: 0;
            }

            .queue-item-number {
                font-size: 1.8em;
                font-weight: bold;
                color: #667eea;
                min-width: 40px;
                text-align: center;
            }

            .queue-item-info h4 {
                font-size: 1.2em;
                margin-bottom: 5px;
                color: #333;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .queue-item-drag-handle {
                font-size: 1em;
                color: #999;
                cursor: move;
                padding: 0 5px;
            }

            .queue-item-drag-handle:hover {
                color: #667eea;
            }

            .queue-item-info p {
                color: #666;
                font-size: 0.9em;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .queue-item-actions button {
                background: #ff6b6b;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                white-space: nowrap;
            }

            .queue-item-actions button:hover {
                background: #ee5a6f;
                transform: scale(1.05);
            }

            .queue-item-actions button.added {
                animation: addedAnimation 0.6s ease;
            }

            .queue-item-actions button:disabled {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                cursor: not-allowed;
                transform: scale(1);
            }

            .empty-queue {
                text-align: center;
                padding: 60px 20px;
                color: #999;
                font-size: 1.2em;
            }

            /* Modal */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(5px);
            }

            .modal-content {
                background: white;
                margin: 5% auto;
                padding: 40px;
                border-radius: 20px;
                width: 90%;
                max-width: 600px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    transform: translateY(-50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
                transition: color 0.3s ease;
            }

            .close:hover {
                color: #000;
            }

            /* Form */
            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #333;
            }

            .form-group input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 1em;
                transition: border-color 0.3s ease;
            }

            .form-group input:focus {
                outline: none;
                border-color: #667eea;
            }

            .form-group small {
                display: block;
                margin-top: 5px;
                color: #999;
                font-size: 0.85em;
            }

            /* Add Song Tab Content */
            .add-song-tab-content {
                display: none;
            }

            .add-song-tab-content.active {
                display: block;
            }

            /* Search Results */
            .search-result-item {
                display: flex;
                gap: 15px;
                align-items: center;
                padding: 12px;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                border-radius: 12px;
                margin-bottom: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .search-result-item:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                background: linear-gradient(135deg, #e8eaf6 0%, #b8c5e0 100%);
            }

            .search-result-thumbnail {
                width: 120px;
                height: 90px;
                border-radius: 8px;
                overflow: hidden;
                flex-shrink: 0;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            }

            .search-result-thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .search-result-info {
                flex: 1;
                min-width: 0;
            }

            .search-result-info h4 {
                font-size: 1.1em;
                margin-bottom: 5px;
                color: #333;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
            }

            .search-result-info p {
                font-size: 0.85em;
                color: #666;
            }

            .search-result-add-btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                white-space: nowrap;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                flex-shrink: 0;
                position: relative;
                overflow: hidden;
                min-width: 90px;
            }

            .search-result-add-btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }

            .search-result-add-btn:active::before {
                width: 200px;
                height: 200px;
            }

            .search-result-add-btn:hover:not(:disabled) {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .search-result-add-btn:disabled {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                cursor: not-allowed;
                transform: scale(1);
            }

            .search-result-add-btn.added {
                animation: addedAnimation 0.6s ease;
            }

            @keyframes addedAnimation {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.2) rotate(5deg);
                }
                100% {
                    transform: scale(1);
                }
            }

            /* Pagination */
            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 15px;
                margin-top: 20px;
                padding: 15px;
            }

            .pagination button {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .pagination button:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .pagination button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .pagination-info {
                font-size: 0.9em;
                color: #666;
                font-weight: 600;
            }

            /* Control Panel */
            .control-panel {
                padding: 20px 0;
            }

            .control-info {
                background: #f5f7fa;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
            }

            .control-info p {
                margin-bottom: 10px;
                font-size: 1.1em;
            }

            .control-buttons {
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-bottom: 20px;
            }

            .control-actions {
                display: flex;
                flex-direction: column;
            }

            /* Responsive */
            @media (max-width: 768px) {
                body {
                    padding: 10px;
                }

                .container {
                    max-width: 100%;
                }

                header {
                    flex-direction: column;
                    text-align: center;
                    padding: 20px;
                }

                header h1 {
                    font-size: 1.5em;
                }

                .header-buttons {
                    width: 100%;
                    flex-direction: column;
                }

                .header-buttons .btn {
                    font-size: 0.9em;
                    padding: 10px 20px;
                }

                /* Á∏ÆÂ∞è section ÂÖßË∑ù */
                section {
                    padding: 15px;
                    margin-bottom: 15px;
                }

                section h2 {
                    font-size: 1.3em;
                    margin-bottom: 15px;
                }

                /* ÁèæÊ≠£Êí≠ÊîæÂçÄÂüü */
                .current-song-card {
                    padding: 15px;
                }

                .current-song-card .song-info h3 {
                    font-size: 0.85em !important;
                    margin-bottom: 8px;
                    line-height: 1.4;
                    word-wrap: break-word;
                }

                .current-song-card .song-info {
                    gap: 12px !important;
                }

                .current-song-card .song-info p {
                    font-size: 0.9em;
                }

                .current-song-thumbnail {
                    width: 80px;
                    height: 60px;
                }

                .control-panel-thumbnail {
                    width: 120px;
                    height: 90px;
                }   

                .no-song {
                    padding: 20px;
                    font-size: 1em;
                }

                /* Êí≠ÊîæÂô®ÂçÄÂüü */
                .player-section {
                    padding: 0;
                }

                /* ÊéíÈöäÂàóË°® */
                .queue-list {
                    gap: 10px;
                    max-height: 400px;
                }

                .control-buttons {
                    flex-direction: column;
                }

                .queue-item {
                    flex-direction: row;
                    align-items: center;
                    gap: 8px;
                    padding: 10px;
                }

                .queue-item-drag-handle {
                    font-size: 1.2em;
                    padding: 0 3px;
                }

                .queue-item-thumbnail {
                    width: 60px;
                    height: 45px;
                }

                .queue-item-number {
                    font-size: 1em;
                    min-width: 25px;
                }

                .queue-item-info {
                    flex: 1;
                    min-width: 0;
                }

                .queue-item-info h4 {
                    font-size: 0.85em;
                    line-height: 1.3;
                    word-wrap: break-word;
                    white-space: normal;
                    overflow: hidden;
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    line-clamp: 2;
                    -webkit-box-orient: vertical;
                }

                .queue-item-info p {
                    font-size: 0.75em;
                }

                .queue-item-actions {
                    width: auto;
                    flex-shrink: 0;
                }

                .queue-item-actions button {
                    padding: 5px 10px;
                    font-size: 0.8em;
                }

                .empty-queue {
                    padding: 30px 10px;
                    font-size: 0.9em;
                }

                /* ÂÑ™Âåñ‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤ÂçÄÂüü */
                .next-song-section {
                    padding: 12px;
                }

                .next-song-section h2 {
                    font-size: 1.1em;
                }

                /* Modal ÂÖßÂÆπ */
                .modal-content {
                    width: 95%;
                    margin: 10% auto;
                    padding: 20px;
                }

                .modal-content h2 {
                    font-size: 1.3em;
                }

                .form-group label {
                    font-size: 0.9em;
                }

                .form-group input {
                    padding: 10px;
                    font-size: 0.9em;
                }

                .form-group small {
                    font-size: 0.8em;
                }

                .btn-large {
                    padding: 12px;
                    font-size: 1em;
                }

                /* ÊéßÂà∂Èù¢Êùø */
                .control-info {
                    padding: 15px;
                    font-size: 0.9em;
                }

                .control-info p {
                    font-size: 0.95em;
                    margin-bottom: 8px;
                }

                .btn-control {
                    font-size: 0.85em;
                    padding: 10px 15px;
                }

                /* ÊéßÂà∂Èù¢ÊùøÊåâÈàïÂÑ™Âåñ */
                #controlModal .modal-content {
                    padding: 15px;
                }

                /* ÊéßÂà∂Èù¢ÊùøÊ≠£Âú®Êí≠ÊîæÂ≠óÈ´î */
                #controlCurrentSong {
                    font-size: 0.85em !important;
                }

                #controlModal .btn {
                    font-size: 0.8em !important;
                    padding: 10px 6px !important;
                }

                #controlModal .btn div:first-child {
                    font-size: 1.1em !important;
                }

                #controlModal .btn div:last-child {
                    font-size: 0.7em !important;
                }

                /* ÊêúÂ∞ãÁµêÊûúÊâãÊ©üÁâà */
                #searchResults {
                    max-height: 250px !important;
                }

                .search-result-item {
                    flex-direction: row;
                    gap: 8px;
                    padding: 10px;
                }

                .search-result-thumbnail {
                    width: 60px;
                    height: 45px;
                }

                .search-result-info h4 {
                    font-size: 0.85em;
                    -webkit-line-clamp: 2;
                    line-clamp: 2;
                }

                .search-result-info p {
                    font-size: 0.75em;
                }

                .search-result-add-btn {
                    padding: 6px 12px;
                    font-size: 0.8em;
                    white-space: nowrap;
                }

                /* ÂàÜÈ†ÅÊåâÈàïÊâãÊ©üÁâà */
                .pagination {
                    padding: 10px;
                    gap: 10px;
                }

                .pagination button {
                    padding: 8px 12px;
                    font-size: 0.85em;
                }

                .pagination-info {
                    font-size: 0.85em;
                }
            }

            /* Loading Animation */
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Control Panel Button Hover Effects */
            #controlModal .btn:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            }

            #controlModal .btn:active {
                transform: translateY(0) scale(0.98);
            }

            #playPauseBtn:hover {
                box-shadow: 0 8px 25px rgba(253, 203, 110, 0.6) !important;
            }

            #prevBtn:hover, #nextBtn:hover {
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5) !important;
            }

            #clearQueueBtn:hover {
                box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5) !important;
            }

            /* Ê≠åË©ûÈñãÈóúÊåâÈàï */
            .lyrics-toggle-btn {
                position: relative;
                width: 60px;
                height: 30px;
                background: #ccc;
                border: none;
                border-radius: 15px;
                cursor: pointer;
                transition: background 0.3s ease;
                padding: 0;
                outline: none;
            }

            .lyrics-toggle-btn.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .lyrics-toggle-btn::after {
                content: '';
                position: absolute;
                top: 3px;
                left: 3px;
                width: 24px;
                height: 24px;
                background: white;
                border-radius: 50%;
                transition: left 0.3s ease;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }

            .lyrics-toggle-btn.active::after {
                left: 33px;
            }

            /* Ê≠åË©ûÈ°ØÁ§∫ */
            .lyrics-section {
                position: absolute;
                bottom: -60px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 1000px;
                z-index: 2147483647 !important;
                pointer-events: none;
                background: none !important;
                background-color: transparent !important;
                background-image: none !important;
                box-shadow: none !important;
                border: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }

            .lyrics-section.show {
                display: block;
            }

            .lyrics-toggle {
                display: none;
            }

            .lyrics-container {
                background: none !important;
                background-color: transparent !important;
                background-image: none !important;
                padding: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                display: block;           /* ÊîπÁÇ∫ block ËÆìÊ≠åË©û‰∏ä‰∏ãÊéíÂàó */
                text-align: center;       /* ‰øùÊåÅÂ±Ö‰∏≠Â∞çÈΩä */
                min-height: auto;
            }

            .lyrics-container::-webkit-scrollbar {
                display: none;
            }

            .lyrics-line {
                padding: 0 !important;
                margin: 0 !important;
                font-size: 2em;
                line-height: 1.4;
                color: white;
                transition: all 0.3s ease;
                text-align: center;
                display: none;
                font-weight: 500;
                background: none !important;
                background-color: transparent !important;
                background-image: none !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.95),
                            0 0 15px rgba(0, 0, 0, 0.8);
                position: relative;
            }

            .lyrics-line.active {
                background: none !important;
                background-color: transparent !important;
                background-image: none !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                color: white;
                font-size: 2.5em;
                font-weight: 600;
                display: block;
                animation: fadeInLyrics 0.3s ease;
                padding: 0 !important;
                margin: 0 !important;
                text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.95),
                            0 0 20px rgba(0, 0, 0, 0.9),
                            0 0 5px rgba(255, 255, 255, 0.3);
            }

            @keyframes fadeInLyrics {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .lyrics-line.past {
                opacity: 0;
                display: none;
            }

            .lyrics-line.future {
                opacity: 0;
                display: none;
            }

            .no-lyrics {
                display: none;
            }

            .lyrics-loading {
                display: none;
            }

            /* ÂÖ•Ê≠åÂÄíÊï∏ÊèêÈÜí */
            .countdown-overlay {
                position: absolute;
                top: 50%;
                left: 20%;
                transform: translate(0, -50%);
                z-index: 100;
                font-size: 8em;
                font-weight: bold;
                color: white;
                text-shadow: 0 0 30px rgba(0, 0, 0, 0.8),
                            0 0 60px rgba(102, 126, 234, 0.6);
                animation: countdownPulse 1s ease-out;
                pointer-events: none;
            }

            @keyframes countdownPulse {
                0% {
                    opacity: 0;
                    transform: translate(0, -50%) scale(0.5);
                }
                50% {
                    opacity: 1;
                    transform: translate(0, -50%) scale(1.2);
                }
                100% {
                    opacity: 0;
                    transform: translate(0, -50%) scale(1);
                }
            }

            /* ÂÄíÊï∏ÈªûÊ®£Âºè - ËàáÊ≠åË©ûÂ∑¶Â∞çÈΩäÔºå‰∏ä‰∏ãÊéíÂàó */
            .lyrics-countdown {
                font-size: 1.5em;
                text-align: center;        /* Â±Ö‰∏≠Â∞çÈΩä */
                display: none;             /* È†êË®≠Èö±Ëóè */
                margin-bottom: 0.3em;      /* Ëàá‰∏ãÊñπÊ≠åË©ûÁöÑÈñìË∑ù */
            }
            
            .lyrics-countdown.active {
                display: block;            /* ÂïüÂãïÊôÇÈ°ØÁ§∫ */
            }

            .countdown-dot {
                display: inline-block;
                margin: 0 0.15em;          /* Èªû‰πãÈñìÁöÑÈñìË∑ù */
                opacity: 1;
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.8),
                            0 0 20px rgba(255, 255, 255, 0.5);
            }
            
            .countdown-dot:first-child {
                margin-left: 0;            /* Á¨¨‰∏ÄÂÄãÈªûÂ∑¶ÈÇä‰∏çÁïôÈñìË∑ù */
            }

            /* ÂÄíÊï∏ÈªûÊ∂àÂ§±ÂãïÁï´ - ‰ΩøÁî® CSS ÂãïÁï´ÈÅøÂÖç setTimeout ÂïèÈ°å */
            .lyrics-countdown.active .countdown-dot.dot-1 {
                animation: dotFadeOut 0.3s ease-out 0.9s forwards;
            }

            .lyrics-countdown.active .countdown-dot.dot-2 {
                animation: dotFadeOut 0.3s ease-out 1.8s forwards;
            }

            .lyrics-countdown.active .countdown-dot.dot-3 {
                animation: dotFadeOut 0.3s ease-out 2.7s forwards;
            }

            @keyframes dotFadeOut {
                from {
                    opacity: 1;
                }
                to {
                    opacity: 0;
                }
            }

            /* ÂÄíÊï∏ÈªûÂíåÁ¨¨‰∏ÄÂè•Ê≠åË©û‰∏ÄËµ∑È°ØÁ§∫ÊôÇÁöÑÊ®£Âºè */
            .first-lyric-with-countdown {
                margin-top: 0 !important;  /* Á∑äË≤ºÂÄíÊï∏Èªû‰∏ãÊñπ */
            }

            .lyrics-toggle {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 12px;
            }

            .lyrics-toggle h2 {
                margin: 0;
                font-size: 1.5em;
            }

            .lyrics-btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                font-size: 0.9em;
            }

            .lyrics-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            @media (max-width: 768px) {
                .lyrics-section {
                    bottom: -30px;
                    width: 95%;
                    background: none !important;
                    background-color: transparent !important;
                    background-image: none !important;
                    backdrop-filter: none !important;
                    -webkit-backdrop-filter: none !important;
                }

                .lyrics-container {
                    padding: 0 !important;
                    background: none !important;
                    background-color: transparent !important;
                    background-image: none !important;
                    backdrop-filter: none !important;
                    -webkit-backdrop-filter: none !important;
                }

                .lyrics-line {
                    font-size: 1.1em;
                    background: none !important;
                    background-color: transparent !important;
                    background-image: none !important;
                }

                .lyrics-line.active {
                    font-size: 1.3em;
                    background: none !important;
                    background-color: transparent !important;
                    background-image: none !important;
                }

                .countdown-overlay {
                    font-size: 5em;
                }

                .lyrics-countdown {
                    font-size: 1.5em;
                }

                .countdown-dot {
                    margin: 0 0.1em;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <h1 style="margin: 0;">ÈªûÊ≠åÁ≥ªÁµ±</h1>
                    <img src="3.gif" alt="animation" style="width: 60px; height: 60px; object-fit: contain;">
                    <img src="2.gif" alt="animation" style="width: 60px; height: 60px; object-fit: contain;">
                    <img src="1.gif" alt="animation" style="width: 60px; height: 60px; object-fit: contain;">
                </div>
                <div class="header-buttons">
                    <button id="addSongBtn" class="btn btn-primary">‚ûï Âä†ÂÖ•Ê≠åÊõ≤</button>
                    <button id="songListBtn" class="btn btn-secondary">üìã Ê≠åÊõ≤ÂàóË°®</button>
                    <button id="controlPanelBtn" class="btn btn-secondary">üéõÔ∏è ÊéßÂà∂Èù¢Êùø</button>
                    <button id="qrCodeBtn" class="btn btn-secondary">üì± QR Code</button>
                </div>
            </header>

            <!-- Áï∂ÂâçÊí≠Êîæ -->
            <section class="now-playing">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üéµ ÁèæÊ≠£Êí≠Êîæ</h2>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                        <span id="lyricsStatusText" style="font-size: 0.8em; color: #ff6b6b; display: none;">Êâæ‰∏çÂà∞Ê≠åË©û</span>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 0.9em; color: #666;">Ëá™ÂãïÊí≠Êîæ</span>
                                <button id="toggleAutoplayBtn" class="lyrics-toggle-btn"></button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 0.9em; color: #666;">Ê≠åË©û</span>
                                <button id="toggleLyricsBtn" class="lyrics-toggle-btn"></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="currentSong" class="current-song-card">
                    <div class="no-song">ÁõÆÂâçÊ≤íÊúâÊ≠åÊõ≤Êí≠Êîæ</div>
                </div>
            </section>

            <!-- YouTube Êí≠ÊîæÂô® -->
            <section class="player-section">
                <div id="player-container">
                    <div id="player"></div>
                    
                    <!-- Ê≠åË©ûÈ°ØÁ§∫ÁñäÂä†Âú®ÂΩ±Áâá‰∏ä -->
                    <section class="lyrics-section" id="lyricsSection">
                        <div class="lyrics-container" id="lyricsContainer">
                            <div class="no-lyrics"></div>
                        </div>
                    </section>
                </div>
            </section>

            <!-- ‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤ -->
            <section class="next-song-section">
                <h2>‚è≠Ô∏è ‰∏ã‰∏ÄÈ¶ñ</h2>
                <div id="nextSongDisplay" class="queue-list" style="max-height: 300px;">
                    <div class="empty-queue">Ê≤íÊúâ‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤</div>
                </div>
            </section>
        </div>

        <!-- Ê∑ªÂä†Ê≠åÊõ≤ Modal -->
        <div id="addSongModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close">&times;</span>
                <h2 style="margin-bottom: 25px;">‚ûï Âä†ÂÖ•Ê≠åÊõ≤</h2>
                
                <!-- Tab ÂàáÊèõÔºöÈÄ£Áµê / ÊêúÂ∞ã -->
                <div class="tab-navigation" style="margin-bottom: 20px;">
                    <button class="tab-btn active" data-tab="url" id="urlTabBtn">üîó Ë≤º‰∏äÈÄ£Áµê</button>
                    <button class="tab-btn" data-tab="search" id="searchTabBtn">üîç ÊêúÂ∞ãÂΩ±Áâá</button>
                </div>

                <!-- ÈÄ£ÁµêËº∏ÂÖ• Tab -->
                <div id="urlTabContent" class="add-song-tab-content active">
                    <form id="addSongForm">
                        <div class="form-group">
                            <label for="youtubeUrl">YouTube ÈÄ£Áµê</label>
                            <input type="url" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=...">
                            <small>Ë≤º‰∏ä YouTube ÂΩ±ÁâáÈÄ£ÁµêÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÁç≤ÂèñÊ≠åÂêç</small>
                        </div>
                        <button type="submit" class="btn btn-primary btn-large">
                            <span id="addBtnText">Âä†ÂÖ•ÊéíÈöä</span>
                        </button>
                    </form>
                </div>

                <!-- ÊêúÂ∞ã Tab -->
                <div id="searchTabContent" class="add-song-tab-content">
                    <div class="form-group">
                        <label for="searchInput">ÊêúÂ∞ãÈóúÈçµÂ≠ó</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="searchInput" placeholder="Ëº∏ÂÖ•Ê≠åÂêç„ÄÅÊ≠åÊâãÊàñÈóúÈçµÂ≠ó..." style="flex: 1;">
                            <button id="searchBtn" class="btn btn-primary" style="white-space: nowrap; padding: 12px 24px;">
                                <span id="searchBtnText">üîç ÊêúÂ∞ã</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- ÊêúÂ∞ãÁµêÊûú -->
                    <div id="searchResults" style="max-height: 300px; overflow-y: auto; margin-top: 20px;">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            Ëº∏ÂÖ•ÈóúÈçµÂ≠óÈñãÂßãÊêúÂ∞ã
                        </div>
                    </div>
                    
                    <!-- ÂàÜÈ†ÅÊåâÈàï -->
                    <div id="pagination" class="pagination" style="display: none;">
                        <button id="prevPageBtn" onclick="changePage(-1)">‚¨ÖÔ∏è ‰∏ä‰∏ÄÈ†Å</button>
                        <span id="pageInfo" class="pagination-info">Á¨¨ 1 È†Å</span>
                        <button id="nextPageBtn" onclick="changePage(1)">‰∏ã‰∏ÄÈ†Å ‚û°Ô∏è</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊéßÂà∂Èù¢Êùø Modal -->
        <div id="controlModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="close">&times;</span>
                <h2 style="text-align: center; margin-bottom: 25px;">üéõÔ∏è ÊéßÂà∂Èù¢Êùø</h2>
                <!-- ÊéßÂà∂Èù¢ÊùøÂÖßÂÆπ -->
                <div id="controlPanelContent">
                    <div class="control-panel">
                        <!-- Áï∂ÂâçÊ≠åÊõ≤Ë≥áË®äÂç°Áâá -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);">
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div id="controlThumbnail" style="flex-shrink: 0;">
                                    <div style="width: 140px; height: 105px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                                        ÁÑ°Á∏ÆÂúñ
                                    </div>
                                </div>
                                <div style="flex: 1; color: white;">
                                    <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px; font-weight: 500;">üéµ Ê≠£Âú®Êí≠Êîæ</p>
                                    <p id="controlCurrentSong" style="font-size: 1.3em; font-weight: 600; line-height: 1.4; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">ÁÑ°</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÂàáÊ≠åÊåâÈàïÁµÑ -->
                        <div style="background: rgba(246, 248, 250, 0.8); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                            <p style="font-size: 0.85em; color: #666; margin-bottom: 12px; font-weight: 600; text-align: center;">üéµ ÂàáÊèõÊ≠åÊõ≤</p>
                            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                                <button id="prevBtn" class="btn" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1.1em; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                    <div style="font-size: 1.3em; margin-bottom: 5px;">‚èÆÔ∏è</div>
                                    <div>‰∏ä‰∏ÄÈ¶ñ</div>
                                </button>
                                <button id="nextBtn" class="btn" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1.1em; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                    <div style="font-size: 1.3em; margin-bottom: 5px;">‚è≠Ô∏è</div>
                                    <div>‰∏ã‰∏ÄÈ¶ñ</div>
                                </button>
                                <button id="fakeFullscreenBtn" class="btn" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; font-size: 1.1em; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);">
                                    <div style="font-size: 1.3em; margin-bottom: 5px;">‚õ∂</div>
                                    <div>Â§ßËû¢Âπï</div>
                                </button>
                            </div>
                            <button id="randomBtn" class="btn" style="width: 100%; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; font-size: 1em; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                                <span style="font-size: 1.2em; margin-right: 5px;">üé≤</span> Èö®Ê©üÊéíÂ∫è
                            </button>
                        </div>
                        
                        <!-- Âç±Èö™Êìç‰Ωú -->
                        <div class="control-actions">
                            <button id="clearQueueBtn" class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);">
                                üóëÔ∏è Ê∏ÖÁ©∫ÊéíÈöäÂàóË°®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrCodeModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 style="margin-bottom: 25px;">üì± ÊéÉÊèè QR Code Âä†ÂÖ•Ê≠åÊõ≤</h2>
                <div style="text-align: center; padding: 20px;">
                    <img src="ktv_qr_code.png" alt="KTV QR Code" style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                </div>
            </div>
        </div>

        <!-- Ê≠åÊõ≤ÂàóË°® Modal -->
        <div id="songListModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <span class="close">&times;</span>
                <h2 style="margin-bottom: 25px;">üìã Ê≠åÊõ≤ÂàóË°®</h2>
                
                <!-- Tab Â∞éËà™ -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="queue">ÊéíÈöä‰∏≠ (<span id="queueCount">0</span>)</button>
                    <button class="tab-btn" data-tab="all">ÊâÄÊúâÊ≠åÊõ≤ (<span id="allSongsCount">0</span>)</button>
                    <button class="tab-btn" data-tab="history">Ê≠∑Âè≤Ë®òÈåÑ (<span id="historyCount">0</span>)</button>
                </div>

                <!-- ÊéíÈöäÂàóË°®ÂÖßÂÆπ -->
                <div id="queueTab" class="tab-content active">
                    <div id="queueList" class="queue-list">
                        <div class="empty-queue">ÁõÆÂâçÊ≤íÊúâÊéíÈöäÁöÑÊ≠åÊõ≤</div>
                    </div>
                </div>

                <!-- ÊâÄÊúâÊ≠åÊõ≤ÂÖßÂÆπ -->
                <div id="allTab" class="tab-content">
                    <div id="allSongsList" class="queue-list">
                        <div class="empty-queue">ÁõÆÂâçÊ≤íÊúâÊ≠åÊõ≤</div>
                    </div>
                </div>

                <!-- Ê≠∑Âè≤Ë®òÈåÑÂÖßÂÆπ -->
                <div id="historyTab" class="tab-content">
                    <div style="margin-bottom: 15px;">
                        <button id="clearHistoryBtn" class="btn btn-warning">üóëÔ∏è Ê∏ÖÈô§Ê≠∑Âè≤Ë®òÈåÑ</button>
                    </div>
                    <div id="historyList" class="queue-list">
                        <div class="empty-queue">ÁõÆÂâçÊ≤íÊúâÊ≠∑Âè≤Ë®òÈåÑ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
        
        <!-- SortableJS -->
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        
        <!-- YouTube IFrame API -->
        <script src="https://www.youtube.com/iframe_api"></script>
        <script>
            // ========================================
            // Firebase ÈÖçÁΩÆ
            // ========================================
            const firebaseConfig = {
                apiKey: "AIzaSyA_uBESf6A9gSP6CPhpIdISNKw5C5DHUuA",
                authDomain: "ktv-queue-system.firebaseapp.com",
                databaseURL: "https://ktv-queue-system-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "ktv-queue-system",
                storageBucket: "ktv-queue-system.firebasestorage.app",
                messagingSenderId: "152366647471",
                appId: "1:152366647471:web:d2936422e308c017b5ec5a"
            };

            // ÂàùÂßãÂåñ Firebase
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const queueRef = database.ref('queue');
            const currentIndexRef = database.ref('currentSongIndex');
            const historyRef = database.ref('history');

            // ÂÖ®Â±ÄËÆäÊï∏
            let player;
            let queue = [];
            let history = [];
            let currentSongIndex = -1;
            let isPlaying = false;
            let currentTab = 'queue';
            const YOUTUBE_API_KEY = "AIzaSyC9AM2D58fmNpyQNbU7pUsCOX7GVEWIrA4"; // YouTube API Key

            // Ê≠åË©ûÁõ∏ÈóúËÆäÊï∏
            let currentLyrics = [];
            let lyricsUpdateInterval = null;
            let currentLyricsIndex = -1;
            let lyricsEnabled = false; // È†êË®≠ÈóúÈñâÊ≠åË©û
            
            // Ëá™ÂãïÊí≠ÊîæË®≠ÂÆö - Âæû localStorage ËÆÄÂèñÔºåÈ†êË®≠ÁÇ∫ trueÔºàÈñãÂïüÔºâ
            let autoplayEnabled = localStorage.getItem('autoplayEnabled');
            if (autoplayEnabled === null) {
                autoplayEnabled = true; // È†êË®≠ÈñãÂïüËá™ÂãïÊí≠Êîæ
                localStorage.setItem('autoplayEnabled', 'true');
            } else {
                autoplayEnabled = autoplayEnabled === 'true';
            }
            
            // Èò≤Ê≠¢ Firebase Áõ£ËÅΩÂô®ËàáÊú¨Âú∞Êìç‰ΩúË°ùÁ™Å
            let isSavingToFirebase = false;

            // Áõ£ËÅΩ Firebase Êï∏ÊìöËÆäÂåñ
            function setupFirebaseListeners() {
                // Áõ£ËÅΩÊéíÈöäÂàóË°®ËÆäÂåñ
                queueRef.on('value', (snapshot) => {
                    // Â¶ÇÊûúÊ≠£Âú®‰øùÂ≠òÊï∏ÊìöÔºåË∑≥ÈÅéÈÄôÊ¨°Êõ¥Êñ∞ÈÅøÂÖçË°ùÁ™Å
                    if (isSavingToFirebase) {
                        console.log('‚è≠Ô∏è Skipping Firebase update (saving in progress)');
                        return;
                    }
                    
                    const data = snapshot.val();
                    if (data) {
                        queue = data;
                    } else {
                        queue = [];
                    }
                    updateUI();
                });

                // Áõ£ËÅΩÊ≠∑Âè≤Ë®òÈåÑËÆäÂåñ
                historyRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        history = data;
                    } else {
                        history = [];
                    }
                    updateUI();
                });

                // Áõ£ËÅΩÁï∂ÂâçÊí≠ÊîæÁ¥¢ÂºïËÆäÂåñ
                currentIndexRef.on('value', (snapshot) => {
                    // Â¶ÇÊûúÊ≠£Âú®‰øùÂ≠òÊï∏ÊìöÔºåË∑≥ÈÅéÈÄôÊ¨°Êõ¥Êñ∞ÈÅøÂÖçË°ùÁ™Å
                    if (isSavingToFirebase) {
                        console.log('‚è≠Ô∏è Skipping Firebase index update (saving in progress)');
                        return;
                    }
                    
                    const index = snapshot.val();
                    if (index !== null && index !== currentSongIndex) {
                        const oldIndex = currentSongIndex;
                        currentSongIndex = index;
                        
                        // Â¶ÇÊûúÁ¥¢ÂºïÊîπËÆä‰∏îÊí≠ÊîæÂô®Â∑≤Ê∫ñÂÇôÂ•ΩÔºåËºâÂÖ•Êñ∞Ê≠åÊõ≤
                        if (oldIndex !== index && currentSongIndex >= 0 && currentSongIndex < queue.length) {
                            const song = queue[currentSongIndex];
                            const videoId = extractVideoId(song.url);
                            if (videoId && player) {
                                // Ê†πÊìöËá™ÂãïÊí≠ÊîæË®≠ÂÆö‰ΩøÁî®‰∏çÂêåÁöÑÊñπÊ≥ï
                                if (autoplayEnabled) {
                                    console.log('üé¨ Firebase Êõ¥Êñ∞: Ëá™ÂãïÊí≠ÊîæÂ∑≤ÈñãÂïüÔºå‰ΩøÁî® loadVideoById');
                                    if (player.loadVideoById) {
                                        player.loadVideoById(videoId);
                                    }
                                } else {
                                    console.log('‚è∏Ô∏è Firebase Êõ¥Êñ∞: Ëá™ÂãïÊí≠ÊîæÂ∑≤ÈóúÈñâÔºå‰ΩøÁî® cueVideoById');
                                    if (player.cueVideoById) {
                                        player.cueVideoById(videoId);
                                    }
                                }
                            }
                        }
                        updateUI();
                    }
                });
            }

            // ‰øùÂ≠òÊï∏ÊìöÂà∞ Firebase
            async function saveToFirebase() {
                try {
                    isSavingToFirebase = true;
                    await queueRef.set(queue);
                    await currentIndexRef.set(currentSongIndex);
                    console.log('‚úÖ Data saved to Firebase successfully');
                    
                    // Áü≠Êö´Âª∂ÈÅ≤ÂæåÈáçÊñ∞ÂïüÁî®Áõ£ËÅΩÂô®Êõ¥Êñ∞
                    setTimeout(() => {
                        isSavingToFirebase = false;
                    }, 500);
                } catch (error) {
                    console.error('‚ùå Error saving to Firebase:', error);
                    isSavingToFirebase = false;
                }
            }

            // ‰øùÂ≠òÊ≠∑Âè≤Ë®òÈåÑÂà∞ Firebase
            function saveHistoryToFirebase() {
                historyRef.set(history);
            }

            // Ê∑ªÂä†Âà∞Ê≠∑Âè≤Ë®òÈåÑÔºàÂéªÈáçÔºâ
            function addToHistory(song) {
                console.log('üéµ Adding to history:', song);
                const videoId = extractVideoId(song.url);
                console.log('üìπ Video ID:', videoId);
                
                // Ê™¢Êü•Êú¨Âú∞Ê≠∑Âè≤ÊòØÂê¶Â∑≤Â≠òÂú®
                const exists = history.some(h => extractVideoId(h.url) === videoId);
                console.log('üîç Already exists:', exists);
                
                if (!exists) {
                    // Ê∑ªÂä†Âà∞Êú¨Âú∞Êï∏ÁµÑÈñãÈ†≠ÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢Ôºâ
                    const newHistoryItem = {
                        songName: song.songName,
                        url: song.url,
                        addedAt: new Date().toISOString()
                    };
                    
                    history.unshift(newHistoryItem);
                    console.log('‚úÖ Added to history:', newHistoryItem);
                    console.log('üìä History length:', history.length);
                    
                    // ‰øùÂ≠òÂà∞ Firebase
                    historyRef.set(history).then(() => {
                        console.log('üíæ Saved to Firebase successfully');
                        updateUI();
                    }).catch((error) => {
                        console.error('‚ùå Firebase save error:', error);
                    });
                } else {
                    console.log('‚ö†Ô∏è Song already in history, skipping');
                }
            }

            // Âæû YouTube URL ÊèêÂèñÂΩ±Áâá ID
            function extractVideoId(url) {
                if (!url) return null;
                
                // ÊñπÊ≥ï 1: ËôïÁêÜ youtu.be Áü≠Á∂≤ÂùÄ
                let match = url.match(/youtu\.be\/([^?&]+)/);
                if (match) return match[1];
                
                // ÊñπÊ≥ï 2: ËôïÁêÜÊ®ôÊ∫ñ youtube.com Á∂≤ÂùÄ
                match = url.match(/[?&]v=([^&]+)/);
                if (match) return match[1];
                
                // ÊñπÊ≥ï 3: ËôïÁêÜ embed Á∂≤ÂùÄ
                match = url.match(/\/embed\/([^?&]+)/);
                if (match) return match[1];
                
                // ÊñπÊ≥ï 4: ËàäÁöÑÊ≠£ÂâáË°®ÈÅîÂºè‰ΩúÁÇ∫ÊúÄÂæåÂÇôÁî®
                const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
                match = url.match(regExp);
                return (match && match[7].length === 11) ? match[7] : null;
            }

            // Áç≤Âèñ YouTube Á∏ÆÂúñ URL
            function getThumbnailUrl(videoId) {
                return `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
            }

            // ========================================
            // Ê≠åË©ûÂäüËÉΩ
            // ========================================

            // ÂæûÊ≠åÊõ≤Ê®ôÈ°åËß£ÊûêÊ≠åÊâãÂíåÊ≠åÂêç
            function parseSongTitle(title) {
                console.log('üéµ Parsing title:', title);
                
                // ÁßªÈô§Â∏∏Ë¶ãÁöÑÁÑ°ÈóúÂ≠óË©û
                let cleanTitle = title
                    .replace(/\(Official.*?\)/gi, '')
                    .replace(/\[Official.*?\]/gi, '')
                    .replace(/Official/gi, '')
                    .replace(/Music Video/gi, '')
                    .replace(/MV/gi, '')
                    .replace(/Video/gi, '')
                    .replace(/Audio/gi, '')
                    .replace(/Lyric.*?/gi, '')
                    .replace(/HD/gi, '')
                    .replace(/4K/gi, '')
                    .replace(/\(.*?Ver.*?\)/gi, '')
                    .replace(/\[.*?Ver.*?\]/gi, '')
                    .trim();
                
                // Â∏∏Ë¶ãÂàÜÈöîÁ¨¶: - / | „Äê„Äë
                let artist = '';
                let track = cleanTitle;
                
                // ÊñπÊ≥ï 1: ‰ΩøÁî® - ÂàÜÈöî
                if (cleanTitle.includes(' - ')) {
                    const parts = cleanTitle.split(' - ');
                    artist = parts[0].trim();
                    track = parts[1].trim();
                    
                    // ‰∏çË¶ÅÂú®ÈÄôË£°Á∏ÆÊ∏õÊ≠åÂêçÔºå‰øùÁïôÂÆåÊï¥ÁöÑÊ≠åÂêçËÆìÊêúÂ∞ãÈöéÊÆµËôïÁêÜ
                    // ‰æãÂ¶Ç‰øùÁïô "Êù±ÈÇ™ Peach Blossom Island" ÂÆåÊï¥ÂΩ¢Âºè
                }
                // ÊñπÊ≥ï 2: ‰ΩøÁî® / ÂàÜÈöî
                else if (cleanTitle.includes(' / ')) {
                    const parts = cleanTitle.split(' / ');
                    artist = parts[0].trim();
                    track = parts[1].trim();
                }
                // ÊñπÊ≥ï 3: ‰ΩøÁî® | ÂàÜÈöî
                else if (cleanTitle.includes(' | ')) {
                    const parts = cleanTitle.split(' | ');
                    artist = parts[0].trim();
                    track = parts[1].trim();
                }
                // ÊñπÊ≥ï 4: ‰ΩøÁî®„Äê„ÄëÂàÜÈöî (‰∏≠ÊñáÂ∏∏Ë¶ãÊ†ºÂºè)
                else if (cleanTitle.includes('„Äê') && cleanTitle.includes('„Äë')) {
                    const match = cleanTitle.match(/(.+?)„Äê(.+?)„Äë/);
                    if (match) {
                        artist = match[1].trim();
                        track = match[2].trim();
                    }
                }
                
                console.log('üé§ Parsed - Artist:', artist, 'Track:', track);
                return { artist, track };
            }

            // Âæû LRCLIB Áç≤ÂèñÊ≠åË©û
            async function fetchLyricsFromLRCLIB(artist, track) {
                try {
                    const url = `https://lrclib.net/api/search?artist_name=${encodeURIComponent(artist)}&track_name=${encodeURIComponent(track)}`;
                    console.log('üîç LRCLIB API URL:', url);
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.log('‚ùå LRCLIB response not ok:', response.status);
                        return null;
                    }
                    
                    const data = await response.json();
                    console.log('üì¶ LRCLIB response:', data);
                    
                    if (data && data.length > 0) {
                        // ÂèñÁ¨¨‰∏ÄÂÄãÁµêÊûú
                        const result = data[0];
                        if (result.syncedLyrics) {
                            console.log('‚úÖ Found synced lyrics!');
                            return result.syncedLyrics;
                        } else if (result.plainLyrics) {
                            console.log('‚ö†Ô∏è Only plain lyrics available');
                            return result.plainLyrics;
                        }
                    }
                    
                    console.log('‚ùå No lyrics found in LRCLIB');
                    return null;
                } catch (error) {
                    console.error('‚ùå LRCLIB error:', error);
                    return null;
                }
            }

            // Âæû YouTube ÊèèËø∞ÊàñÂÖ∂‰ªñ‰æÜÊ∫êÁç≤ÂèñÊ≠åË©ûÔºàÂÇôÁî®ÊñπÊ°àÔºâ
            async function fetchLyricsBackup(songName) {
                try {
                    // ÂòóË©¶ÂæûÊ≠åÂêç‰∏≠ÊèêÂèñÈóúÈçµÂ≠ó
                    const cleanName = songName
                        .replace(/\(.*?\)/g, '')
                        .replace(/\[.*?\]/g, '')
                        .replace(/official|mv|video|audio|lyrics?/gi, '')
                        .trim();
                    
                    console.log('üîÑ Trying backup search with:', cleanName);
                    
                    // ‰ΩøÁî® LRCLIB ÁöÑÊ®°Á≥äÊêúÂ∞ã
                    const url = `https://lrclib.net/api/search?q=${encodeURIComponent(cleanName)}`;
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            const result = data[0];
                            if (result.syncedLyrics) {
                                console.log('‚úÖ Found lyrics via backup search!');
                                return result.syncedLyrics;
                            }
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error('‚ùå Backup search error:', error);
                    return null;
                }
            }

            // Ëß£Êûê LRC Ê†ºÂºèÊ≠åË©û
            function parseLRC(lrcText) {
                if (!lrcText) return [];
                
                const lines = lrcText.split('\n');
                const lyrics = [];
                
                for (const line of lines) {
                    // ÂåπÈÖçÊôÇÈñìÊ®ôÁ±§ [mm:ss.xx] Êàñ [mm:ss]
                    const match = line.match(/\[(\d{2}):(\d{2})\.?(\d{2})?\](.*)/);
                    if (match) {
                        const minutes = parseInt(match[1]);
                        const seconds = parseInt(match[2]);
                        const centiseconds = match[3] ? parseInt(match[3]) : 0;
                        const text = match[4].trim();
                        
                        // ËΩâÊèõÁÇ∫Áßí
                        const time = minutes * 60 + seconds + centiseconds / 100;
                        
                        if (text) {  // Âè™Ê∑ªÂä†ÊúâÊñáÂ≠óÁöÑË°å
                            lyrics.push({ time, text });
                        }
                    }
                }
                
                // ÊåâÊôÇÈñìÊéíÂ∫è
                lyrics.sort((a, b) => a.time - b.time);
                
                console.log('üìù Parsed lyrics:', lyrics.length, 'lines');
                return lyrics;
            }

            // Ê™¢Êü•Ê≠åË©ûÊòØÂê¶ÂèØÁî®ÔºàÈùúÈªòÊ™¢Êü•Ôºå‰∏çÈ°ØÁ§∫ËºâÂÖ•‰∏≠Ôºâ
            async function checkLyricsAvailability(songName) {
                try {
                    console.log('üîç Checking lyrics availability for:', songName);
                    
                    const toggleBtn = document.getElementById('toggleLyricsBtn');
                    const statusText = document.getElementById('lyricsStatusText');
                    
                    // Ëß£ÊûêÊ≠åÂêç
                    const { artist, track } = parseSongTitle(songName);
                    
                    if (!track) {
                        console.log('‚ùå Cannot parse song title');
                        if (toggleBtn) {
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        if (statusText) {
                            statusText.style.display = 'block';
                        }
                        return false;
                    }
                    
                    // Ê∫ñÂÇôÂ§öÁ®ÆÊêúÂ∞ãÈóúÈçµÂ≠óÁµÑÂêà
                    const searchVariants = [];
                    
                    // 1. ÂéüÂßãÁöÑÊ≠åÊâã + Ê≠åÂêçÔºàÂÆåÊï¥Ôºâ
                    if (artist && track) {
                        searchVariants.push({ artist, track, label: 'Ê≠åÊâã+ÂÆåÊï¥Ê≠åÂêç' });
                    }
                    
                    // 2. Âè™Áî®ÂÆåÊï¥Ê≠åÂêç
                    if (track) {
                        searchVariants.push({ artist: '', track, label: 'Âè™Áî®ÂÆåÊï¥Ê≠åÂêç' });
                    }
                    
                    // 3. Ê∏ÖÁêÜÊ≠åÊâãÂêçÔºàÁßªÈô§ MC, DJ Á≠âÂâçÁ∂¥Ôºâ+ ÂÆåÊï¥Ê≠åÂêç
                    if (artist) {
                        const cleanArtist = artist.replace(/^(MC|DJ|Mr\.|Ms\.)\s+/gi, '').trim();
                        if (cleanArtist !== artist && cleanArtist) {
                            searchVariants.push({ artist: cleanArtist, track, label: 'Ê∏ÖÁêÜÂæåÁöÑÊ≠åÊâã+ÂÆåÊï¥Ê≠åÂêç' });
                        }
                    }
                    
                    // 4. ÊèêÂèñÊ≠åÂêç‰∏≠ÁöÑÊâÄÊúâ‰∏≠ÊñáÈÉ®ÂàÜÔºàÂèØËÉΩÊúâÂ§öÂÄã‰∏≠ÊñáË©ûÔºâ
                    const allChineseMatches = track.match(/[\u4e00-\u9fa5]+/g);
                    if (allChineseMatches && allChineseMatches.length > 0) {
                        // 4a. Á¨¨‰∏ÄÂÄã‰∏≠ÊñáË©û
                        const firstChinese = allChineseMatches[0];
                        if (firstChinese !== track) {
                            searchVariants.push({ artist: '', track: firstChinese, label: 'Á¨¨‰∏ÄÂÄã‰∏≠ÊñáË©û' });
                            if (artist) {
                                searchVariants.push({ artist, track: firstChinese, label: 'Ê≠åÊâã+Á¨¨‰∏ÄÂÄã‰∏≠ÊñáË©û' });
                            }
                        }
                        
                        // 4b. ÊâÄÊúâ‰∏≠ÊñáË©ûÁµÑÂêà
                        if (allChineseMatches.length > 1) {
                            const allChinese = allChineseMatches.join('');
                            searchVariants.push({ artist: '', track: allChinese, label: 'ÊâÄÊúâ‰∏≠ÊñáË©ûÁµÑÂêà' });
                        }
                    }
                    
                    // 5. ÊèêÂèñÊ≠åÂêç‰∏≠ÁöÑÊâÄÊúâËã±ÊñáÈÉ®ÂàÜ
                    const allEnglishMatches = track.match(/[A-Za-z]+/g);
                    if (allEnglishMatches && allEnglishMatches.length > 0) {
                        // 5a. ÂÆåÊï¥Ëã±ÊñáÈÉ®ÂàÜÔºà‰øùÁïôÁ©∫Ê†ºÔºâ
                        const englishMatch = track.match(/([A-Za-z\s]+)/);
                        if (englishMatch && englishMatch[1].trim() && englishMatch[1].trim() !== track) {
                            const englishTrack = englishMatch[1].trim();
                            searchVariants.push({ artist: '', track: englishTrack, label: 'ÂÆåÊï¥Ëã±ÊñáÈÉ®ÂàÜ' });
                            if (artist) {
                                searchVariants.push({ artist, track: englishTrack, label: 'Ê≠åÊâã+ÂÆåÊï¥Ëã±ÊñáÈÉ®ÂàÜ' });
                            }
                        }
                        
                        // 5b. Á¨¨‰∏ÄÂÄãËã±ÊñáË©û
                        const firstEnglish = allEnglishMatches[0];
                        if (firstEnglish.length > 2) { // ÈÅøÂÖçÂÉè "a", "of" ÈÄôÁ®ÆÂ§™Áü≠ÁöÑË©û
                            searchVariants.push({ artist: '', track: firstEnglish, label: 'Á¨¨‰∏ÄÂÄãËã±ÊñáË©û' });
                        }
                    }
                    
                    // 6. Ê∏ÖÁêÜÂæåÁöÑÊ≠åÊâã + Âè™Áî®‰∏≠Êñá
                    if (artist && allChineseMatches && allChineseMatches.length > 0) {
                        const cleanArtist = artist.replace(/^(MC|DJ|Mr\.|Ms\.)\s+/gi, '').trim();
                        const firstChinese = allChineseMatches[0];
                        if (cleanArtist !== artist && firstChinese !== track) {
                            searchVariants.push({ artist: cleanArtist, track: firstChinese, label: 'Ê∏ÖÁêÜÂæåÊ≠åÊâã+‰∏≠ÊñáË©û' });
                        }
                    }
                    
                    // ÈÄê‰∏ÄÂòóË©¶ÊâÄÊúâÊêúÂ∞ãËÆäÈ´î
                    let lrcText = null;
                    for (const variant of searchVariants) {
                        console.log(`üîÑ ÂòóË©¶ÊêúÂ∞ã (${variant.label}):`, variant.artist, '-', variant.track);
                        lrcText = await fetchLyricsFromLRCLIB(variant.artist, variant.track);
                        if (lrcText) {
                            console.log(`‚úÖ ÊâæÂà∞Ê≠åË©ûÔºÅ‰ΩøÁî®: ${variant.label}`);
                            break;
                        }
                    }
                    
                    // ÊúÄÂæåÂòóË©¶Ê®°Á≥äÊêúÂ∞ãÔºà‰ΩøÁî®ÂéüÂßãÊ≠åÂêçÔºâ
                    if (!lrcText) {
                        console.log('üîÑ ÂòóË©¶Ê®°Á≥äÊêúÂ∞ã...');
                        lrcText = await fetchLyricsBackup(songName);
                    }
                    
                    if (!lrcText) {
                        console.log('‚ùå No lyrics found');
                        // Êâæ‰∏çÂà∞Ê≠åË©ûÔºåÁ¶ÅÁî®ÊåâÈàï‰∏¶È°ØÁ§∫ÊèêÁ§∫
                        if (toggleBtn) {
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        if (statusText) {
                            statusText.style.display = 'block';
                        }
                        return false;
                    } else {
                        console.log('‚úÖ Lyrics found!');
                        // ÊâæÂà∞Ê≠åË©ûÔºåÂïüÁî®ÊåâÈàï‰∏¶Èö±ËóèÊèêÁ§∫
                        if (toggleBtn) {
                            toggleBtn.disabled = false;
                            toggleBtn.style.opacity = '1';
                            toggleBtn.style.cursor = 'pointer';
                        }
                        if (statusText) {
                            statusText.style.display = 'none';
                        }
                        return true;
                    }
                } catch (error) {
                    console.error('‚ùå Error checking lyrics:', error);
                    const toggleBtn = document.getElementById('toggleLyricsBtn');
                    const statusText = document.getElementById('lyricsStatusText');
                    if (toggleBtn) {
                        toggleBtn.disabled = true;
                        toggleBtn.style.opacity = '0.5';
                        toggleBtn.style.cursor = 'not-allowed';
                    }
                    if (statusText) {
                        statusText.style.display = 'block';
                    }
                    return false;
                }
            }

            // ËºâÂÖ•Ê≠åË©û
            async function loadLyrics(songName) {
                try {
                    console.log('üéµ Loading lyrics for:', songName);
                    
                    const lyricsContainer = document.getElementById('lyricsContainer');
                    const toggleBtn = document.getElementById('toggleLyricsBtn');
                    const statusText = document.getElementById('lyricsStatusText');
                    
                    // ÈáçÁΩÆÊåâÈàïÁãÄÊÖãÂíåÊèêÁ§∫ÊñáÂ≠ó
                    if (toggleBtn) {
                        toggleBtn.disabled = false;
                        toggleBtn.style.opacity = '1';
                        toggleBtn.style.cursor = 'pointer';
                    }
                    if (statusText) {
                        statusText.style.display = 'none';
                    }
                    
                    if (!lyricsContainer) {
                        console.error('‚ùå Lyrics container not found');
                        return;
                    }
                    
                    // È°ØÁ§∫ËºâÂÖ•‰∏≠
                    lyricsContainer.innerHTML = '<div class="lyrics-loading"><span class="loading"></span> Ê≠£Âú®ËºâÂÖ•Ê≠åË©û...</div>';
                    
                    // Ëß£ÊûêÊ≠åÂêç
                    const { artist, track } = parseSongTitle(songName);
                    
                    if (!track) {
                        console.log('‚ùå Cannot parse song title');
                        lyricsEnabled = false;
                        const toggleBtn = document.getElementById('toggleLyricsBtn');
                        if (toggleBtn) {
                            toggleBtn.textContent = 'üé§ È°ØÁ§∫Ê≠åË©û';
                            toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        lyricsContainer.innerHTML = '';
                        return;
                    }
                    
                    // Ê∫ñÂÇôÂ§öÁ®ÆÊêúÂ∞ãÈóúÈçµÂ≠óÁµÑÂêà
                    const searchVariants = [];
                    
                    // 1. ÂéüÂßãÁöÑÊ≠åÊâã + Ê≠åÂêçÔºàÂÆåÊï¥Ôºâ
                    if (artist && track) {
                        searchVariants.push({ artist, track, label: 'Ê≠åÊâã+ÂÆåÊï¥Ê≠åÂêç' });
                    }
                    
                    // 2. Âè™Áî®ÂÆåÊï¥Ê≠åÂêç
                    if (track) {
                        searchVariants.push({ artist: '', track, label: 'Âè™Áî®ÂÆåÊï¥Ê≠åÂêç' });
                    }
                    
                    // 3. Ê∏ÖÁêÜÊ≠åÊâãÂêçÔºàÁßªÈô§ MC, DJ Á≠âÂâçÁ∂¥Ôºâ+ ÂÆåÊï¥Ê≠åÂêç
                    if (artist) {
                        const cleanArtist = artist.replace(/^(MC|DJ|Mr\.|Ms\.)\s+/gi, '').trim();
                        if (cleanArtist !== artist && cleanArtist) {
                            searchVariants.push({ artist: cleanArtist, track, label: 'Ê∏ÖÁêÜÂæåÁöÑÊ≠åÊâã+ÂÆåÊï¥Ê≠åÂêç' });
                        }
                    }
                    
                    // 4. ÊèêÂèñÊ≠åÂêç‰∏≠ÁöÑÊâÄÊúâ‰∏≠ÊñáÈÉ®ÂàÜÔºàÂèØËÉΩÊúâÂ§öÂÄã‰∏≠ÊñáË©ûÔºâ
                    const allChineseMatches = track.match(/[\u4e00-\u9fa5]+/g);
                    if (allChineseMatches && allChineseMatches.length > 0) {
                        // 4a. Á¨¨‰∏ÄÂÄã‰∏≠ÊñáË©û
                        const firstChinese = allChineseMatches[0];
                        if (firstChinese !== track) {
                            searchVariants.push({ artist: '', track: firstChinese, label: 'Á¨¨‰∏ÄÂÄã‰∏≠ÊñáË©û' });
                            if (artist) {
                                searchVariants.push({ artist, track: firstChinese, label: 'Ê≠åÊâã+Á¨¨‰∏ÄÂÄã‰∏≠ÊñáË©û' });
                            }
                        }
                        
                        // 4b. ÊâÄÊúâ‰∏≠ÊñáË©ûÁµÑÂêà
                        if (allChineseMatches.length > 1) {
                            const allChinese = allChineseMatches.join('');
                            searchVariants.push({ artist: '', track: allChinese, label: 'ÊâÄÊúâ‰∏≠ÊñáË©ûÁµÑÂêà' });
                        }
                    }
                    
                    // 5. ÊèêÂèñÊ≠åÂêç‰∏≠ÁöÑÊâÄÊúâËã±ÊñáÈÉ®ÂàÜ
                    const allEnglishMatches = track.match(/[A-Za-z]+/g);
                    if (allEnglishMatches && allEnglishMatches.length > 0) {
                        // 5a. ÂÆåÊï¥Ëã±ÊñáÈÉ®ÂàÜÔºà‰øùÁïôÁ©∫Ê†ºÔºâ
                        const englishMatch = track.match(/([A-Za-z\s]+)/);
                        if (englishMatch && englishMatch[1].trim() && englishMatch[1].trim() !== track) {
                            const englishTrack = englishMatch[1].trim();
                            searchVariants.push({ artist: '', track: englishTrack, label: 'ÂÆåÊï¥Ëã±ÊñáÈÉ®ÂàÜ' });
                            if (artist) {
                                searchVariants.push({ artist, track: englishTrack, label: 'Ê≠åÊâã+ÂÆåÊï¥Ëã±ÊñáÈÉ®ÂàÜ' });
                            }
                        }
                        
                        // 5b. Á¨¨‰∏ÄÂÄãËã±ÊñáË©û
                        const firstEnglish = allEnglishMatches[0];
                        if (firstEnglish.length > 2) { // ÈÅøÂÖçÂÉè "a", "of" ÈÄôÁ®ÆÂ§™Áü≠ÁöÑË©û
                            searchVariants.push({ artist: '', track: firstEnglish, label: 'Á¨¨‰∏ÄÂÄãËã±ÊñáË©û' });
                        }
                    }
                    
                    // 6. Ê∏ÖÁêÜÂæåÁöÑÊ≠åÊâã + Âè™Áî®‰∏≠Êñá
                    if (artist && allChineseMatches && allChineseMatches.length > 0) {
                        const cleanArtist = artist.replace(/^(MC|DJ|Mr\.|Ms\.)\s+/gi, '').trim();
                        const firstChinese = allChineseMatches[0];
                        if (cleanArtist !== artist && firstChinese !== track) {
                            searchVariants.push({ artist: cleanArtist, track: firstChinese, label: 'Ê∏ÖÁêÜÂæåÊ≠åÊâã+‰∏≠ÊñáË©û' });
                        }
                    }
                    
                    // ÈÄê‰∏ÄÂòóË©¶ÊâÄÊúâÊêúÂ∞ãËÆäÈ´î
                    let lrcText = null;
                    for (const variant of searchVariants) {
                        console.log(`üîÑ ÂòóË©¶ÊêúÂ∞ã (${variant.label}):`, variant.artist, '-', variant.track);
                        lrcText = await fetchLyricsFromLRCLIB(variant.artist, variant.track);
                        if (lrcText) {
                            console.log(`‚úÖ ÊâæÂà∞Ê≠åË©ûÔºÅ‰ΩøÁî®: ${variant.label}`);
                            break;
                        }
                    }
                    
                    // ÊúÄÂæåÂòóË©¶Ê®°Á≥äÊêúÂ∞ãÔºà‰ΩøÁî®ÂéüÂßãÊ≠åÂêçÔºâ
                    if (!lrcText) {
                        console.log('üîÑ ÂòóË©¶Ê®°Á≥äÊêúÂ∞ã...');
                        lrcText = await fetchLyricsBackup(songName);
                    }
                    
                    if (!lrcText) {
                        console.log('‚ùå No lyrics found after all attempts');
                        // Êâæ‰∏çÂà∞Ê≠åË©ûÔºåËá™ÂãïÈóúÈñâÊ≠åË©ûÂäüËÉΩ‰∏¶Á¶ÅÁî®ÊåâÈàïÔºå‰∏¶È°ØÁ§∫ÊèêÁ§∫ÊñáÂ≠ó
                        lyricsEnabled = false;
                        const lyricsSection = document.getElementById('lyricsSection');
                        
                        if (lyricsSection) {
                            lyricsSection.classList.remove('show');
                        }
                        if (toggleBtn) {
                            toggleBtn.classList.remove('active');
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        if (statusText) {
                            statusText.style.display = 'block';
                        }
                        lyricsContainer.innerHTML = '';
                        currentLyrics = [];
                        return;
                    }
                    
                    // ÊâæÂà∞Ê≠åË©ûÔºåÈö±ËóèÊèêÁ§∫ÊñáÂ≠ó
                    if (statusText) {
                        statusText.style.display = 'none';
                    }
                    
                    // Ëß£ÊûêÊ≠åË©û
                    currentLyrics = parseLRC(lrcText);
                    
                    if (currentLyrics.length === 0) {
                        // Â¶ÇÊûúÊòØÁ¥îÊñáÂ≠óÊ≠åË©ûÔºàÊ≤íÊúâÊôÇÈñìËª∏Ôºâ
                        lyricsContainer.innerHTML = `<div class="lyrics-line active">${lrcText.replace(/\n/g, '<br>')}</div>`;
                        return;
                    }
                    
                    // Ê™¢Êü•Á¨¨‰∏ÄÂè•Ê≠åË©ûÊôÇÈñìÊòØÂê¶Ë∂ÖÈÅé 10 ÁßíÔºåÂ¶ÇÊûúÊòØÔºåÊèíÂÖ•ÂÄíÊï∏ÊèêÈÜí
                    if (currentLyrics.length > 0 && currentLyrics[0].time > 10) {
                        const firstLyricTime = currentLyrics[0].time;
                        // ÂÄíÊï∏ÈªûÂú®Á¨¨‰∏ÄÂè•Ê≠åË©ûÂâç 2.7 ÁßíÂá∫ÁèæÔºàÂØ¶ÈöõÈ°ØÁ§∫ÊôÇÊúÉÊèêÊó© 0.5 ÁßíÔºåÊâÄ‰ª•Á∏ΩÂÖ±ÊèêÊó© 3.2 ÁßíÔºâ
                        const countdownTime = firstLyricTime - 2.7;
                        const countdownLyric = {
                            time: countdownTime,
                            text: '‚óè‚óè‚óè',
                            isCountdown: true  // Ê®ôË®òÈÄôÊòØÂÄíÊï∏ÊèêÈÜí
                        };
                        // ÊèíÂÖ•Âà∞Á¨¨‰∏ÄÂè•Ê≠åË©û‰πãÂâç
                        currentLyrics.unshift(countdownLyric);
                        
                        // Á¨¨‰∏ÄÂè•Ê≠åË©ûÊôÇÈñì‰∏çËÆäÔºå‰øùÊåÅÂéüÊú¨ÊôÇÈñì
                        // ÈÄôÊ®£ÂÄíÊï∏ÈªûÊúÉÂú® firstLyricTime - 2.7 È°ØÁ§∫
                        // Á¨¨‰∏ÄÂè•Ê≠åË©ûÊúÉÂú® firstLyricTime È°ØÁ§∫
                        // ÂÆÉÂÄë‰∏çÊúÉÂêåÊôÇÈ°ØÁ§∫ÔºåËÄåÊòØÂÄíÊï∏ÈªûÂÖàÂá∫Áèæ2.7ÁßíÔºåÁÑ∂ÂæåÁ¨¨‰∏ÄÂè•Ê≠åË©ûÂá∫Áèæ
                        
                        console.log('‚úÖ ÊèíÂÖ•ÂÄíÊï∏ÊèêÈÜíÊ≠åË©ûÔºåÊôÇÈñì:', countdownTime);
                        console.log('‚úÖ Á¨¨‰∏ÄÂè•Ê≠åË©ûÊôÇÈñì:', currentLyrics[1].time);
                    }
                    
                    // È°ØÁ§∫Ê≠åË©û
                    displayLyrics();
                    
                    // ÈñãÂßãÂêåÊ≠•Êõ¥Êñ∞
                    startLyricsSync();
                } catch (error) {
                    console.error('‚ùå Error loading lyrics:', error);
                    const lyricsContainer = document.getElementById('lyricsContainer');
                    if (lyricsContainer) {
                        lyricsEnabled = false;
                        if (toggleBtn) {
                            toggleBtn.classList.remove('active');
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        lyricsContainer.innerHTML = '';
                    }
                }
            }

            // È°ØÁ§∫Ê≠åË©û
            function displayLyrics() {
                const lyricsContainer = document.getElementById('lyricsContainer');
                
                if (currentLyrics.length === 0) {
                    lyricsContainer.innerHTML = '';
                    return;
                }
                
                // È°ØÁ§∫Ê≠åË©û - ÂÄíÊï∏ÈªûÂíåÁ¨¨‰∏ÄÂè•Ê≠åË©ûÂàÜÈñã‰ΩÜË¶ñË¶∫‰∏äÁµÑÂêà
                let html = '';
                let hasCountdown = false;
                let countdownIndex = -1;
                let firstLyricIndex = -1;
                
                // ÊâæÂà∞ÂÄíÊï∏ÂíåÁ¨¨‰∏ÄÂè•Ê≠åË©ûÁöÑÁ¥¢Âºï
                currentLyrics.forEach((line, index) => {
                    if (line.isCountdown) {
                        hasCountdown = true;
                        countdownIndex = index;
                    } else if (firstLyricIndex === -1) {
                        firstLyricIndex = index;
                    }
                });
                
                // ÁîüÊàê HTML
                currentLyrics.forEach((line, index) => {
                    if (line.isCountdown) {
                        // ÂÄíÊï∏ÈªûÂñÆÁç®‰∏ÄË°å
                        html += `<div class="lyrics-line lyrics-countdown" data-index="${index}" data-time="${line.time}">
                            <span class="countdown-dot dot-1">‚óè</span>
                            <span class="countdown-dot dot-2">‚óè</span>
                            <span class="countdown-dot dot-3">‚óè</span>
                        </div>`;
                        console.log('üîµ Generated countdown HTML at index:', index, 'time:', line.time);
                    } else if (hasCountdown && index === firstLyricIndex) {
                        // Á¨¨‰∏ÄÂè•Ê≠åË©ûÔºàÊúâÂÄíÊï∏ÊôÇÊ∑ªÂä†ÁâπÊÆä classÔºâ
                        html += `<div class="lyrics-line first-lyric-with-countdown" data-index="${index}" data-time="${line.time}">${line.text}</div>`;
                        console.log('üîµ Generated first lyric HTML at index:', index, 'time:', line.time);
                    } else {
                        // ÂÖ∂‰ªñÊ≠åË©û
                        html += `<div class="lyrics-line" data-index="${index}" data-time="${line.time}">${line.text}</div>`;
                    }
                });
                
                lyricsContainer.innerHTML = html;
            }

            // ÈñãÂßãÊ≠åË©ûÂêåÊ≠•
            function startLyricsSync() {
                // Ê∏ÖÈô§ËàäÁöÑÂÆöÊôÇÂô®
                if (lyricsUpdateInterval) {
                    clearInterval(lyricsUpdateInterval);
                }
                
                // ÊØè 100ms Êõ¥Êñ∞‰∏ÄÊ¨°Ê≠åË©ûÈ´ò‰∫Æ
                lyricsUpdateInterval = setInterval(updateLyricsHighlight, 100);
                console.log('üé§ Lyrics sync started');
            }

            // ÂÅúÊ≠¢Ê≠åË©ûÂêåÊ≠•
            function stopLyricsSync() {
                if (lyricsUpdateInterval) {
                    clearInterval(lyricsUpdateInterval);
                    lyricsUpdateInterval = null;
                }
                console.log('‚è∏Ô∏è Lyrics sync stopped');
            }

            // Êõ¥Êñ∞Ê≠åË©ûÈ´ò‰∫Æ
            function updateLyricsHighlight() {
                if (!player || !player.getCurrentTime || currentLyrics.length === 0) {
                    return;
                }
                
                const currentTime = player.getCurrentTime();
                const ADVANCE_TIME = 0.5; // Ê≠åË©ûÊèêÊó© 0.5 ÁßíÈ°ØÁ§∫
                const adjustedTime = currentTime + ADVANCE_TIME;
                
                // ÊâæÂà∞Áï∂ÂâçÊáâË©≤È´ò‰∫ÆÁöÑÊ≠åË©ûÁ¥¢ÂºïÔºà‰ΩøÁî®ÊèêÊó©ÁöÑÊôÇÈñìÔºâ
                // ÂæûÂâçÂæÄÂæåÊâæÁ¨¨‰∏ÄÂÄãÊôÇÈñìÂ∑≤Âà∞ÁöÑÊ≠åË©û
                let newIndex = -1;
                for (let i = currentLyrics.length - 1; i >= 0; i--) {
                    if (adjustedTime >= currentLyrics[i].time) {
                        newIndex = i;
                        break;
                    }
                }
                
                // ÁâπÊÆäËôïÁêÜÔºöÂ¶ÇÊûúÊòØÂÄíÊï∏ÈªûÔºàindex 0ÔºâÔºåÊ™¢Êü•ÊòØÂê¶ÊáâË©≤ÂêåÊôÇÈ°ØÁ§∫Á¨¨‰∏ÄÂè•Ê≠åË©û
                if (newIndex === 0 && currentLyrics[0].isCountdown && currentLyrics.length > 1) {
                    // Â¶ÇÊûúÁ¨¨‰∏ÄÂè•Ê≠åË©ûÁöÑÊôÇÈñì‰πüÂà∞‰∫ÜÔºåÂÑ™ÂÖàÈ°ØÁ§∫ÂÄíÊï∏Èªû
                    // ÔºàÂÄíÊï∏ÈªûÊúÉÊØîÁ¨¨‰∏ÄÂè•Ê≠åË©ûÊó©0.01ÁßíÔºåÊâÄ‰ª•ÂÄíÊï∏ÈªûÊúÉÂÖàË¢´ÂåπÈÖçÂà∞Ôºâ
                }
                
                // Debug: ÊØèÊ¨°Êõ¥Êñ∞ÈÉΩÈ°ØÁ§∫ÔºàÂè™Âú®Ââç 15 ÁßíÔºâ
                if (currentTime < 15) {
                    console.log('üïê Update - Time:', currentTime.toFixed(2), 'Adjusted:', adjustedTime.toFixed(2), 'newIndex:', newIndex, 'currentIndex:', currentLyricsIndex, 'First lyric time:', currentLyrics[0]?.time.toFixed(2));
                }
                
                // Â¶ÇÊûúÁ¥¢ÂºïÊ≤íËÆäÔºå‰∏çÈúÄË¶ÅÊõ¥Êñ∞
                if (newIndex === currentLyricsIndex) {
                    return;
                }
                
                currentLyricsIndex = newIndex;
                
                console.log('üìç Index changed to:', newIndex, 'Is countdown?', currentLyrics[newIndex]?.isCountdown);
                
                // Êõ¥Êñ∞ÊâÄÊúâÊ≠åË©ûË°åÁöÑÊ®£Âºè
                const lyricsLines = document.querySelectorAll('.lyrics-line');
                console.log('üìù Total lyrics lines in DOM:', lyricsLines.length);
                
                lyricsLines.forEach((line, index) => {
                    line.classList.remove('active', 'past', 'future');
                    
                    if (index === currentLyricsIndex) {
                        line.classList.add('active');
                        if (line.classList.contains('lyrics-countdown')) {
                            console.log('üü¢ Countdown active at index:', index);
                        }
                        // ÂÄíÊï∏ÈªûÁöÑÂãïÁï´Áî± CSS Ëá™ÂãïËôïÁêÜÔºå‰∏çÈúÄË¶Å JavaScript
                    } else if (index === currentLyricsIndex + 1 && line.classList.contains('first-lyric-with-countdown')) {
                        // Â¶ÇÊûúÁï∂ÂâçÊòØÂÄíÊï∏ÈªûÔºåÂêåÊôÇÈ°ØÁ§∫Á¨¨‰∏ÄÂè•Ê≠åË©û
                        line.classList.add('active');
                        console.log('üü¢ First lyric also active at index:', index);
                    } else if (index < currentLyricsIndex) {
                        line.classList.add('past');
                    } else {
                        line.classList.add('future');
                    }
                });
            }

            // Ê∏ÖÈô§Ê≠åË©û
            function clearLyrics() {
                stopLyricsSync();
                currentLyrics = [];
                currentLyricsIndex = -1;
                const lyricsContainer = document.getElementById('lyricsContainer');
                if (lyricsContainer) {
                    lyricsContainer.innerHTML = '';
                }
            }

            // ========================================
            // YouTube Áõ∏ÈóúÂáΩÊï∏
            // ========================================

            // Âæû YouTube API Áç≤ÂèñÂΩ±ÁâáÊ®ôÈ°å
            async function getVideoTitle(videoId) {
                console.log('üéµ Fetching title for video ID:', videoId);
                
                // È©óË≠â Video ID
                if (!videoId || videoId.length !== 11) {
                    console.error('‚ùå Invalid video ID:', videoId);
                    return `YouTube ÂΩ±Áâá (ÁÑ°Êïà ID)`;
                }
                
                // ÊñπÊ≥ï 1: ‰ΩøÁî® YouTube Data API v3ÔºàÊúÄÂèØÈù†Ôºâ
                if (YOUTUBE_API_KEY && YOUTUBE_API_KEY !== "YOUR-API-KEY") {
                    try {
                        // ‰ΩøÁî® snippet ÈÉ®ÂàÜÁç≤ÂèñÊ®ôÈ°å
                        const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`;
                        console.log('üîç Trying YouTube API v3...');
                        console.log('üì° API URL:', apiUrl);
                        
                        const response = await fetch(apiUrl);
                        console.log('üì• API Response status:', response.status);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('üì¶ API Response data:', data);
                            
                            if (data.items && data.items.length > 0) {
                                const title = data.items[0].snippet.title;
                                console.log('‚úÖ Successfully fetched from YouTube API:', title);
                                return title;
                            } else {
                                console.warn('‚ö†Ô∏è No items found in API response');
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('‚ùå YouTube API error:', response.status, errorText);
                        }
                    } catch (error) {
                        console.error('‚ùå YouTube API failed:', error.message);
                        console.error('Error details:', error);
                    }
                }
                
                // ÊñπÊ≥ï 2: ‰ΩøÁî® oEmbed APIÔºàÂÇôÁî®Ôºâ
                try {
                    const oembedUrl = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`;
                    console.log('üîç Trying oEmbed API...');
                    const response = await fetch(oembedUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.title) {
                            console.log('‚úÖ Successfully fetched from oEmbed:', data.title);
                            return data.title;
                        }
                    }
                } catch (error) {
                    console.error('‚ùå oEmbed API failed:', error.message);
                }
                
                // ÊñπÊ≥ï 3: ‰ΩøÁî® noembed.comÔºàÁ¨¨‰∫åÂÇôÁî®Ôºâ
                try {
                    const noembedUrl = `https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`;
                    console.log('üîç Trying noembed.com...');
                    const response = await fetch(noembedUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.title) {
                            console.log('‚úÖ Successfully fetched from noembed:', data.title);
                            return data.title;
                        }
                    }
                } catch (error) {
                    console.error('‚ùå noembed failed:', error.message);
                }
                
                // ÊâÄÊúâÊñπÊ≥ïÈÉΩÂ§±ÊïóÔºåËøîÂõûÈ†êË®≠ÂêçÁ®±
                console.warn('‚ö†Ô∏è All methods failed, using default name');
                return `YouTube ÂΩ±Áâá (${videoId})`;
            }

            // YouTube IFrame API Ê∫ñÂÇôÂ∞±Á∑íÊôÇÁöÑÂõûË™ø
            function onYouTubeIframeAPIReady() {
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1,
                        'rel': 0,              // ÈóúÈñâÁõ∏ÈóúÂΩ±ÁâáÊé®Ëñ¶
                        'showinfo': 0,         // ÈóúÈñâÂΩ±ÁâáË≥áË®ä
                        'modestbranding': 1,   // Á∞°Âåñ YouTube Logo
                        'cc_load_policy': 0,   // È†êË®≠ÈóúÈñâÂ≠óÂπï
                        'iv_load_policy': 3,   // ÈóúÈñâÂΩ±ÁâáË®ªËß£
                        'fs': 1,               // ÂÖÅË®±ÂÖ®Ëû¢Âπï
                        'disablekb': 0,        // ÂÖÅË®±ÈçµÁõ§ÊéßÂà∂
                        'playsinline': 1       // Ë°åÂãïË£ùÁΩÆÂÖßÂµåÊí≠Êîæ
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }

            function onPlayerReady(event) {
                console.log('Player ready');
                
                // Âº∑Âà∂ÈóúÈñâÂ≠óÂπï
                try {
                    if (player && player.unloadModule) {
                        player.unloadModule('captions');
                        player.unloadModule('cc');
                        console.log('YouTube captions disabled');
                    }
                } catch (error) {
                    console.log('Could not unload captions:', error);
                }
                
                updateUI();
                
                // Â¶ÇÊûúÊúâÁï∂ÂâçÊ≠åÊõ≤ÔºåËºâÂÖ•ÂÆÉ
                if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                    const currentSong = queue[currentSongIndex];
                    const videoId = extractVideoId(currentSong.url);
                    if (videoId) {
                        player.loadVideoById(videoId);
                    }
                }
            }

            function onPlayerStateChange(event) {
                // Áï∂ÂΩ±ÁâáÁµêÊùüÊôÇËá™ÂãïÊí≠Êîæ‰∏ã‰∏ÄÈ¶ñ
                if (event.data === YT.PlayerState.ENDED) {
                    playNext();
                    stopLyricsSync();
                }
                
                // Êõ¥Êñ∞Êí≠ÊîæÁãÄÊÖã
                if (event.data === YT.PlayerState.PLAYING) {
                    isPlaying = true;
                    updatePlayPauseButton();
                    // ÈñãÂßãÊ≠åË©ûÂêåÊ≠•
                    if (currentLyrics.length > 0) {
                        startLyricsSync();
                    }
                } else if (event.data === YT.PlayerState.PAUSED) {
                    isPlaying = false;
                    updatePlayPauseButton();
                    // Êö´ÂÅúÊ≠åË©ûÂêåÊ≠•
                    stopLyricsSync();
                }
            }

            // Êõ¥Êñ∞ UI
            function updateUI() {
                updateCurrentSong();
                updateNextSong();
                updateQueue();
                updateAllSongs();
                updateHistory();
                updateControlPanel();
            }

            // Êõ¥Êñ∞Áï∂ÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤È°ØÁ§∫
            function updateCurrentSong() {
                const currentSongDiv = document.getElementById('currentSong');
                const controlCurrentSong = document.getElementById('controlCurrentSong');
                const controlThumbnail = document.getElementById('controlThumbnail');
                
                if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                    const song = queue[currentSongIndex];
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    currentSongDiv.innerHTML = `
                        <div class="song-info" style="display: flex; align-items: center; gap: 20px;">
                            ${thumbnailUrl ? `
                                <div class="current-song-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}">
                                </div>
                            ` : ''}
                            <h3 style="font-size: 1.5em; flex: 1;">${song.songName}</h3>
                        </div>
                    `;
                    
                    // Êõ¥Êñ∞ÊéßÂà∂Èù¢Êùø‰∏≠ÁöÑÊ≠£Âú®Êí≠Êîæ
                    if (controlCurrentSong) {
                        controlCurrentSong.textContent = song.songName;
                    }
                    
                    // Êõ¥Êñ∞ÊéßÂà∂Èù¢Êùø‰∏≠ÁöÑÁ∏ÆÂúñ
                    if (controlThumbnail) {
                        if (thumbnailUrl) {
                            controlThumbnail.innerHTML = `
                                <img src="${thumbnailUrl}" alt="${song.songName}" 
                                     style="width: 140px; height: 105px; border-radius: 12px; object-fit: cover; border: 2px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);">
                            `;
                        } else {
                            controlThumbnail.innerHTML = `
                                <div style="width: 140px; height: 105px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                                    ÁÑ°Á∏ÆÂúñ
                                </div>
                            `;
                        }
                    }
                } else {
                    currentSongDiv.innerHTML = '<div class="no-song">ÁõÆÂâçÊ≤íÊúâÊ≠åÊõ≤Êí≠Êîæ</div>';
                    
                    // Êõ¥Êñ∞ÊéßÂà∂Èù¢Êùø‰∏≠ÁöÑÊ≠£Âú®Êí≠Êîæ
                    if (controlCurrentSong) {
                        controlCurrentSong.textContent = 'ÁÑ°';
                    }
                    
                    // Êõ¥Êñ∞ÊéßÂà∂Èù¢Êùø‰∏≠ÁöÑÁ∏ÆÂúñ
                    if (controlThumbnail) {
                        controlThumbnail.innerHTML = `
                            <div style="width: 140px; height: 105px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                                ÁÑ°Á∏ÆÂúñ
                            </div>
                        `;
                    }
                }
            }

            // Êõ¥Êñ∞‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤È°ØÁ§∫
            function updateNextSong() {
                const nextSongDisplay = document.getElementById('nextSongDisplay');
                
                // Ë®àÁÆó‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤ÔºàÊúÄÂ§öÈ°ØÁ§∫3È¶ñÔºâ
                const nextSongs = queue.slice(currentSongIndex + 1, currentSongIndex + 4);
                
                if (nextSongs.length === 0) {
                    nextSongDisplay.innerHTML = '<div class="empty-queue">Ê≤íÊúâ‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤</div>';
                    return;
                }
                
                nextSongDisplay.innerHTML = nextSongs.map((song, index) => {
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    return `
                        <div class="queue-item">
                            <span class="queue-item-number">${index + 1}</span>
                            ${thumbnailUrl ? `
                                <div class="queue-item-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}" draggable="false">
                                </div>
                            ` : ''}
                            <div class="queue-item-info">
                                <h4>${song.songName}</h4>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Êõ¥Êñ∞ÊéíÈöäÂàóË°®
            function updateQueue() {
                const queueList = document.getElementById('queueList');
                const queueCount = document.getElementById('queueCount');
                
                // Ë®àÁÆóÊéíÈöä‰∏≠ÁöÑÊ≠åÊõ≤Êï∏ÈáèÔºà‰∏çÂåÖÊã¨Áï∂ÂâçÊí≠ÊîæÁöÑÔºâ
                const waitingQueue = queue.slice(currentSongIndex + 1);
                queueCount.textContent = waitingQueue.length;
                
                if (waitingQueue.length === 0) {
                    queueList.innerHTML = '<div class="empty-queue">ÁõÆÂâçÊ≤íÊúâÊéíÈöäÁöÑÊ≠åÊõ≤</div>';
                    return;
                }
                
                queueList.innerHTML = waitingQueue.map((song, index) => {
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    const actualIndex = currentSongIndex + 1 + index;
                    
                    return `
                        <div class="queue-item" data-index="${actualIndex}">
                            <span class="queue-item-drag-handle">‚ò∞</span>
                            <span class="queue-item-number">${index + 1}</span>
                            ${thumbnailUrl ? `
                                <div class="queue-item-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}" draggable="false">
                                </div>
                            ` : ''}
                            <div class="queue-item-info">
                                <h4>${song.songName}</h4>
                            </div>
                            <div class="queue-item-actions">
                                <button onclick="event.stopPropagation(); removeSong(${actualIndex})">Âà™Èô§</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // ÂàùÂßãÂåñ SortableJS
                setupSortable();
            }

            // Ë®≠ÁΩÆ SortableJS
            let sortableInstance = null;
            function setupSortable() {
                const queueList = document.getElementById('queueList');
                
                // Èä∑ÊØÄËàäÁöÑÂØ¶‰æã
                if (sortableInstance) {
                    sortableInstance.destroy();
                }
                
                // ÂâµÂª∫Êñ∞ÁöÑ Sortable ÂØ¶‰æã
                sortableInstance = Sortable.create(queueList, {
                    animation: 200,
                    easing: "cubic-bezier(1, 0, 0, 1)",
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    forceFallback: true,
                    fallbackTolerance: 3,
                    touchStartThreshold: 5,
                    delay: 50,
                    delayOnTouchOnly: true,
                    onEnd: async function(evt) {
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;
                        
                        if (oldIndex !== newIndex) {
                            // Ë®àÁÆóÂØ¶ÈöõÂú® queue ‰∏≠ÁöÑÁ¥¢Âºï
                            const actualOldIndex = currentSongIndex + 1 + oldIndex;
                            const actualNewIndex = currentSongIndex + 1 + newIndex;
                            
                            // ÁßªÂãïÊ≠åÊõ≤
                            const movedSong = queue.splice(actualOldIndex, 1)[0];
                            queue.splice(actualNewIndex, 0, movedSong);
                            
                            // ‰øùÂ≠òÂà∞ Firebase
                            await saveToFirebase();
                            
                            // Á´ãÂç≥Êõ¥Êñ∞ UI
                            updateUI();
                        }
                    }
                });
            }

            // Êõ¥Êñ∞ÊâÄÊúâÊ≠åÊõ≤ÂàóË°®
            function updateAllSongs() {
                const allSongsList = document.getElementById('allSongsList');
                const allSongsCount = document.getElementById('allSongsCount');
                
                allSongsCount.textContent = queue.length;
                
                if (queue.length === 0) {
                    allSongsList.innerHTML = '<div class="empty-queue">ÁõÆÂâçÊ≤íÊúâÊ≠åÊõ≤</div>';
                    return;
                }
                
                allSongsList.innerHTML = queue.map((song, index) => {
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    // Âà§Êñ∑ÁãÄÊÖã
                    let statusClass = '';
                    let statusText = '';
                    if (index < currentSongIndex) {
                        statusClass = 'completed';
                        statusText = '‚úì Â∑≤Êí≠Êîæ';
                    } else if (index === currentSongIndex) {
                        statusClass = 'playing';
                        statusText = '‚ñ∂ Êí≠Êîæ‰∏≠';
                    } else {
                        statusText = '‚è≥ Á≠âÂæÖ‰∏≠';
                    }
                    
                    return `
                        <div class="queue-item ${statusClass}">
                            <span class="queue-item-number">${index + 1}</span>
                            ${thumbnailUrl ? `
                                <div class="queue-item-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}" draggable="false">
                                </div>
                            ` : ''}
                            <div class="queue-item-info">
                                <h4>${song.songName}</h4>
                                <p style="font-size: 0.85em; color: #666;">${statusText}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Êõ¥Êñ∞Ê≠∑Âè≤Ë®òÈåÑ
            function updateHistory() {
                const historyList = document.getElementById('historyList');
                const historyCount = document.getElementById('historyCount');
                
                historyCount.textContent = history.length;
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="empty-queue">ÁõÆÂâçÊ≤íÊúâÊ≠∑Âè≤Ë®òÈåÑ</div>';
                    return;
                }
                
                // ÂÄíÂ∫èÈ°ØÁ§∫ÔºàÊúÄÊñ∞ÁöÑÂú®‰∏äÈù¢Ôºâ
                const reversedHistory = [...history].reverse();
                
                historyList.innerHTML = reversedHistory.map((song, index) => {
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    // Ê™¢Êü•ÈÄôÈ¶ñÊ≠åÊòØÂê¶Â∑≤Á∂ìÂú®ÊéíÈöäÂàóË°®‰∏≠
                    const isInQueue = queue.some(queueSong => extractVideoId(queueSong.url) === videoId);
                    
                    // Ê†πÊìöÊòØÂê¶Â∑≤Â≠òÂú®Ë®≠ÁΩÆÊåâÈàïÁãÄÊÖã
                    let buttonHTML;
                    if (isInQueue) {
                        buttonHTML = `<button id="historyBtn-${index}" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); cursor: not-allowed;" disabled>‚ö†Ô∏è Â∑≤Â≠òÂú®</button>`;
                    } else {
                        buttonHTML = `<button id="historyBtn-${index}" onclick="readdSong('${song.url.replace(/'/g, "\\'")}', '${song.songName.replace(/'/g, "\\'")}', 'historyBtn-${index}')">‚ûï ÈáçÊñ∞Âä†ÂÖ•</button>`;
                    }
                    
                    return `
                        <div class="queue-item">
                            ${thumbnailUrl ? `
                                <div class="queue-item-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}" draggable="false">
                                </div>
                            ` : ''}
                            <div class="queue-item-info">
                                <h4>${song.songName}</h4>
                            </div>
                            <div class="queue-item-actions">
                                ${buttonHTML}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Êõ¥Êñ∞ÊéßÂà∂Èù¢Êùø
            function updateControlPanel() {
                const controlCurrentSong = document.getElementById('controlCurrentSong');
                const controlThumbnail = document.getElementById('controlThumbnail');
                
                if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                    const song = queue[currentSongIndex];
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    controlCurrentSong.textContent = song.songName;
                    
                    if (thumbnailUrl) {
                        controlThumbnail.innerHTML = `
                            <div class="control-panel-thumbnail">
                                <img src="${thumbnailUrl}" alt="${song.songName}">
                            </div>
                        `;
                    } else {
                        controlThumbnail.innerHTML = `
                            <div class="control-panel-thumbnail" style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                                ÁÑ°Á∏ÆÂúñ
                            </div>
                        `;
                    }
                } else {
                    controlCurrentSong.textContent = 'ÁÑ°';
                    controlThumbnail.innerHTML = `
                        <div class="control-panel-thumbnail" style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                            ÁÑ°Á∏ÆÂúñ
                        </div>
                    `;
                }
                
                // Êõ¥Êñ∞Êí≠Êîæ/Êö´ÂÅúÊåâÈàïÁãÄÊÖã
                updatePlayPauseButton();
            }

            // Ê∑ªÂä†Ê≠åÊõ≤
            async function addSong(songData, fromSearch = false, fromHistory = false) {
                queue.push(songData);
                
                // Ê∑ªÂä†Âà∞Ê≠∑Âè≤Ë®òÈåÑ
                addToHistory(songData);
                
                // Â¶ÇÊûúÈÄôÊòØÁ¨¨‰∏ÄÈ¶ñÊ≠åÔºåË®≠ÁΩÆÁï∂ÂâçÁ¥¢Âºï‰∏¶Ëá™ÂãïÊí≠Êîæ
                const isFirstSong = queue.length === 1 && currentSongIndex === -1;
                if (isFirstSong) {
                    currentSongIndex = 0;
                }
                
                // Á≠âÂæÖ Firebase ‰øùÂ≠òÂÆåÊàê
                await saveToFirebase();
                
                // Â¶ÇÊûúÊòØÂæûÊ≠∑Âè≤Ë®òÈåÑÂä†ÂÖ•ÔºåÂè™Êõ¥Êñ∞Êï∏Â≠óÔºå‰∏çÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                if (fromHistory) {
                    // Âè™Êõ¥Êñ∞ÊéíÈöäÊï∏Â≠ó
                    const queueCount = document.getElementById('queueCount');
                    if (queueCount) {
                        queueCount.textContent = Math.max(0, queue.length - currentSongIndex - 1);
                    }
                    const allSongsCount = document.getElementById('allSongsCount');
                    if (allSongsCount) {
                        allSongsCount.textContent = queue.length;
                    }
                    // Êõ¥Êñ∞ÊéíÈöäÂàóË°®ÂíåÁï∂ÂâçÊí≠Êîæ
                    updateCurrentSong();
                    updateNextSong();
                    updateQueue();
                    updateAllSongs();
                    updateControlPanel();
                } else {
                    // ÂÖ∂‰ªñÊÉÖÊ≥ÅÊ≠£Â∏∏Êõ¥Êñ∞Êï¥ÂÄã UI
                    updateUI();
                }
                
                // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÈ¶ñÊ≠åÔºåÈñãÂßãÊí≠Êîæ
                if (isFirstSong) {
                    // Âª∂ÈÅ≤‰∏Ä‰∏ãÁ¢∫‰øù UI Êõ¥Êñ∞ÂÆåÊàê
                    setTimeout(() => {
                        playSong(0);
                    }, 500);
                }
            }

            // ÂæûÊ≠∑Âè≤Ë®òÈåÑÈáçÊñ∞Âä†ÂÖ•
            async function readdSong(url, songName, buttonId) {
                const button = document.getElementById(buttonId);
                
                // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÂú®ÈöäÂàó‰∏≠
                const videoId = extractVideoId(url);
                const isDuplicate = queue.some(song => extractVideoId(song.url) === videoId);
                
                if (isDuplicate) {
                    // Ë¶ñË¶∫ÂèçÈ•ãÔºöÂ∑≤Â≠òÂú®ÔºàÊ∞∏‰πÖ‰øùÊåÅÔºâ
                    button.innerHTML = '‚ö†Ô∏è Â∑≤Â≠òÂú®';
                    button.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    button.style.cursor = 'not-allowed';
                    button.disabled = true;
                    return;
                }
                
                // ÂÖàÊõ¥Êñ∞ÊåâÈàïÁãÄÊÖãÔºàÂú® UI ÈáçÊñ∞Ê∏≤Êüì‰πãÂâçÔºâ
                button.classList.add('added');
                button.innerHTML = '‚úì Â∑≤Âä†ÂÖ•';
                button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                button.disabled = true;
                
                // ÁÑ∂ÂæåÊâçÂä†ÂÖ•Ê≠åÊõ≤Ôºà‰∏çÊúÉÈáçÊñ∞Ê∏≤ÊüìÊ≠∑Âè≤Ë®òÈåÑÔºâ
                await addSong({
                    songName: songName,
                    url: url,
                    addedAt: new Date().toISOString()
                }, false, true); // fromSearch = false, fromHistory = true
                
                // ‰øùÊåÅÂãïÁï´ÊïàÊûú 2 ÁßíÂæåÁßªÈô§ classÔºà‰ΩÜÊåâÈàï‰øùÊåÅÁ∂†Ëâ≤ÂíåÂ∑≤Âä†ÂÖ•ÁãÄÊÖãÔºâ
                setTimeout(() => {
                    button.classList.remove('added');
                }, 2000);
            }

            // Êí≠ÊîæÊåáÂÆöÊ≠åÊõ≤
            async function playSong(index) {
                if (index < 0 || index >= queue.length) {
                    console.log('Invalid song index:', index);
                    return;
                }
                
                currentSongIndex = index;
                const song = queue[index];
                const videoId = extractVideoId(song.url);
                
                console.log('Playing song:', song.songName, 'videoId:', videoId);
                
                if (!videoId) {
                    console.error('Invalid video ID');
                    return;
                }
                
                if (!player) {
                    console.error('Player not ready');
                    return;
                }
                
                // È°ØÁ§∫ÂÄíÊï∏ÊèêÈÜí 3...2...1...
                // showCountdown(); // Â∑≤ÁßªÈô§ÂÖ•Ê≠åÂÄíÊï∏ÊèêÈÜí
                
                // Ê∏ÖÈô§ËàäÊ≠åË©û
                clearLyrics();
                
                // ÈáçÁΩÆÊ≠åË©ûÊåâÈàïÁãÄÊÖãÔºàÊØèÊ¨°ÂàáÊ≠åÈÉΩÈáçÁΩÆÔºâ
                const toggleBtn = document.getElementById('toggleLyricsBtn');
                const statusText = document.getElementById('lyricsStatusText');
                if (toggleBtn) {
                    toggleBtn.disabled = false;
                    toggleBtn.style.opacity = '1';
                    toggleBtn.style.cursor = 'pointer';
                }
                if (statusText) {
                    statusText.style.display = 'none';
                }
                
                // ÊèêÂâçÊ™¢Êü•Ê≠åË©ûÊòØÂê¶ÂèØÁî®ÔºàÈùúÈªòÊ™¢Êü•Ôºâ
                setTimeout(() => {
                    checkLyricsAvailability(song.songName).catch(err => {
                        console.error('Ê™¢Êü•Ê≠åË©ûÂ§±Êïó:', err);
                    });
                }, 100);
                
                // ËºâÂÖ•ÂΩ±Áâá
                try {
                    // Ê†πÊìöËá™ÂãïÊí≠ÊîæË®≠ÂÆö‰ΩøÁî®‰∏çÂêåÁöÑÊñπÊ≥ï
                    if (autoplayEnabled) {
                        console.log('üé¨ Ëá™ÂãïÊí≠ÊîæÂ∑≤ÈñãÂïüÔºå‰ΩøÁî® loadVideoById');
                        player.loadVideoById(videoId); // ËºâÂÖ•‰∏¶Ëá™ÂãïÊí≠Êîæ
                    } else {
                        console.log('‚è∏Ô∏è Ëá™ÂãïÊí≠ÊîæÂ∑≤ÈóúÈñâÔºå‰ΩøÁî® cueVideoById');
                        player.cueVideoById(videoId); // ËºâÂÖ•‰ΩÜ‰∏çËá™ÂãïÊí≠Êîæ
                    }
                    
                    // Âº∑Âà∂ÈóúÈñâÂ≠óÂπï
                    setTimeout(() => {
                        try {
                            if (player.unloadModule) {
                                player.unloadModule('captions');
                                player.unloadModule('cc');
                            }
                        } catch (error) {
                            console.log('Could not unload captions on play:', error);
                        }
                    }, 500);
                    
                    console.log('Video loaded');
                } catch (error) {
                    console.error('Error playing video:', error);
                }
                
                // Âú®ÂæåÂè∞ËºâÂÖ•Ê≠åË©ûÔºàÂ¶ÇÊûúÂ∑≤ÈñãÂïüÔºâ
                if (lyricsEnabled) {
                    setTimeout(() => {
                        loadLyrics(song.songName).catch(err => {
                            console.error('ËºâÂÖ•Ê≠åË©ûÂ§±Êïó:', err);
                        });
                    }, 100);
                }
                
                await saveToFirebase();
                
                // Êõ¥Êñ∞ UI È°ØÁ§∫Áï∂ÂâçÊí≠ÊîæÊ≠åÊõ≤
                updateCurrentSong();
                updateNextSong();
            }

            // È°ØÁ§∫ÂÖ•Ê≠åÂÄíÊï∏ÊèêÈÜí
            function showCountdown() {
                const playerContainer = document.getElementById('player-container');
                const dots = ['...', '..', '.'];
                let index = 0;
                
                const showDots = () => {
                    if (index >= dots.length) return;
                    
                    const countdownDiv = document.createElement('div');
                    countdownDiv.className = 'countdown-overlay';
                    countdownDiv.textContent = dots[index];
                    playerContainer.appendChild(countdownDiv);
                    
                    setTimeout(() => {
                        countdownDiv.remove();
                    }, 800);
                    
                    index++;
                    if (index < dots.length) {
                        setTimeout(showDots, 800);
                    }
                };
                
                showDots();
            }

            // ÂàáÊèõÊ≠åË©ûÈ°ØÁ§∫
            async function toggleLyrics() {
                const lyricsSection = document.getElementById('lyricsSection');
                const toggleBtn = document.getElementById('toggleLyricsBtn');
                
                if (lyricsEnabled) {
                    // ÈóúÈñâÊ≠åË©û
                    lyricsEnabled = false;
                    lyricsSection.classList.remove('show');
                    toggleBtn.classList.remove('active');
                    clearLyrics();
                } else {
                    // ÈñãÂïüÊ≠åË©ûÂâçÂÖàÊ™¢Ê∏¨
                    if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                        const song = queue[currentSongIndex];
                        
                        // ÂÖàÈñãÂïüÊ≠åË©ûÈù¢Êùø‰∏¶È°ØÁ§∫ËºâÂÖ•‰∏≠
                        lyricsEnabled = true;
                        lyricsSection.classList.add('show');
                        toggleBtn.classList.add('active');
                        
                        const lyricsContainer = document.getElementById('lyricsContainer');
                        lyricsContainer.innerHTML = '<div class="lyrics-loading"><span class="loading"></span> Ê≠£Âú®ËºâÂÖ•Ê≠åË©û...</div>';
                        
                        try {
                            // ÂòóË©¶ËºâÂÖ•Ê≠åË©û
                            await loadLyrics(song.songName);
                            
                            // Ê™¢Êü•ÊòØÂê¶ÊàêÂäüËºâÂÖ•Ê≠åË©û
                            if (currentLyrics.length === 0 && lyricsContainer.innerHTML === '') {
                                // Ê≤íÊúâÊâæÂà∞Ê≠åË©ûÔºåËá™ÂãïÈóúÈñâ
                                lyricsEnabled = false;
                                lyricsSection.classList.remove('show');
                                toggleBtn.classList.remove('active');
                            }
                        } catch (err) {
                            console.error('ËºâÂÖ•Ê≠åË©ûÂ§±Êïó:', err);
                            lyricsEnabled = false;
                            lyricsSection.classList.remove('show');
                            toggleBtn.classList.remove('active');
                        }
                    }
                }
            }
            
            // ÂàáÊèõÂÅáÂÖ®Ëû¢Âπï
            function toggleFakeFullscreen() {
                const playerSection = document.querySelector('.player-section');
                const btn = document.getElementById('fakeFullscreenBtn');
                
                if (playerSection.classList.contains('fake-fullscreen')) {
                    // ÈÄÄÂá∫ÂÅáÂÖ®Ëû¢Âπï
                    playerSection.classList.remove('fake-fullscreen');
                    btn.innerHTML = '<div style="font-size: 1.3em; margin-bottom: 5px;">‚õ∂</div><div>Â§ßËû¢Âπï</div>';
                    btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                } else {
                    // ÈÄ≤ÂÖ•ÂÅáÂÖ®Ëû¢Âπï
                    playerSection.classList.add('fake-fullscreen');
                    btn.innerHTML = '<div style="font-size: 1.3em; margin-bottom: 5px;">‚úï</div><div>ÈÄÄÂá∫</div>';
                    btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
                }
            }

            // ÂàáÊèõËá™ÂãïÊí≠Êîæ
            function toggleAutoplay() {
                autoplayEnabled = !autoplayEnabled;
                localStorage.setItem('autoplayEnabled', autoplayEnabled.toString());
                
                const toggleBtn = document.getElementById('toggleAutoplayBtn');
                if (autoplayEnabled) {
                    toggleBtn.classList.add('active');
                } else {
                    toggleBtn.classList.remove('active');
                }
                
                console.log('üé¨ Ëá™ÂãïÊí≠ÊîæË®≠ÂÆö:', autoplayEnabled ? 'ÈñãÂïü' : 'ÈóúÈñâ');
            }

            // Êí≠Êîæ‰∏ã‰∏ÄÈ¶ñ
            async function playNext() {
                console.log('playNext called, current index:', currentSongIndex, 'queue length:', queue.length);
                if (currentSongIndex < queue.length - 1) {
                    await playSong(currentSongIndex + 1);
                    updateCurrentSong();
                    updateNextSong();
                } else {
                    // Â∑≤Á∂ìÊòØÊúÄÂæå‰∏ÄÈ¶ñÔºåÂÅúÊ≠¢Êí≠Êîæ
                    console.log('Already at last song');
                    currentSongIndex = queue.length - 1;
                    if (player && player.stopVideo) {
                        player.stopVideo();
                    }
                    await saveToFirebase();
                }
            }

            // Êí≠Êîæ‰∏ä‰∏ÄÈ¶ñ
            async function playPrevious() {
                console.log('playPrevious called, current index:', currentSongIndex);
                if (currentSongIndex > 0) {
                    await playSong(currentSongIndex - 1);
                    updateCurrentSong();
                    updateNextSong();
                } else {
                    console.log('Already at first song');
                }
            }

            // Èö®Ê©üÊí≠Êîæ
            async function playRandom() {
                console.log('playRandom called, queue length:', queue.length);
                if (queue.length === 0) {
                    return;
                }
                
                if (queue.length === 1) {
                    return;
                }
                
                if (currentSongIndex < 0 || currentSongIndex >= queue.length) {
                    // Â¶ÇÊûúÊ≤íÊúâÊ≠£Âú®Êí≠ÊîæÁöÑÊ≠åÊõ≤ÔºåÊâì‰∫ÇÊï¥ÂÄãÂàóË°®
                    queue = shuffleArray(queue);
                    currentSongIndex = -1;
                } else {
                    // ‰øùÁïôÊ≠£Âú®Êí≠ÊîæÁöÑÊ≠åÊõ≤ÔºåÊâì‰∫ÇÂÖ∂‰ªñÊ≠åÊõ≤
                    const currentSong = queue[currentSongIndex];
                    
                    // ÁßªÈô§Ê≠£Âú®Êí≠ÊîæÁöÑÊ≠åÊõ≤
                    const otherSongs = queue.filter((song, index) => index !== currentSongIndex);
                    
                    // Êâì‰∫ÇÂÖ∂‰ªñÊ≠åÊõ≤
                    const shuffledOthers = shuffleArray(otherSongs);
                    
                    // ÈáçÂª∫ÂàóË°®ÔºöÊ≠£Âú®Êí≠ÊîæÁöÑÊ≠åÊõ≤ÊîæÂú®Á¨¨‰∏Ä‰ΩçÔºåÂæåÈù¢Êé•Êâì‰∫ÇÂæåÁöÑÂÖ∂‰ªñÊ≠åÊõ≤
                    queue = [currentSong, ...shuffledOthers];
                    currentSongIndex = 0;
                }
                
                await saveToFirebase();
                updateUI();
                console.log('Queue shuffled, current index:', currentSongIndex);
            }
            
            // Fisher-Yates Ê¥óÁâåÊºîÁÆóÊ≥ï
            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }

            // Êí≠Êîæ/Êö´ÂÅú
            function togglePlayPause() {
                if (!player || !player.getPlayerState) {
                    console.log('Êí≠ÊîæÂô®Â∞öÊú™Ê∫ñÂÇôÂ•Ω');
                    return;
                }
                
                const state = player.getPlayerState();
                console.log('Current player state:', state);
                
                if (state === YT.PlayerState.PLAYING) {
                    player.pauseVideo();
                    isPlaying = false;
                } else if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.CUED) {
                    player.playVideo();
                    isPlaying = true;
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÂΩ±ÁâáÊàñÂÖ∂‰ªñÁãÄÊÖãÔºåÂòóË©¶Êí≠ÊîæÁï∂ÂâçÊ≠åÊõ≤
                    if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                        playSong(currentSongIndex);
                    } else {
                        console.log('Ê≤íÊúâÂèØÊí≠ÊîæÁöÑÊ≠åÊõ≤');
                    }
                }
                
                updatePlayPauseButton();
            }

            // Êõ¥Êñ∞Êí≠Êîæ/Êö´ÂÅúÊåâÈàï
            function updatePlayPauseButton() {
                const btn = document.getElementById('playPauseBtn');
                if (btn) {
                    if (player && player.getPlayerState) {
                        const state = player.getPlayerState();
                        if (state === YT.PlayerState.PLAYING) {
                            btn.innerHTML = '<div style="font-size: 1.4em;">‚è∏Ô∏è</div><div style="font-size: 0.75em; margin-top: 4px;">Êö´ÂÅú</div>';
                        } else {
                            btn.innerHTML = '<div style="font-size: 1.4em;">‚ñ∂Ô∏è</div><div style="font-size: 0.75em; margin-top: 4px;">Êí≠Êîæ</div>';
                        }
                    } else {
                        btn.innerHTML = '<div style="font-size: 1.4em;">‚ñ∂Ô∏è</div><div style="font-size: 0.75em; margin-top: 4px;">Êí≠Êîæ</div>';
                    }
                }
            }

            // ÈáçÊí≠Áï∂ÂâçÊ≠åÊõ≤
            function replaySong() {
                if (player && player.seekTo) {
                    player.seekTo(0);
                    player.playVideo();
                } else {
                    console.log('Êí≠ÊîæÂô®Â∞öÊú™Ê∫ñÂÇôÂ•Ω');
                }
            }

            // Âø´ÈÄ≤10Áßí
            function forward() {
                if (player && player.getCurrentTime && player.seekTo) {
                    const currentTime = player.getCurrentTime();
                    player.seekTo(currentTime + 10);
                } else {
                    console.log('Êí≠ÊîæÂô®Â∞öÊú™Ê∫ñÂÇôÂ•Ω');
                }
            }

            // ÂæåÈÄÄ10Áßí
            function backward() {
                if (player && player.getCurrentTime && player.seekTo) {
                    const currentTime = player.getCurrentTime();
                    player.seekTo(Math.max(0, currentTime - 10));
                } else {
                    console.log('Êí≠ÊîæÂô®Â∞öÊú™Ê∫ñÂÇôÂ•Ω');
                }
            }

            // ÂÅúÊ≠¢Êí≠Êîæ
            function stopVideo() {
                if (player && player.stopVideo) {
                    player.stopVideo();
                } else {
                    console.log('Êí≠ÊîæÂô®Â∞öÊú™Ê∫ñÂÇôÂ•Ω');
                }
            }

            // Âà™Èô§Ê≠åÊõ≤
            async function removeSong(index) {
                const songName = queue[index]?.songName || 'Ê≠åÊõ≤';
                queue.splice(index, 1);
                
                // Ë™øÊï¥Áï∂ÂâçÊí≠ÊîæÁ¥¢Âºï
                if (index < currentSongIndex) {
                    currentSongIndex--;
                } else if (index === currentSongIndex) {
                    // Â¶ÇÊûúÂà™Èô§ÁöÑÊòØÁï∂ÂâçÊí≠ÊîæÁöÑÊ≠åÔºåÊí≠Êîæ‰∏ã‰∏ÄÈ¶ñ
                    if (currentSongIndex >= queue.length) {
                        currentSongIndex = queue.length - 1;
                    }
                    if (currentSongIndex >= 0) {
                        playSong(currentSongIndex);
                    } else {
                        if (player && player.stopVideo) {
                            player.stopVideo();
                        }
                    }
                }
                
                await saveToFirebase();
                
                // Á´ãÂç≥Êõ¥Êñ∞ UI
                updateUI();
            }

            // Ê∏ÖÁ©∫ÊéíÈöäÂàóË°®
            async function clearQueue() {
                if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊéíÈöäÁöÑÊ≠åÊõ≤ÂóéÔºüÔºàÂåÖÊã¨Áï∂ÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤Ôºâ')) {
                    // ÂÆåÂÖ®Ê∏ÖÁ©∫ÊéíÈöäÂàóË°®
                    queue = [];
                    currentSongIndex = -1;
                    
                    // ÂÅúÊ≠¢Êí≠ÊîæÂô®
                    if (player && player.stopVideo) {
                        player.stopVideo();
                    }
                    
                    // ÂÅúÊ≠¢Ê≠åË©ûÂêåÊ≠•
                    stopLyricsSync();
                    currentLyrics = [];
                    
                    // ‰øùÂ≠òÂà∞ Firebase
                    await saveToFirebase();
                    
                    // Á´ãÂç≥Êõ¥Êñ∞ UI
                    updateUI();
                }
            }

            // Ê∏ÖÈô§Ê≠∑Âè≤Ë®òÈåÑ
            function clearHistory() {
                if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊ≠∑Âè≤Ë®òÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ')) {
                    history = [];
                    historyRef.set(null).then(() => {
                        // Á´ãÂç≥Êõ¥Êñ∞ UI
                        updateUI();
                    });
                }
            }

            // Modal ÊéßÂà∂
            const addSongModal = document.getElementById('addSongModal');
            const controlModal = document.getElementById('controlModal');
            const qrCodeModal = document.getElementById('qrCodeModal');
            const songListModal = document.getElementById('songListModal');
            const addSongBtn = document.getElementById('addSongBtn');
            const controlPanelBtn = document.getElementById('controlPanelBtn');
            const qrCodeBtn = document.getElementById('qrCodeBtn');
            const songListBtn = document.getElementById('songListBtn');
            const closeBtns = document.getElementsByClassName('close');

            addSongBtn.onclick = () => {
                addSongModal.style.display = 'block';
            };

            songListBtn.onclick = () => {
                songListModal.style.display = 'block';
                updateUI();
            };

            controlPanelBtn.onclick = () => {
                controlModal.style.display = 'block';
                updateControlPanel();
            };

            qrCodeBtn.onclick = () => {
                qrCodeModal.style.display = 'block';
            };

            // Tab ÂàáÊèõ
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Ê™¢Êü•ÊòØÂê¶ÊòØÂä†ÂÖ•Ê≠åÊõ≤ Modal ÁöÑ Tab
                    if (tabName === 'url' || tabName === 'search') {
                        // Âä†ÂÖ•Ê≠åÊõ≤ Modal ÁöÑ Tab ÂàáÊèõ
                        document.querySelectorAll('#addSongModal .tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.add-song-tab-content').forEach(c => c.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.getElementById(tabName + 'TabContent').classList.add('active');
                    } else {
                        // Ê≠åÊõ≤ÂàóË°® Modal ÁöÑ Tab ÂàáÊèõ
                        document.querySelectorAll('#songListModal .tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.getElementById(tabName + 'Tab').classList.add('active');
                        
                        currentTab = tabName;
                    }
                });
            });

            // YouTube ÊêúÂ∞ãÂäüËÉΩ
            let searchResultsData = [];
            let currentPage = 1;
            let nextPageToken = null;
            let prevPageToken = null;
            let currentSearchQuery = '';

            async function searchYouTube(query, pageToken = null) {
                if (!query.trim()) {
                    return;
                }

                currentSearchQuery = query;
                const searchBtn = document.getElementById('searchBtnText');
                const originalText = searchBtn.textContent;
                searchBtn.innerHTML = '<span class="loading"></span> ÊêúÂ∞ã‰∏≠...';

                try {
                    let apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=20&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}`;
                    if (pageToken) {
                        apiUrl += `&pageToken=${pageToken}`;
                    }
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error('ÊêúÂ∞ãÂ§±Êïó');
                    }

                    const data = await response.json();
                    searchResultsData = data.items;
                    nextPageToken = data.nextPageToken || null;
                    prevPageToken = data.prevPageToken || null;
                    
                    displaySearchResults(data.items);
                    updatePagination();
                } catch (error) {
                    console.error('Search error:', error);
                    document.getElementById('searchResults').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ÊêúÂ∞ãÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶</div>';
                } finally {
                    searchBtn.textContent = originalText;
                }
            }

            // ÊèõÈ†Å
            function changePage(direction) {
                if (direction > 0 && nextPageToken) {
                    currentPage++;
                    searchYouTube(currentSearchQuery, nextPageToken);
                } else if (direction < 0 && prevPageToken) {
                    currentPage--;
                    searchYouTube(currentSearchQuery, prevPageToken);
                }
            }

            // Êõ¥Êñ∞ÂàÜÈ†ÅÊåâÈàï
            function updatePagination() {
                const pagination = document.getElementById('pagination');
                const prevBtn = document.getElementById('prevPageBtn');
                const nextBtn = document.getElementById('nextPageBtn');
                const pageInfo = document.getElementById('pageInfo');

                if (searchResultsData.length > 0) {
                    pagination.style.display = 'flex';
                    prevBtn.disabled = !prevPageToken;
                    nextBtn.disabled = !nextPageToken;
                    pageInfo.textContent = `Á¨¨ ${currentPage} È†Å`;
                } else {
                    pagination.style.display = 'none';
                }
            }

            // È°ØÁ§∫ÊêúÂ∞ãÁµêÊûú
            function displaySearchResults(items) {
                const searchResults = document.getElementById('searchResults');
                
                if (!items || items.length === 0) {
                    searchResults.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Ê≤íÊúâÊâæÂà∞Áõ∏ÈóúÂΩ±Áâá</div>';
                    document.getElementById('pagination').style.display = 'none';
                    return;
                }

                searchResults.innerHTML = items.map(item => {
                    const videoId = item.id.videoId;
                    const title = item.snippet.title.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    const channelTitle = item.snippet.channelTitle.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    const thumbnailUrl = item.snippet.thumbnails.medium.url;
                    const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                    
                    // Ê™¢Êü•ÈÄôÈ¶ñÊ≠åÊòØÂê¶Â∑≤Á∂ìÂú®ÊéíÈöäÂàóË°®‰∏≠
                    const isInQueue = queue.some(song => extractVideoId(song.url) === videoId);
                    
                    // Ê†πÊìöÊòØÂê¶Â∑≤Â≠òÂú®Ë®≠ÁΩÆÊåâÈàï
                    let buttonHTML;
                    if (isInQueue) {
                        buttonHTML = `<button class="search-result-add-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); cursor: not-allowed;" disabled>‚ö†Ô∏è Â∑≤Â≠òÂú®</button>`;
                    } else {
                        buttonHTML = `<button class="search-result-add-btn" data-video-id="${videoId}" data-video-url="${videoUrl}" data-video-title="${title}">‚ûï Âä†ÂÖ•</button>`;
                    }

                    return `
                        <div class="search-result-item">
                            <div class="search-result-thumbnail" data-video-url="${videoUrl}" style="cursor: pointer;">
                                <img src="${thumbnailUrl}" alt="${title}">
                            </div>
                            <div class="search-result-info">
                                <h4>${title}</h4>
                                <p>${channelTitle}</p>
                            </div>
                            ${buttonHTML}
                        </div>
                    `;
                }).join('');
                
                // ÁÇ∫Á∏ÆÂúñÊ∑ªÂä†ÈªûÊìä‰∫ã‰ª∂ - Âú® YouTube È†êË¶Ω
                document.querySelectorAll('.search-result-thumbnail').forEach(thumbnail => {
                    thumbnail.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const url = this.getAttribute('data-video-url');
                        if (url) {
                            // ‰ΩøÁî® <a> Ê®ôÁ±§Ê®°Êì¨ÈªûÊìäÔºåÊõ¥ÂèØÈù†
                            const link = document.createElement('a');
                            link.href = url;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }
                    });
                });
                
                // ÁÇ∫ÊØèÂÄãÊåâÈàïÊ∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
                document.querySelectorAll('.search-result-add-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const url = this.getAttribute('data-video-url');
                        const title = this.getAttribute('data-video-title');
                        addSongFromSearch(url, title, this);
                    });
                });
            }

            // ÂæûÊêúÂ∞ãÁµêÊûúÂä†ÂÖ•Ê≠åÊõ≤
            function addSongFromSearch(url, title, button) {
                // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÂú®ÈöäÂàó‰∏≠
                const videoId = extractVideoId(url);
                const isDuplicate = queue.some(song => extractVideoId(song.url) === videoId);
                
                if (isDuplicate) {
                    // Ë¶ñË¶∫ÂèçÈ•ãÔºöÂ∑≤Â≠òÂú®ÔºàÊ∞∏‰πÖ‰øùÊåÅÔºâ
                    button.innerHTML = '‚ö†Ô∏è Â∑≤Â≠òÂú®';
                    button.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    button.style.cursor = 'not-allowed';
                    button.disabled = true;
                    return;
                }

                addSong({
                    songName: title,
                    url: url,
                    addedAt: new Date().toISOString()
                }, true); // ÂÇ≥ÈÅû fromSearch = true

                // ÊàêÂäüÂãïÁï´
                button.classList.add('added');
                button.innerHTML = '‚úì Â∑≤Âä†ÂÖ•';
                button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                button.disabled = true;
                
                // Ê∑ªÂä†ÊàêÂäüÁöÑË¶ñË¶∫ÂèçÈ•ã
                setTimeout(() => {
                    button.classList.remove('added');
                }, 600);
            }

            // ÊêúÂ∞ãÊåâÈàïÈªûÊìä‰∫ã‰ª∂
            document.getElementById('searchBtn').onclick = () => {
                const query = document.getElementById('searchInput').value;
                searchYouTube(query);
            };

            // ÊêúÂ∞ãËº∏ÂÖ•Ê°ÜÊåâ Enter Èçµ
            document.getElementById('searchInput').onkeypress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = document.getElementById('searchInput').value;
                    searchYouTube(query);
                }
            };

            // ÂØÜÁ¢ºÈ©óË≠âÔºàÂ∑≤ÁßªÈô§Ôºâ

            // ÈóúÈñâ modal
            Array.from(closeBtns).forEach(btn => {
                btn.onclick = function() {
                    const modal = this.parentElement.parentElement;
                    modal.style.display = 'none';
                };
            });

            window.onclick = (event) => {
                if (event.target === addSongModal) {
                    addSongModal.style.display = 'none';
                }
                if (event.target === controlModal) {
                    controlModal.style.display = 'none';
                }
                if (event.target === qrCodeModal) {
                    qrCodeModal.style.display = 'none';
                }
                if (event.target === songListModal) {
                    songListModal.style.display = 'none';
                }
            };

            // Ë°®ÂñÆÊèê‰∫§
            document.getElementById('addSongForm').onsubmit = async (e) => {
                e.preventDefault();
                
                const youtubeUrl = document.getElementById('youtubeUrl').value;
                const submitBtn = document.getElementById('addBtnText');
                const originalText = submitBtn.textContent;
                
                // È©óË≠â URL
                const videoId = extractVideoId(youtubeUrl);
                if (!videoId) {
                    return;
                }
                
                console.log('Adding song with video ID:', videoId);
                
                // Ëá™ÂãïÁç≤ÂèñÊ≠åÊõ≤ÂêçÁ®±
                submitBtn.innerHTML = '<span class="loading"></span> Ê≠£Âú®Áç≤ÂèñÊ≠åÊõ≤Ë≥áË®ä...';
                
                let songName;
                try {
                    console.log('Calling getVideoTitle...');
                    songName = await getVideoTitle(videoId);
                    console.log('Got song name:', songName);
                    
                    // Â¶ÇÊûúÁç≤ÂèñÂ§±ÊïóÔºàËøîÂõûÈ†êË®≠ÂêçÁ®±ÔºâÔºåÊèêÁ§∫Áî®Êà∂
                    if (songName.startsWith('YouTube ÂΩ±Áâá')) {
                        submitBtn.textContent = originalText;
                        return;
                    }
                } catch (error) {
                    console.error('Error fetching title:', error);
                    submitBtn.textContent = originalText;
                    return;
                }
                
                try {
                    // Ê∑ªÂä†Ê≠åÊõ≤
                    addSong({
                        songName,
                        url: youtubeUrl,
                        addedAt: new Date().toISOString()
                    });
                    
                    // Ê∏ÖÁ©∫Ë°®ÂñÆ
                    e.target.reset();
                    addSongModal.style.display = 'none';
                } catch (error) {
                    console.error('Error adding song:', error);
                } finally {
                    submitBtn.textContent = originalText;
                }
            };

            // ÂàùÂßãÂåñ
            document.addEventListener('DOMContentLoaded', () => {
                console.log('KTV System initialized');
                // Á´ãÂç≥Ë®≠ÁΩÆ Firebase Áõ£ËÅΩÂô®Ôºå‰∏çÁ≠âÂæÖ YouTube Player
                setupFirebaseListeners();
                
                // ÊéßÂà∂Èù¢ÊùøÊåâÈàï
                document.getElementById('prevBtn').onclick = playPrevious;
                document.getElementById('nextBtn').onclick = playNext;
                document.getElementById('randomBtn').onclick = playRandom;
                document.getElementById('clearQueueBtn').onclick = clearQueue;
                document.getElementById('clearHistoryBtn').onclick = clearHistory;

                // ÂÅáÂÖ®Ëû¢ÂπïÊåâÈàï
                document.getElementById('fakeFullscreenBtn').onclick = toggleFakeFullscreen;

                // Ëá™ÂãïÊí≠ÊîæÈñãÈóúÊåâÈàï
                const toggleAutoplayBtn = document.getElementById('toggleAutoplayBtn');
                if (toggleAutoplayBtn) {
                    toggleAutoplayBtn.onclick = toggleAutoplay;
                    // ÂàùÂßãÂåñÊåâÈàïÁãÄÊÖã
                    if (autoplayEnabled) {
                        toggleAutoplayBtn.classList.add('active');
                    }
                    console.log('üé¨ Ëá™ÂãïÊí≠ÊîæÂàùÂßãË®≠ÂÆö:', autoplayEnabled ? 'ÈñãÂïü' : 'ÈóúÈñâ');
                }

                // Ê≠åË©ûÈñãÈóúÊåâÈàï
                document.getElementById('toggleLyricsBtn').onclick = toggleLyrics;
                
                // ÊêúÂ∞ãÊåâÈàïÈªûÊìä‰∫ã‰ª∂
                document.getElementById('searchBtn').onclick = () => {
                    const query = document.getElementById('searchInput').value;
                    searchYouTube(query);
                };

                // ÊêúÂ∞ãËº∏ÂÖ•Ê°ÜÊåâ Enter Èçµ
                document.getElementById('searchInput').onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const query = document.getElementById('searchInput').value;
                        searchYouTube(query);
                    }
                };
            });
        </script>
    </body>
    </html>
