    <!DOCTYPE html>
    <html lang="zh-TW">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>KTV 排隊系統</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                background-attachment: fixed;
                min-height: 100vh;
                padding: 20px;
                color: #333;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            /* Header */
            header {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                margin-bottom: 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 20px;
                border: 2px solid rgba(255, 255, 255, 0.3);
            }

            header h1 {
                font-size: 2.5em;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                text-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            }

            .header-buttons {
                display: flex;
                gap: 10px;
            }

            /* Buttons */
            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 10px;
                font-size: 1em;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                position: relative;
                overflow: hidden;
            }

            .btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }

            .btn:active::before {
                width: 300px;
                height: 300px;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            }

            .btn:active {
                transform: translateY(0);
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .btn-secondary {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
            }

            .btn-control {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                font-size: 1.2em;
                padding: 15px 30px;
            }

            .btn-warning {
                background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
                color: white;
                width: 100%;
                margin-top: 10px;
            }

            .btn-danger {
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                color: white;
                width: 100%;
                margin-top: 10px;
            }

            .btn-large {
                width: 100%;
                padding: 15px;
                font-size: 1.1em;
            }

            /* Tab Navigation */
            .tab-navigation {
                display: flex;
                gap: 0;
                margin-bottom: 20px;
                background: rgba(224, 224, 224, 0.3);
                backdrop-filter: blur(10px);
                border-radius: 12px;
                padding: 4px;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .tab-btn {
                flex: 1;
                padding: 12px 20px;
                border: none;
                background: transparent;
                color: #666;
                font-size: 1em;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border-radius: 10px;
                position: relative;
            }

            .tab-btn::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                width: 0;
                height: 2px;
                background: linear-gradient(90deg, #667eea, #764ba2);
                transform: translateX(-50%);
                transition: width 0.3s ease;
            }

            .tab-btn.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                transform: translateY(-2px);
            }

            .tab-btn.active::after {
                width: 80%;
            }

            .tab-btn:hover:not(.active) {
                background: rgba(255, 255, 255, 0.5);
                transform: translateY(-1px);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            /* Sections */
            section {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                margin-bottom: 30px;
                border: 2px solid rgba(255, 255, 255, 0.3);
            }

            section h2 {
                font-size: 1.8em;
                margin-bottom: 20px;
                color: #667eea;
            }

            /* Now Playing */
            .current-song-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 30px;
                border-radius: 15px;
                color: white;
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
                animation: fadeIn 0.5s ease;
                position: relative;
                overflow: hidden;
            }

            .current-song-card::before {
                content: '';
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                animation: pulse 3s ease-in-out infinite;
            }

            @keyframes pulse {
                0%, 100% { transform: scale(1); opacity: 0.5; }
                50% { transform: scale(1.1); opacity: 0.8; }
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .current-song-card .song-info {
                position: relative;
                z-index: 1;
            }

            .current-song-card .song-info h3 {
                font-size: 2em;
                margin-bottom: 10px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }

            .current-song-card .song-info p {
                font-size: 1.2em;
                opacity: 0.9;
                margin-bottom: 5px;
                text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            }

            .current-song-thumbnail {
                width: 200px;
                height: 150px;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                flex-shrink: 0;
                position: relative;
                z-index: 1;
                border: 3px solid rgba(255,255,255,0.3);
                transition: transform 0.3s ease;
            }

            .current-song-thumbnail:hover {
                transform: scale(1.05);
            }

            .current-song-thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .control-panel-thumbnail {
                width: 120px;
                height: 90px;
            }

            .control-panel-thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                border: 2px solid rgba(255, 255, 255, 0.5);
            }

            .no-song {
                text-align: center;
                padding: 40px;
                font-size: 1.2em;
                opacity: 0.7;
            }

            /* Player */
            .player-section {
                background: #000;
                position: relative;
                transition: all 0.5s ease;
            }

            /* 假全螢幕模式 */
            .player-section.fake-fullscreen {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 9999 !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .player-section.fake-fullscreen #player-container {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                padding-bottom: 0 !important;
            }

            .player-section.fake-fullscreen .lyrics-section {
                position: fixed !important;
                bottom: -50px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                z-index: 10000 !important;
                width: 90% !important;
                max-width: 1200px !important;
            }
            
            .player-section.fake-fullscreen .lyrics-container {
                display: block !important;
                text-align: center !important;
            }

            .player-section.fake-fullscreen .lyrics-line.active {
                font-size: 3em !important;
                text-shadow: 3px 3px 15px rgba(0, 0, 0, 0.95),
                            0 0 30px rgba(0, 0, 0, 0.9),
                            0 0 10px rgba(255, 255, 255, 0.4) !important;
            }
            
            .player-section.fake-fullscreen .lyrics-countdown.active {
                font-size: 2em !important;
            }

            #player-container {
                position: relative;
                padding-bottom: 56.25%; /* 16:9 */
                height: 0;
                overflow: hidden;
            }

            #player {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            /* Queue List */
            .queue-list {
                display: flex;
                flex-direction: column;
                gap: 15px;
                max-height: 600px;
                overflow-y: auto;
                padding-right: 10px;
            }

            .queue-list::-webkit-scrollbar {
                width: 8px;
            }

            .queue-list::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            .queue-list::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
            }

            .queue-list::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            }

            .queue-item {
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                padding: 15px;
                border-radius: 15px;
                display: flex;
                gap: 15px;
                align-items: center;
                transition: all 0.3s ease;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                cursor: move;
                user-select: none;
            }

            .queue-item.playing {
                background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
                box-shadow: 0 5px 20px rgba(253, 203, 110, 0.5);
                border: 2px solid #fdcb6e;
            }

            .queue-item.completed {
                background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
                opacity: 0.6;
                cursor: default;
            }

            .queue-item:hover {
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            }

            .queue-item.completed:hover {
                transform: none;
            }

            .queue-item.sortable-chosen {
                cursor: grabbing;
            }

            .queue-item.sortable-ghost {
                opacity: 0.3;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .queue-item.sortable-drag {
                opacity: 1;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                transform: rotate(2deg) scale(1.05);
            }

            .queue-item-thumbnail {
                flex-shrink: 0;
                width: 120px;
                height: 90px;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                position: relative;
            }

            .queue-item-thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }



            .queue-item-info {
                flex: 1;
                min-width: 0;
            }

            .queue-item-number {
                font-size: 1.8em;
                font-weight: bold;
                color: #667eea;
                min-width: 40px;
                text-align: center;
            }

            .queue-item-info h4 {
                font-size: 1.2em;
                margin-bottom: 5px;
                color: #333;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .queue-item-drag-handle {
                font-size: 1em;
                color: #999;
                cursor: move;
                padding: 0 5px;
            }

            .queue-item-drag-handle:hover {
                color: #667eea;
            }

            .queue-item-info p {
                color: #666;
                font-size: 0.9em;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .queue-item-actions button {
                background: #ff6b6b;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                white-space: nowrap;
            }

            .queue-item-actions button:hover {
                background: #ee5a6f;
                transform: scale(1.05);
            }

            .queue-item-actions button.added {
                animation: addedAnimation 0.6s ease;
            }

            .queue-item-actions button:disabled {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                cursor: not-allowed;
                transform: scale(1);
            }

            .empty-queue {
                text-align: center;
                padding: 60px 20px;
                color: #999;
                font-size: 1.2em;
            }

            /* Modal */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(5px);
            }

            .modal-content {
                background: white;
                margin: 5% auto;
                padding: 40px;
                border-radius: 20px;
                width: 90%;
                max-width: 600px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    transform: translateY(-50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
                transition: color 0.3s ease;
            }

            .close:hover {
                color: #000;
            }

            /* Form */
            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #333;
            }

            .form-group input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 1em;
                transition: border-color 0.3s ease;
            }

            .form-group input:focus {
                outline: none;
                border-color: #667eea;
            }

            .form-group small {
                display: block;
                margin-top: 5px;
                color: #999;
                font-size: 0.85em;
            }

            /* Add Song Tab Content */
            .add-song-tab-content {
                display: none;
            }

            .add-song-tab-content.active {
                display: block;
            }

            /* Search Results */
            .search-result-item {
                display: flex;
                gap: 15px;
                align-items: center;
                padding: 12px;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                border-radius: 12px;
                margin-bottom: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .search-result-item:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                background: linear-gradient(135deg, #e8eaf6 0%, #b8c5e0 100%);
            }

            .search-result-thumbnail {
                width: 120px;
                height: 90px;
                border-radius: 8px;
                overflow: hidden;
                flex-shrink: 0;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            }

            .search-result-thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .search-result-info {
                flex: 1;
                min-width: 0;
            }

            .search-result-info h4 {
                font-size: 1.1em;
                margin-bottom: 5px;
                color: #333;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
            }

            .search-result-info p {
                font-size: 0.85em;
                color: #666;
            }

            .search-result-add-btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                white-space: nowrap;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                flex-shrink: 0;
                position: relative;
                overflow: hidden;
                min-width: 90px;
            }

            .search-result-add-btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }

            .search-result-add-btn:active::before {
                width: 200px;
                height: 200px;
            }

            .search-result-add-btn:hover:not(:disabled) {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .search-result-add-btn:disabled {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                cursor: not-allowed;
                transform: scale(1);
            }

            .search-result-add-btn.added {
                animation: addedAnimation 0.6s ease;
            }

            @keyframes addedAnimation {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.2) rotate(5deg);
                }
                100% {
                    transform: scale(1);
                }
            }

            /* Pagination */
            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 15px;
                margin-top: 20px;
                padding: 15px;
            }

            .pagination button {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .pagination button:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .pagination button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .pagination-info {
                font-size: 0.9em;
                color: #666;
                font-weight: 600;
            }

            /* Control Panel */
            .control-panel {
                padding: 20px 0;
            }

            .control-info {
                background: #f5f7fa;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
            }

            .control-info p {
                margin-bottom: 10px;
                font-size: 1.1em;
            }

            .control-buttons {
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-bottom: 20px;
            }

            .control-actions {
                display: flex;
                flex-direction: column;
            }

            /* Responsive */
            @media (max-width: 768px) {
                body {
                    padding: 10px;
                }

                .container {
                    max-width: 100%;
                }

                header {
                    flex-direction: column;
                    text-align: center;
                    padding: 20px;
                }

                header h1 {
                    font-size: 1.5em;
                }

                .header-buttons {
                    width: 100%;
                    flex-direction: column;
                }

                .header-buttons .btn {
                    font-size: 0.9em;
                    padding: 10px 20px;
                }

                /* 縮小 section 內距 */
                section {
                    padding: 15px;
                    margin-bottom: 15px;
                }

                section h2 {
                    font-size: 1.3em;
                    margin-bottom: 15px;
                }

                /* 現正播放區域 */
                .current-song-card {
                    padding: 15px;
                }

                .current-song-card .song-info h3 {
                    font-size: 0.85em !important;
                    margin-bottom: 8px;
                    line-height: 1.4;
                    word-wrap: break-word;
                }

                .current-song-card .song-info {
                    gap: 12px !important;
                }

                .current-song-card .song-info p {
                    font-size: 0.9em;
                }

                .current-song-thumbnail {
                    width: 80px;
                    height: 60px;
                }

                .control-panel-thumbnail {
                    width: 120px;
                    height: 90px;
                }   

                .no-song {
                    padding: 20px;
                    font-size: 1em;
                }

                /* 播放器區域 */
                .player-section {
                    padding: 0;
                }

                /* 排隊列表 */
                .queue-list {
                    gap: 10px;
                    max-height: 400px;
                }

                .control-buttons {
                    flex-direction: column;
                }

                .queue-item {
                    flex-direction: row;
                    align-items: center;
                    gap: 8px;
                    padding: 10px;
                }

                .queue-item-drag-handle {
                    font-size: 1.2em;
                    padding: 0 3px;
                }

                .queue-item-thumbnail {
                    width: 60px;
                    height: 45px;
                }

                .queue-item-number {
                    font-size: 1em;
                    min-width: 25px;
                }

                .queue-item-info {
                    flex: 1;
                    min-width: 0;
                }

                .queue-item-info h4 {
                    font-size: 0.85em;
                    line-height: 1.3;
                    word-wrap: break-word;
                    white-space: normal;
                    overflow: hidden;
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    line-clamp: 2;
                    -webkit-box-orient: vertical;
                }

                .queue-item-info p {
                    font-size: 0.75em;
                }

                .queue-item-actions {
                    width: auto;
                    flex-shrink: 0;
                }

                .queue-item-actions button {
                    padding: 5px 10px;
                    font-size: 0.8em;
                }

                .empty-queue {
                    padding: 30px 10px;
                    font-size: 0.9em;
                }

                /* 優化下一首歌曲區域 */
                .next-song-section {
                    padding: 12px;
                }

                .next-song-section h2 {
                    font-size: 1.1em;
                }

                /* Modal 內容 */
                .modal-content {
                    width: 95%;
                    margin: 10% auto;
                    padding: 20px;
                }

                .modal-content h2 {
                    font-size: 1.3em;
                }

                .form-group label {
                    font-size: 0.9em;
                }

                .form-group input {
                    padding: 10px;
                    font-size: 0.9em;
                }

                .form-group small {
                    font-size: 0.8em;
                }

                .btn-large {
                    padding: 12px;
                    font-size: 1em;
                }

                /* 控制面板 */
                .control-info {
                    padding: 15px;
                    font-size: 0.9em;
                }

                .control-info p {
                    font-size: 0.95em;
                    margin-bottom: 8px;
                }

                .btn-control {
                    font-size: 0.85em;
                    padding: 10px 15px;
                }

                /* 控制面板按鈕優化 */
                #controlModal .modal-content {
                    padding: 15px;
                }

                /* 控制面板正在播放字體 */
                #controlCurrentSong {
                    font-size: 0.85em !important;
                }

                #controlModal .btn {
                    font-size: 0.8em !important;
                    padding: 10px 6px !important;
                }

                #controlModal .btn div:first-child {
                    font-size: 1.1em !important;
                }

                #controlModal .btn div:last-child {
                    font-size: 0.7em !important;
                }

                /* 搜尋結果手機版 */
                #searchResults {
                    max-height: 250px !important;
                }

                .search-result-item {
                    flex-direction: row;
                    gap: 8px;
                    padding: 10px;
                }

                .search-result-thumbnail {
                    width: 60px;
                    height: 45px;
                }

                .search-result-info h4 {
                    font-size: 0.85em;
                    -webkit-line-clamp: 2;
                    line-clamp: 2;
                }

                .search-result-info p {
                    font-size: 0.75em;
                }

                .search-result-add-btn {
                    padding: 6px 12px;
                    font-size: 0.8em;
                    white-space: nowrap;
                }

                /* 分頁按鈕手機版 */
                .pagination {
                    padding: 10px;
                    gap: 10px;
                }

                .pagination button {
                    padding: 8px 12px;
                    font-size: 0.85em;
                }

                .pagination-info {
                    font-size: 0.85em;
                }
            }

            /* Loading Animation */
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Control Panel Button Hover Effects */
            #controlModal .btn:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            }

            #controlModal .btn:active {
                transform: translateY(0) scale(0.98);
            }

            #playPauseBtn:hover {
                box-shadow: 0 8px 25px rgba(253, 203, 110, 0.6) !important;
            }

            #prevBtn:hover, #nextBtn:hover {
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5) !important;
            }

            #clearQueueBtn:hover {
                box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5) !important;
            }

            /* 歌詞開關按鈕 */
            .lyrics-toggle-btn {
                position: relative;
                width: 60px;
                height: 30px;
                background: #ccc;
                border: none;
                border-radius: 15px;
                cursor: pointer;
                transition: background 0.3s ease;
                padding: 0;
                outline: none;
            }

            .lyrics-toggle-btn.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .lyrics-toggle-btn::after {
                content: '';
                position: absolute;
                top: 3px;
                left: 3px;
                width: 24px;
                height: 24px;
                background: white;
                border-radius: 50%;
                transition: left 0.3s ease;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }

            .lyrics-toggle-btn.active::after {
                left: 33px;
            }

            /* 歌詞顯示 */
            .lyrics-section {
                position: absolute;
                bottom: -60px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 1000px;
                z-index: 2147483647 !important;
                pointer-events: none;
                background: none !important;
                background-color: transparent !important;
                background-image: none !important;
                box-shadow: none !important;
                border: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }

            .lyrics-section.show {
                display: block;
            }

            .lyrics-toggle {
                display: none;
            }

            .lyrics-container {
                background: none !important;
                background-color: transparent !important;
                background-image: none !important;
                padding: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                display: block;           /* 改為 block 讓歌詞上下排列 */
                text-align: center;       /* 保持居中對齊 */
                min-height: auto;
            }

            .lyrics-container::-webkit-scrollbar {
                display: none;
            }

            .lyrics-line {
                padding: 0 !important;
                margin: 0 !important;
                font-size: 2em;
                line-height: 1.4;
                color: white;
                transition: all 0.3s ease;
                text-align: center;
                display: none;
                font-weight: 500;
                background: none !important;
                background-color: transparent !important;
                background-image: none !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.95),
                            0 0 15px rgba(0, 0, 0, 0.8);
                position: relative;
            }

            .lyrics-line.active {
                background: none !important;
                background-color: transparent !important;
                background-image: none !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                color: white;
                font-size: 2.5em;
                font-weight: 600;
                display: block;
                animation: fadeInLyrics 0.3s ease;
                padding: 0 !important;
                margin: 0 !important;
                text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.95),
                            0 0 20px rgba(0, 0, 0, 0.9),
                            0 0 5px rgba(255, 255, 255, 0.3);
            }

            @keyframes fadeInLyrics {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .lyrics-line.past {
                opacity: 0;
                display: none;
            }

            .lyrics-line.future {
                opacity: 0;
                display: none;
            }

            .no-lyrics {
                display: none;
            }

            .lyrics-loading {
                display: none;
            }

            /* 入歌倒數提醒 */
            .countdown-overlay {
                position: absolute;
                top: 50%;
                left: 20%;
                transform: translate(0, -50%);
                z-index: 100;
                font-size: 8em;
                font-weight: bold;
                color: white;
                text-shadow: 0 0 30px rgba(0, 0, 0, 0.8),
                            0 0 60px rgba(102, 126, 234, 0.6);
                animation: countdownPulse 1s ease-out;
                pointer-events: none;
            }

            @keyframes countdownPulse {
                0% {
                    opacity: 0;
                    transform: translate(0, -50%) scale(0.5);
                }
                50% {
                    opacity: 1;
                    transform: translate(0, -50%) scale(1.2);
                }
                100% {
                    opacity: 0;
                    transform: translate(0, -50%) scale(1);
                }
            }

            /* 倒數點樣式 - 與歌詞左對齊，上下排列 */
            .lyrics-countdown {
                font-size: 1.5em;
                text-align: center;        /* 居中對齊 */
                display: none;             /* 預設隱藏 */
                margin-bottom: 0.3em;      /* 與下方歌詞的間距 */
            }
            
            .lyrics-countdown.active {
                display: block;            /* 啟動時顯示 */
            }

            .countdown-dot {
                display: inline-block;
                margin: 0 0.15em;          /* 點之間的間距 */
                opacity: 1;
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.8),
                            0 0 20px rgba(255, 255, 255, 0.5);
            }
            
            .countdown-dot:first-child {
                margin-left: 0;            /* 第一個點左邊不留間距 */
            }

            /* 倒數點消失動畫 - 使用 CSS 動畫避免 setTimeout 問題 */
            .lyrics-countdown.active .countdown-dot.dot-1 {
                animation: dotFadeOut 0.3s ease-out 0.9s forwards;
            }

            .lyrics-countdown.active .countdown-dot.dot-2 {
                animation: dotFadeOut 0.3s ease-out 1.8s forwards;
            }

            .lyrics-countdown.active .countdown-dot.dot-3 {
                animation: dotFadeOut 0.3s ease-out 2.7s forwards;
            }

            @keyframes dotFadeOut {
                from {
                    opacity: 1;
                }
                to {
                    opacity: 0;
                }
            }

            /* 倒數點和第一句歌詞一起顯示時的樣式 */
            .first-lyric-with-countdown {
                margin-top: 0 !important;  /* 緊貼倒數點下方 */
            }

            .lyrics-toggle {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 12px;
            }

            .lyrics-toggle h2 {
                margin: 0;
                font-size: 1.5em;
            }

            .lyrics-btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                font-size: 0.9em;
            }

            .lyrics-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            @media (max-width: 768px) {
                .lyrics-section {
                    bottom: -30px;
                    width: 95%;
                    background: none !important;
                    background-color: transparent !important;
                    background-image: none !important;
                    backdrop-filter: none !important;
                    -webkit-backdrop-filter: none !important;
                }

                .lyrics-container {
                    padding: 0 !important;
                    background: none !important;
                    background-color: transparent !important;
                    background-image: none !important;
                    backdrop-filter: none !important;
                    -webkit-backdrop-filter: none !important;
                }

                .lyrics-line {
                    font-size: 1.1em;
                    background: none !important;
                    background-color: transparent !important;
                    background-image: none !important;
                }

                .lyrics-line.active {
                    font-size: 1.3em;
                    background: none !important;
                    background-color: transparent !important;
                    background-image: none !important;
                }

                .countdown-overlay {
                    font-size: 5em;
                }

                .lyrics-countdown {
                    font-size: 1.5em;
                }

                .countdown-dot {
                    margin: 0 0.1em;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <h1 style="margin: 0;">點歌系統</h1>
                    <img src="3.gif" alt="animation" style="width: 60px; height: 60px; object-fit: contain;">
                    <img src="2.gif" alt="animation" style="width: 60px; height: 60px; object-fit: contain;">
                    <img src="1.gif" alt="animation" style="width: 60px; height: 60px; object-fit: contain;">
                </div>
                <div class="header-buttons">
                    <button id="addSongBtn" class="btn btn-primary">➕ 加入歌曲</button>
                    <button id="songListBtn" class="btn btn-secondary">📋 歌曲列表</button>
                    <button id="controlPanelBtn" class="btn btn-secondary">🎛️ 控制面板</button>
                    <button id="qrCodeBtn" class="btn btn-secondary">📱 QR Code</button>
                </div>
            </header>

            <!-- 當前播放 -->
            <section class="now-playing">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>🎵 現正播放</h2>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                        <span id="lyricsStatusText" style="font-size: 0.8em; color: #ff6b6b; display: none;">找不到歌詞</span>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 0.9em; color: #666;">自動播放</span>
                                <button id="toggleAutoplayBtn" class="lyrics-toggle-btn"></button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 0.9em; color: #666;">歌詞</span>
                                <button id="toggleLyricsBtn" class="lyrics-toggle-btn"></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="currentSong" class="current-song-card">
                    <div class="no-song">目前沒有歌曲播放</div>
                </div>
            </section>

            <!-- YouTube 播放器 -->
            <section class="player-section">
                <div id="player-container">
                    <div id="player"></div>
                    
                    <!-- 歌詞顯示疊加在影片上 -->
                    <section class="lyrics-section" id="lyricsSection">
                        <div class="lyrics-container" id="lyricsContainer">
                            <div class="no-lyrics"></div>
                        </div>
                    </section>
                </div>
            </section>

            <!-- 下一首歌曲 -->
            <section class="next-song-section">
                <h2>⏭️ 下一首</h2>
                <div id="nextSongDisplay" class="queue-list" style="max-height: 300px;">
                    <div class="empty-queue">沒有下一首歌曲</div>
                </div>
            </section>
        </div>

        <!-- 添加歌曲 Modal -->
        <div id="addSongModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close">&times;</span>
                <h2 style="margin-bottom: 25px;">➕ 加入歌曲</h2>
                
                <!-- Tab 切換：連結 / 搜尋 -->
                <div class="tab-navigation" style="margin-bottom: 20px;">
                    <button class="tab-btn active" data-tab="url" id="urlTabBtn">🔗 貼上連結</button>
                    <button class="tab-btn" data-tab="search" id="searchTabBtn">🔍 搜尋影片</button>
                </div>

                <!-- 連結輸入 Tab -->
                <div id="urlTabContent" class="add-song-tab-content active">
                    <form id="addSongForm">
                        <div class="form-group">
                            <label for="youtubeUrl">YouTube 連結</label>
                            <input type="url" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=...">
                            <small>貼上 YouTube 影片連結，系統會自動獲取歌名</small>
                        </div>
                        <button type="submit" class="btn btn-primary btn-large">
                            <span id="addBtnText">加入排隊</span>
                        </button>
                    </form>
                </div>

                <!-- 搜尋 Tab -->
                <div id="searchTabContent" class="add-song-tab-content">
                    <div class="form-group">
                        <label for="searchInput">搜尋關鍵字</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="searchInput" placeholder="輸入歌名、歌手或關鍵字..." style="flex: 1;">
                            <button id="searchBtn" class="btn btn-primary" style="white-space: nowrap; padding: 12px 24px;">
                                <span id="searchBtnText">🔍 搜尋</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 搜尋結果 -->
                    <div id="searchResults" style="max-height: 300px; overflow-y: auto; margin-top: 20px;">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            輸入關鍵字開始搜尋
                        </div>
                    </div>
                    
                    <!-- 分頁按鈕 -->
                    <div id="pagination" class="pagination" style="display: none;">
                        <button id="prevPageBtn" onclick="changePage(-1)">⬅️ 上一頁</button>
                        <span id="pageInfo" class="pagination-info">第 1 頁</span>
                        <button id="nextPageBtn" onclick="changePage(1)">下一頁 ➡️</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 控制面板 Modal -->
        <div id="controlModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="close">&times;</span>
                <h2 style="text-align: center; margin-bottom: 25px;">🎛️ 控制面板</h2>
                <!-- 控制面板內容 -->
                <div id="controlPanelContent">
                    <div class="control-panel">
                        <!-- 當前歌曲資訊卡片 -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);">
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div id="controlThumbnail" style="flex-shrink: 0;">
                                    <div style="width: 140px; height: 105px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                                        無縮圖
                                    </div>
                                </div>
                                <div style="flex: 1; color: white;">
                                    <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px; font-weight: 500;">🎵 正在播放</p>
                                    <p id="controlCurrentSong" style="font-size: 1.3em; font-weight: 600; line-height: 1.4; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">無</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 切歌按鈕組 -->
                        <div style="background: rgba(246, 248, 250, 0.8); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                            <p style="font-size: 0.85em; color: #666; margin-bottom: 12px; font-weight: 600; text-align: center;">🎵 切換歌曲</p>
                            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                                <button id="prevBtn" class="btn" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1.1em; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                    <div style="font-size: 1.3em; margin-bottom: 5px;">⏮️</div>
                                    <div>上一首</div>
                                </button>
                                <button id="nextBtn" class="btn" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1.1em; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                    <div style="font-size: 1.3em; margin-bottom: 5px;">⏭️</div>
                                    <div>下一首</div>
                                </button>
                                <button id="fakeFullscreenBtn" class="btn" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; font-size: 1.1em; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);">
                                    <div style="font-size: 1.3em; margin-bottom: 5px;">⛶</div>
                                    <div>大螢幕</div>
                                </button>
                            </div>
                            <button id="randomBtn" class="btn" style="width: 100%; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; font-size: 1em; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                                <span style="font-size: 1.2em; margin-right: 5px;">🎲</span> 隨機排序
                            </button>
                        </div>
                        
                        <!-- 危險操作 -->
                        <div class="control-actions">
                            <button id="clearQueueBtn" class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);">
                                🗑️ 清空排隊列表
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrCodeModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 style="margin-bottom: 25px;">📱 掃描 QR Code 加入歌曲</h2>
                <div style="text-align: center; padding: 20px;">
                    <img src="ktv_qr_code.png" alt="KTV QR Code" style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                </div>
            </div>
        </div>

        <!-- 歌曲列表 Modal -->
        <div id="songListModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <span class="close">&times;</span>
                <h2 style="margin-bottom: 25px;">📋 歌曲列表</h2>
                
                <!-- Tab 導航 -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="queue">排隊中 (<span id="queueCount">0</span>)</button>
                    <button class="tab-btn" data-tab="all">所有歌曲 (<span id="allSongsCount">0</span>)</button>
                    <button class="tab-btn" data-tab="history">歷史記錄 (<span id="historyCount">0</span>)</button>
                </div>

                <!-- 排隊列表內容 -->
                <div id="queueTab" class="tab-content active">
                    <div id="queueList" class="queue-list">
                        <div class="empty-queue">目前沒有排隊的歌曲</div>
                    </div>
                </div>

                <!-- 所有歌曲內容 -->
                <div id="allTab" class="tab-content">
                    <div id="allSongsList" class="queue-list">
                        <div class="empty-queue">目前沒有歌曲</div>
                    </div>
                </div>

                <!-- 歷史記錄內容 -->
                <div id="historyTab" class="tab-content">
                    <div style="margin-bottom: 15px;">
                        <button id="clearHistoryBtn" class="btn btn-warning">🗑️ 清除歷史記錄</button>
                    </div>
                    <div id="historyList" class="queue-list">
                        <div class="empty-queue">目前沒有歷史記錄</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
        
        <!-- SortableJS -->
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        
        <!-- YouTube IFrame API -->
        <script src="https://www.youtube.com/iframe_api"></script>
        <script>
            // ========================================
            // Firebase 配置
            // ========================================
            const firebaseConfig = {
                apiKey: "AIzaSyA_uBESf6A9gSP6CPhpIdISNKw5C5DHUuA",
                authDomain: "ktv-queue-system.firebaseapp.com",
                databaseURL: "https://ktv-queue-system-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "ktv-queue-system",
                storageBucket: "ktv-queue-system.firebasestorage.app",
                messagingSenderId: "152366647471",
                appId: "1:152366647471:web:d2936422e308c017b5ec5a"
            };

            // 初始化 Firebase
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const queueRef = database.ref('queue');
            const currentIndexRef = database.ref('currentSongIndex');
            const historyRef = database.ref('history');

            // 全局變數
            let player;
            let queue = [];
            let history = [];
            let currentSongIndex = -1;
            let isPlaying = false;
            let currentTab = 'queue';
            const YOUTUBE_API_KEY = "AIzaSyC9AM2D58fmNpyQNbU7pUsCOX7GVEWIrA4"; // YouTube API Key

            // 歌詞相關變數
            let currentLyrics = [];
            let lyricsUpdateInterval = null;
            let currentLyricsIndex = -1;
            let lyricsEnabled = false; // 預設關閉歌詞
            
            // 自動播放設定 - 從 localStorage 讀取，預設為 true（開啟）
            let autoplayEnabled = localStorage.getItem('autoplayEnabled');
            if (autoplayEnabled === null) {
                autoplayEnabled = true; // 預設開啟自動播放
                localStorage.setItem('autoplayEnabled', 'true');
            } else {
                autoplayEnabled = autoplayEnabled === 'true';
            }
            
            // 防止 Firebase 監聽器與本地操作衝突
            let isSavingToFirebase = false;

            // 監聽 Firebase 數據變化
            function setupFirebaseListeners() {
                // 監聽排隊列表變化
                queueRef.on('value', (snapshot) => {
                    // 如果正在保存數據，跳過這次更新避免衝突
                    if (isSavingToFirebase) {
                        console.log('⏭️ Skipping Firebase update (saving in progress)');
                        return;
                    }
                    
                    const data = snapshot.val();
                    if (data) {
                        queue = data;
                    } else {
                        queue = [];
                    }
                    updateUI();
                });

                // 監聽歷史記錄變化
                historyRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        history = data;
                    } else {
                        history = [];
                    }
                    updateUI();
                });

                // 監聽當前播放索引變化
                currentIndexRef.on('value', (snapshot) => {
                    // 如果正在保存數據，跳過這次更新避免衝突
                    if (isSavingToFirebase) {
                        console.log('⏭️ Skipping Firebase index update (saving in progress)');
                        return;
                    }
                    
                    const index = snapshot.val();
                    if (index !== null && index !== currentSongIndex) {
                        const oldIndex = currentSongIndex;
                        currentSongIndex = index;
                        
                        // 如果索引改變且播放器已準備好，載入新歌曲
                        if (oldIndex !== index && currentSongIndex >= 0 && currentSongIndex < queue.length) {
                            const song = queue[currentSongIndex];
                            const videoId = extractVideoId(song.url);
                            if (videoId && player) {
                                // 根據自動播放設定使用不同的方法
                                if (autoplayEnabled) {
                                    console.log('🎬 Firebase 更新: 自動播放已開啟，使用 loadVideoById');
                                    if (player.loadVideoById) {
                                        player.loadVideoById(videoId);
                                    }
                                } else {
                                    console.log('⏸️ Firebase 更新: 自動播放已關閉，使用 cueVideoById');
                                    if (player.cueVideoById) {
                                        player.cueVideoById(videoId);
                                    }
                                }
                            }
                        }
                        updateUI();
                    }
                });
            }

            // 保存數據到 Firebase
            async function saveToFirebase() {
                try {
                    isSavingToFirebase = true;
                    await queueRef.set(queue);
                    await currentIndexRef.set(currentSongIndex);
                    console.log('✅ Data saved to Firebase successfully');
                    
                    // 短暫延遲後重新啟用監聽器更新
                    setTimeout(() => {
                        isSavingToFirebase = false;
                    }, 500);
                } catch (error) {
                    console.error('❌ Error saving to Firebase:', error);
                    isSavingToFirebase = false;
                }
            }

            // 保存歷史記錄到 Firebase
            function saveHistoryToFirebase() {
                historyRef.set(history);
            }

            // 添加到歷史記錄（去重）
            function addToHistory(song) {
                console.log('🎵 Adding to history:', song);
                const videoId = extractVideoId(song.url);
                console.log('📹 Video ID:', videoId);
                
                // 檢查本地歷史是否已存在
                const exists = history.some(h => extractVideoId(h.url) === videoId);
                console.log('🔍 Already exists:', exists);
                
                if (!exists) {
                    // 添加到本地數組開頭（最新的在前面）
                    const newHistoryItem = {
                        songName: song.songName,
                        url: song.url,
                        addedAt: new Date().toISOString()
                    };
                    
                    history.unshift(newHistoryItem);
                    console.log('✅ Added to history:', newHistoryItem);
                    console.log('📊 History length:', history.length);
                    
                    // 保存到 Firebase
                    historyRef.set(history).then(() => {
                        console.log('💾 Saved to Firebase successfully');
                        updateUI();
                    }).catch((error) => {
                        console.error('❌ Firebase save error:', error);
                    });
                } else {
                    console.log('⚠️ Song already in history, skipping');
                }
            }

            // 從 YouTube URL 提取影片 ID
            function extractVideoId(url) {
                if (!url) return null;
                
                // 方法 1: 處理 youtu.be 短網址
                let match = url.match(/youtu\.be\/([^?&]+)/);
                if (match) return match[1];
                
                // 方法 2: 處理標準 youtube.com 網址
                match = url.match(/[?&]v=([^&]+)/);
                if (match) return match[1];
                
                // 方法 3: 處理 embed 網址
                match = url.match(/\/embed\/([^?&]+)/);
                if (match) return match[1];
                
                // 方法 4: 舊的正則表達式作為最後備用
                const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
                match = url.match(regExp);
                return (match && match[7].length === 11) ? match[7] : null;
            }

            // 獲取 YouTube 縮圖 URL
            function getThumbnailUrl(videoId) {
                return `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
            }

            // ========================================
            // 歌詞功能
            // ========================================

            // 從歌曲標題解析歌手和歌名
            function parseSongTitle(title) {
                console.log('🎵 Parsing title:', title);
                
                // 移除常見的無關字詞
                let cleanTitle = title
                    .replace(/\(Official.*?\)/gi, '')
                    .replace(/\[Official.*?\]/gi, '')
                    .replace(/Official/gi, '')
                    .replace(/Music Video/gi, '')
                    .replace(/MV/gi, '')
                    .replace(/Video/gi, '')
                    .replace(/Audio/gi, '')
                    .replace(/Lyric.*?/gi, '')
                    .replace(/HD/gi, '')
                    .replace(/4K/gi, '')
                    .replace(/\(.*?Ver.*?\)/gi, '')
                    .replace(/\[.*?Ver.*?\]/gi, '')
                    .trim();
                
                // 常見分隔符: - / | 【】
                let artist = '';
                let track = cleanTitle;
                
                // 方法 1: 使用 - 分隔
                if (cleanTitle.includes(' - ')) {
                    const parts = cleanTitle.split(' - ');
                    artist = parts[0].trim();
                    track = parts[1].trim();
                    
                    // 不要在這裡縮減歌名，保留完整的歌名讓搜尋階段處理
                    // 例如保留 "東邪 Peach Blossom Island" 完整形式
                }
                // 方法 2: 使用 / 分隔
                else if (cleanTitle.includes(' / ')) {
                    const parts = cleanTitle.split(' / ');
                    artist = parts[0].trim();
                    track = parts[1].trim();
                }
                // 方法 3: 使用 | 分隔
                else if (cleanTitle.includes(' | ')) {
                    const parts = cleanTitle.split(' | ');
                    artist = parts[0].trim();
                    track = parts[1].trim();
                }
                // 方法 4: 使用【】分隔 (中文常見格式)
                else if (cleanTitle.includes('【') && cleanTitle.includes('】')) {
                    const match = cleanTitle.match(/(.+?)【(.+?)】/);
                    if (match) {
                        artist = match[1].trim();
                        track = match[2].trim();
                    }
                }
                
                console.log('🎤 Parsed - Artist:', artist, 'Track:', track);
                return { artist, track };
            }

            // 從 LRCLIB 獲取歌詞
            async function fetchLyricsFromLRCLIB(artist, track) {
                try {
                    const url = `https://lrclib.net/api/search?artist_name=${encodeURIComponent(artist)}&track_name=${encodeURIComponent(track)}`;
                    console.log('🔍 LRCLIB API URL:', url);
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.log('❌ LRCLIB response not ok:', response.status);
                        return null;
                    }
                    
                    const data = await response.json();
                    console.log('📦 LRCLIB response:', data);
                    
                    if (data && data.length > 0) {
                        // 取第一個結果
                        const result = data[0];
                        if (result.syncedLyrics) {
                            console.log('✅ Found synced lyrics!');
                            return result.syncedLyrics;
                        } else if (result.plainLyrics) {
                            console.log('⚠️ Only plain lyrics available');
                            return result.plainLyrics;
                        }
                    }
                    
                    console.log('❌ No lyrics found in LRCLIB');
                    return null;
                } catch (error) {
                    console.error('❌ LRCLIB error:', error);
                    return null;
                }
            }

            // 從 YouTube 描述或其他來源獲取歌詞（備用方案）
            async function fetchLyricsBackup(songName) {
                try {
                    // 嘗試從歌名中提取關鍵字
                    const cleanName = songName
                        .replace(/\(.*?\)/g, '')
                        .replace(/\[.*?\]/g, '')
                        .replace(/official|mv|video|audio|lyrics?/gi, '')
                        .trim();
                    
                    console.log('🔄 Trying backup search with:', cleanName);
                    
                    // 使用 LRCLIB 的模糊搜尋
                    const url = `https://lrclib.net/api/search?q=${encodeURIComponent(cleanName)}`;
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            const result = data[0];
                            if (result.syncedLyrics) {
                                console.log('✅ Found lyrics via backup search!');
                                return result.syncedLyrics;
                            }
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error('❌ Backup search error:', error);
                    return null;
                }
            }

            // 解析 LRC 格式歌詞
            function parseLRC(lrcText) {
                if (!lrcText) return [];
                
                const lines = lrcText.split('\n');
                const lyrics = [];
                
                for (const line of lines) {
                    // 匹配時間標籤 [mm:ss.xx] 或 [mm:ss]
                    const match = line.match(/\[(\d{2}):(\d{2})\.?(\d{2})?\](.*)/);
                    if (match) {
                        const minutes = parseInt(match[1]);
                        const seconds = parseInt(match[2]);
                        const centiseconds = match[3] ? parseInt(match[3]) : 0;
                        const text = match[4].trim();
                        
                        // 轉換為秒
                        const time = minutes * 60 + seconds + centiseconds / 100;
                        
                        if (text) {  // 只添加有文字的行
                            lyrics.push({ time, text });
                        }
                    }
                }
                
                // 按時間排序
                lyrics.sort((a, b) => a.time - b.time);
                
                console.log('📝 Parsed lyrics:', lyrics.length, 'lines');
                return lyrics;
            }

            // 檢查歌詞是否可用（靜默檢查，不顯示載入中）
            async function checkLyricsAvailability(songName) {
                try {
                    console.log('🔍 Checking lyrics availability for:', songName);
                    
                    const toggleBtn = document.getElementById('toggleLyricsBtn');
                    const statusText = document.getElementById('lyricsStatusText');
                    
                    // 解析歌名
                    const { artist, track } = parseSongTitle(songName);
                    
                    if (!track) {
                        console.log('❌ Cannot parse song title');
                        if (toggleBtn) {
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        if (statusText) {
                            statusText.style.display = 'block';
                        }
                        return false;
                    }
                    
                    // 準備多種搜尋關鍵字組合
                    const searchVariants = [];
                    
                    // 1. 原始的歌手 + 歌名（完整）
                    if (artist && track) {
                        searchVariants.push({ artist, track, label: '歌手+完整歌名' });
                    }
                    
                    // 2. 只用完整歌名
                    if (track) {
                        searchVariants.push({ artist: '', track, label: '只用完整歌名' });
                    }
                    
                    // 3. 清理歌手名（移除 MC, DJ 等前綴）+ 完整歌名
                    if (artist) {
                        const cleanArtist = artist.replace(/^(MC|DJ|Mr\.|Ms\.)\s+/gi, '').trim();
                        if (cleanArtist !== artist && cleanArtist) {
                            searchVariants.push({ artist: cleanArtist, track, label: '清理後的歌手+完整歌名' });
                        }
                    }
                    
                    // 4. 提取歌名中的所有中文部分（可能有多個中文詞）
                    const allChineseMatches = track.match(/[\u4e00-\u9fa5]+/g);
                    if (allChineseMatches && allChineseMatches.length > 0) {
                        // 4a. 第一個中文詞
                        const firstChinese = allChineseMatches[0];
                        if (firstChinese !== track) {
                            searchVariants.push({ artist: '', track: firstChinese, label: '第一個中文詞' });
                            if (artist) {
                                searchVariants.push({ artist, track: firstChinese, label: '歌手+第一個中文詞' });
                            }
                        }
                        
                        // 4b. 所有中文詞組合
                        if (allChineseMatches.length > 1) {
                            const allChinese = allChineseMatches.join('');
                            searchVariants.push({ artist: '', track: allChinese, label: '所有中文詞組合' });
                        }
                    }
                    
                    // 5. 提取歌名中的所有英文部分
                    const allEnglishMatches = track.match(/[A-Za-z]+/g);
                    if (allEnglishMatches && allEnglishMatches.length > 0) {
                        // 5a. 完整英文部分（保留空格）
                        const englishMatch = track.match(/([A-Za-z\s]+)/);
                        if (englishMatch && englishMatch[1].trim() && englishMatch[1].trim() !== track) {
                            const englishTrack = englishMatch[1].trim();
                            searchVariants.push({ artist: '', track: englishTrack, label: '完整英文部分' });
                            if (artist) {
                                searchVariants.push({ artist, track: englishTrack, label: '歌手+完整英文部分' });
                            }
                        }
                        
                        // 5b. 第一個英文詞
                        const firstEnglish = allEnglishMatches[0];
                        if (firstEnglish.length > 2) { // 避免像 "a", "of" 這種太短的詞
                            searchVariants.push({ artist: '', track: firstEnglish, label: '第一個英文詞' });
                        }
                    }
                    
                    // 6. 清理後的歌手 + 只用中文
                    if (artist && allChineseMatches && allChineseMatches.length > 0) {
                        const cleanArtist = artist.replace(/^(MC|DJ|Mr\.|Ms\.)\s+/gi, '').trim();
                        const firstChinese = allChineseMatches[0];
                        if (cleanArtist !== artist && firstChinese !== track) {
                            searchVariants.push({ artist: cleanArtist, track: firstChinese, label: '清理後歌手+中文詞' });
                        }
                    }
                    
                    // 逐一嘗試所有搜尋變體
                    let lrcText = null;
                    for (const variant of searchVariants) {
                        console.log(`🔄 嘗試搜尋 (${variant.label}):`, variant.artist, '-', variant.track);
                        lrcText = await fetchLyricsFromLRCLIB(variant.artist, variant.track);
                        if (lrcText) {
                            console.log(`✅ 找到歌詞！使用: ${variant.label}`);
                            break;
                        }
                    }
                    
                    // 最後嘗試模糊搜尋（使用原始歌名）
                    if (!lrcText) {
                        console.log('🔄 嘗試模糊搜尋...');
                        lrcText = await fetchLyricsBackup(songName);
                    }
                    
                    if (!lrcText) {
                        console.log('❌ No lyrics found');
                        // 找不到歌詞，禁用按鈕並顯示提示
                        if (toggleBtn) {
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        if (statusText) {
                            statusText.style.display = 'block';
                        }
                        return false;
                    } else {
                        console.log('✅ Lyrics found!');
                        // 找到歌詞，啟用按鈕並隱藏提示
                        if (toggleBtn) {
                            toggleBtn.disabled = false;
                            toggleBtn.style.opacity = '1';
                            toggleBtn.style.cursor = 'pointer';
                        }
                        if (statusText) {
                            statusText.style.display = 'none';
                        }
                        return true;
                    }
                } catch (error) {
                    console.error('❌ Error checking lyrics:', error);
                    const toggleBtn = document.getElementById('toggleLyricsBtn');
                    const statusText = document.getElementById('lyricsStatusText');
                    if (toggleBtn) {
                        toggleBtn.disabled = true;
                        toggleBtn.style.opacity = '0.5';
                        toggleBtn.style.cursor = 'not-allowed';
                    }
                    if (statusText) {
                        statusText.style.display = 'block';
                    }
                    return false;
                }
            }

            // 載入歌詞
            async function loadLyrics(songName) {
                try {
                    console.log('🎵 Loading lyrics for:', songName);
                    
                    const lyricsContainer = document.getElementById('lyricsContainer');
                    const toggleBtn = document.getElementById('toggleLyricsBtn');
                    const statusText = document.getElementById('lyricsStatusText');
                    
                    // 重置按鈕狀態和提示文字
                    if (toggleBtn) {
                        toggleBtn.disabled = false;
                        toggleBtn.style.opacity = '1';
                        toggleBtn.style.cursor = 'pointer';
                    }
                    if (statusText) {
                        statusText.style.display = 'none';
                    }
                    
                    if (!lyricsContainer) {
                        console.error('❌ Lyrics container not found');
                        return;
                    }
                    
                    // 顯示載入中
                    lyricsContainer.innerHTML = '<div class="lyrics-loading"><span class="loading"></span> 正在載入歌詞...</div>';
                    
                    // 解析歌名
                    const { artist, track } = parseSongTitle(songName);
                    
                    if (!track) {
                        console.log('❌ Cannot parse song title');
                        lyricsEnabled = false;
                        const toggleBtn = document.getElementById('toggleLyricsBtn');
                        if (toggleBtn) {
                            toggleBtn.textContent = '🎤 顯示歌詞';
                            toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        lyricsContainer.innerHTML = '';
                        return;
                    }
                    
                    // 準備多種搜尋關鍵字組合
                    const searchVariants = [];
                    
                    // 1. 原始的歌手 + 歌名（完整）
                    if (artist && track) {
                        searchVariants.push({ artist, track, label: '歌手+完整歌名' });
                    }
                    
                    // 2. 只用完整歌名
                    if (track) {
                        searchVariants.push({ artist: '', track, label: '只用完整歌名' });
                    }
                    
                    // 3. 清理歌手名（移除 MC, DJ 等前綴）+ 完整歌名
                    if (artist) {
                        const cleanArtist = artist.replace(/^(MC|DJ|Mr\.|Ms\.)\s+/gi, '').trim();
                        if (cleanArtist !== artist && cleanArtist) {
                            searchVariants.push({ artist: cleanArtist, track, label: '清理後的歌手+完整歌名' });
                        }
                    }
                    
                    // 4. 提取歌名中的所有中文部分（可能有多個中文詞）
                    const allChineseMatches = track.match(/[\u4e00-\u9fa5]+/g);
                    if (allChineseMatches && allChineseMatches.length > 0) {
                        // 4a. 第一個中文詞
                        const firstChinese = allChineseMatches[0];
                        if (firstChinese !== track) {
                            searchVariants.push({ artist: '', track: firstChinese, label: '第一個中文詞' });
                            if (artist) {
                                searchVariants.push({ artist, track: firstChinese, label: '歌手+第一個中文詞' });
                            }
                        }
                        
                        // 4b. 所有中文詞組合
                        if (allChineseMatches.length > 1) {
                            const allChinese = allChineseMatches.join('');
                            searchVariants.push({ artist: '', track: allChinese, label: '所有中文詞組合' });
                        }
                    }
                    
                    // 5. 提取歌名中的所有英文部分
                    const allEnglishMatches = track.match(/[A-Za-z]+/g);
                    if (allEnglishMatches && allEnglishMatches.length > 0) {
                        // 5a. 完整英文部分（保留空格）
                        const englishMatch = track.match(/([A-Za-z\s]+)/);
                        if (englishMatch && englishMatch[1].trim() && englishMatch[1].trim() !== track) {
                            const englishTrack = englishMatch[1].trim();
                            searchVariants.push({ artist: '', track: englishTrack, label: '完整英文部分' });
                            if (artist) {
                                searchVariants.push({ artist, track: englishTrack, label: '歌手+完整英文部分' });
                            }
                        }
                        
                        // 5b. 第一個英文詞
                        const firstEnglish = allEnglishMatches[0];
                        if (firstEnglish.length > 2) { // 避免像 "a", "of" 這種太短的詞
                            searchVariants.push({ artist: '', track: firstEnglish, label: '第一個英文詞' });
                        }
                    }
                    
                    // 6. 清理後的歌手 + 只用中文
                    if (artist && allChineseMatches && allChineseMatches.length > 0) {
                        const cleanArtist = artist.replace(/^(MC|DJ|Mr\.|Ms\.)\s+/gi, '').trim();
                        const firstChinese = allChineseMatches[0];
                        if (cleanArtist !== artist && firstChinese !== track) {
                            searchVariants.push({ artist: cleanArtist, track: firstChinese, label: '清理後歌手+中文詞' });
                        }
                    }
                    
                    // 逐一嘗試所有搜尋變體
                    let lrcText = null;
                    for (const variant of searchVariants) {
                        console.log(`🔄 嘗試搜尋 (${variant.label}):`, variant.artist, '-', variant.track);
                        lrcText = await fetchLyricsFromLRCLIB(variant.artist, variant.track);
                        if (lrcText) {
                            console.log(`✅ 找到歌詞！使用: ${variant.label}`);
                            break;
                        }
                    }
                    
                    // 最後嘗試模糊搜尋（使用原始歌名）
                    if (!lrcText) {
                        console.log('🔄 嘗試模糊搜尋...');
                        lrcText = await fetchLyricsBackup(songName);
                    }
                    
                    if (!lrcText) {
                        console.log('❌ No lyrics found after all attempts');
                        // 找不到歌詞，自動關閉歌詞功能並禁用按鈕，並顯示提示文字
                        lyricsEnabled = false;
                        const lyricsSection = document.getElementById('lyricsSection');
                        
                        if (lyricsSection) {
                            lyricsSection.classList.remove('show');
                        }
                        if (toggleBtn) {
                            toggleBtn.classList.remove('active');
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        if (statusText) {
                            statusText.style.display = 'block';
                        }
                        lyricsContainer.innerHTML = '';
                        currentLyrics = [];
                        return;
                    }
                    
                    // 找到歌詞，隱藏提示文字
                    if (statusText) {
                        statusText.style.display = 'none';
                    }
                    
                    // 解析歌詞
                    currentLyrics = parseLRC(lrcText);
                    
                    if (currentLyrics.length === 0) {
                        // 如果是純文字歌詞（沒有時間軸）
                        lyricsContainer.innerHTML = `<div class="lyrics-line active">${lrcText.replace(/\n/g, '<br>')}</div>`;
                        return;
                    }
                    
                    // 檢查第一句歌詞時間是否超過 10 秒，如果是，插入倒數提醒
                    if (currentLyrics.length > 0 && currentLyrics[0].time > 10) {
                        const firstLyricTime = currentLyrics[0].time;
                        // 倒數點在第一句歌詞前 2.7 秒出現（實際顯示時會提早 0.5 秒，所以總共提早 3.2 秒）
                        const countdownTime = firstLyricTime - 2.7;
                        const countdownLyric = {
                            time: countdownTime,
                            text: '●●●',
                            isCountdown: true  // 標記這是倒數提醒
                        };
                        // 插入到第一句歌詞之前
                        currentLyrics.unshift(countdownLyric);
                        
                        // 第一句歌詞時間不變，保持原本時間
                        // 這樣倒數點會在 firstLyricTime - 2.7 顯示
                        // 第一句歌詞會在 firstLyricTime 顯示
                        // 它們不會同時顯示，而是倒數點先出現2.7秒，然後第一句歌詞出現
                        
                        console.log('✅ 插入倒數提醒歌詞，時間:', countdownTime);
                        console.log('✅ 第一句歌詞時間:', currentLyrics[1].time);
                    }
                    
                    // 顯示歌詞
                    displayLyrics();
                    
                    // 開始同步更新
                    startLyricsSync();
                } catch (error) {
                    console.error('❌ Error loading lyrics:', error);
                    const lyricsContainer = document.getElementById('lyricsContainer');
                    if (lyricsContainer) {
                        lyricsEnabled = false;
                        if (toggleBtn) {
                            toggleBtn.classList.remove('active');
                            toggleBtn.disabled = true;
                            toggleBtn.style.opacity = '0.5';
                            toggleBtn.style.cursor = 'not-allowed';
                        }
                        lyricsContainer.innerHTML = '';
                    }
                }
            }

            // 顯示歌詞
            function displayLyrics() {
                const lyricsContainer = document.getElementById('lyricsContainer');
                
                if (currentLyrics.length === 0) {
                    lyricsContainer.innerHTML = '';
                    return;
                }
                
                // 顯示歌詞 - 倒數點和第一句歌詞分開但視覺上組合
                let html = '';
                let hasCountdown = false;
                let countdownIndex = -1;
                let firstLyricIndex = -1;
                
                // 找到倒數和第一句歌詞的索引
                currentLyrics.forEach((line, index) => {
                    if (line.isCountdown) {
                        hasCountdown = true;
                        countdownIndex = index;
                    } else if (firstLyricIndex === -1) {
                        firstLyricIndex = index;
                    }
                });
                
                // 生成 HTML
                currentLyrics.forEach((line, index) => {
                    if (line.isCountdown) {
                        // 倒數點單獨一行
                        html += `<div class="lyrics-line lyrics-countdown" data-index="${index}" data-time="${line.time}">
                            <span class="countdown-dot dot-1">●</span>
                            <span class="countdown-dot dot-2">●</span>
                            <span class="countdown-dot dot-3">●</span>
                        </div>`;
                        console.log('🔵 Generated countdown HTML at index:', index, 'time:', line.time);
                    } else if (hasCountdown && index === firstLyricIndex) {
                        // 第一句歌詞（有倒數時添加特殊 class）
                        html += `<div class="lyrics-line first-lyric-with-countdown" data-index="${index}" data-time="${line.time}">${line.text}</div>`;
                        console.log('🔵 Generated first lyric HTML at index:', index, 'time:', line.time);
                    } else {
                        // 其他歌詞
                        html += `<div class="lyrics-line" data-index="${index}" data-time="${line.time}">${line.text}</div>`;
                    }
                });
                
                lyricsContainer.innerHTML = html;
            }

            // 開始歌詞同步
            function startLyricsSync() {
                // 清除舊的定時器
                if (lyricsUpdateInterval) {
                    clearInterval(lyricsUpdateInterval);
                }
                
                // 每 100ms 更新一次歌詞高亮
                lyricsUpdateInterval = setInterval(updateLyricsHighlight, 100);
                console.log('🎤 Lyrics sync started');
            }

            // 停止歌詞同步
            function stopLyricsSync() {
                if (lyricsUpdateInterval) {
                    clearInterval(lyricsUpdateInterval);
                    lyricsUpdateInterval = null;
                }
                console.log('⏸️ Lyrics sync stopped');
            }

            // 更新歌詞高亮
            function updateLyricsHighlight() {
                if (!player || !player.getCurrentTime || currentLyrics.length === 0) {
                    return;
                }
                
                const currentTime = player.getCurrentTime();
                const ADVANCE_TIME = 0.5; // 歌詞提早 0.5 秒顯示
                const adjustedTime = currentTime + ADVANCE_TIME;
                
                // 找到當前應該高亮的歌詞索引（使用提早的時間）
                // 從前往後找第一個時間已到的歌詞
                let newIndex = -1;
                for (let i = currentLyrics.length - 1; i >= 0; i--) {
                    if (adjustedTime >= currentLyrics[i].time) {
                        newIndex = i;
                        break;
                    }
                }
                
                // 特殊處理：如果是倒數點（index 0），檢查是否應該同時顯示第一句歌詞
                if (newIndex === 0 && currentLyrics[0].isCountdown && currentLyrics.length > 1) {
                    // 如果第一句歌詞的時間也到了，優先顯示倒數點
                    // （倒數點會比第一句歌詞早0.01秒，所以倒數點會先被匹配到）
                }
                
                // Debug: 每次更新都顯示（只在前 15 秒）
                if (currentTime < 15) {
                    console.log('🕐 Update - Time:', currentTime.toFixed(2), 'Adjusted:', adjustedTime.toFixed(2), 'newIndex:', newIndex, 'currentIndex:', currentLyricsIndex, 'First lyric time:', currentLyrics[0]?.time.toFixed(2));
                }
                
                // 如果索引沒變，不需要更新
                if (newIndex === currentLyricsIndex) {
                    return;
                }
                
                currentLyricsIndex = newIndex;
                
                console.log('📍 Index changed to:', newIndex, 'Is countdown?', currentLyrics[newIndex]?.isCountdown);
                
                // 更新所有歌詞行的樣式
                const lyricsLines = document.querySelectorAll('.lyrics-line');
                console.log('📝 Total lyrics lines in DOM:', lyricsLines.length);
                
                lyricsLines.forEach((line, index) => {
                    line.classList.remove('active', 'past', 'future');
                    
                    if (index === currentLyricsIndex) {
                        line.classList.add('active');
                        if (line.classList.contains('lyrics-countdown')) {
                            console.log('🟢 Countdown active at index:', index);
                        }
                        // 倒數點的動畫由 CSS 自動處理，不需要 JavaScript
                    } else if (index === currentLyricsIndex + 1 && line.classList.contains('first-lyric-with-countdown')) {
                        // 如果當前是倒數點，同時顯示第一句歌詞
                        line.classList.add('active');
                        console.log('🟢 First lyric also active at index:', index);
                    } else if (index < currentLyricsIndex) {
                        line.classList.add('past');
                    } else {
                        line.classList.add('future');
                    }
                });
            }

            // 清除歌詞
            function clearLyrics() {
                stopLyricsSync();
                currentLyrics = [];
                currentLyricsIndex = -1;
                const lyricsContainer = document.getElementById('lyricsContainer');
                if (lyricsContainer) {
                    lyricsContainer.innerHTML = '';
                }
            }

            // ========================================
            // YouTube 相關函數
            // ========================================

            // 從 YouTube API 獲取影片標題
            async function getVideoTitle(videoId) {
                console.log('🎵 Fetching title for video ID:', videoId);
                
                // 驗證 Video ID
                if (!videoId || videoId.length !== 11) {
                    console.error('❌ Invalid video ID:', videoId);
                    return `YouTube 影片 (無效 ID)`;
                }
                
                // 方法 1: 使用 YouTube Data API v3（最可靠）
                if (YOUTUBE_API_KEY && YOUTUBE_API_KEY !== "YOUR-API-KEY") {
                    try {
                        // 使用 snippet 部分獲取標題
                        const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`;
                        console.log('🔍 Trying YouTube API v3...');
                        console.log('📡 API URL:', apiUrl);
                        
                        const response = await fetch(apiUrl);
                        console.log('📥 API Response status:', response.status);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('📦 API Response data:', data);
                            
                            if (data.items && data.items.length > 0) {
                                const title = data.items[0].snippet.title;
                                console.log('✅ Successfully fetched from YouTube API:', title);
                                return title;
                            } else {
                                console.warn('⚠️ No items found in API response');
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('❌ YouTube API error:', response.status, errorText);
                        }
                    } catch (error) {
                        console.error('❌ YouTube API failed:', error.message);
                        console.error('Error details:', error);
                    }
                }
                
                // 方法 2: 使用 oEmbed API（備用）
                try {
                    const oembedUrl = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`;
                    console.log('🔍 Trying oEmbed API...');
                    const response = await fetch(oembedUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.title) {
                            console.log('✅ Successfully fetched from oEmbed:', data.title);
                            return data.title;
                        }
                    }
                } catch (error) {
                    console.error('❌ oEmbed API failed:', error.message);
                }
                
                // 方法 3: 使用 noembed.com（第二備用）
                try {
                    const noembedUrl = `https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`;
                    console.log('🔍 Trying noembed.com...');
                    const response = await fetch(noembedUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.title) {
                            console.log('✅ Successfully fetched from noembed:', data.title);
                            return data.title;
                        }
                    }
                } catch (error) {
                    console.error('❌ noembed failed:', error.message);
                }
                
                // 所有方法都失敗，返回預設名稱
                console.warn('⚠️ All methods failed, using default name');
                return `YouTube 影片 (${videoId})`;
            }

            // YouTube IFrame API 準備就緒時的回調
            function onYouTubeIframeAPIReady() {
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1,
                        'rel': 0,              // 關閉相關影片推薦
                        'showinfo': 0,         // 關閉影片資訊
                        'modestbranding': 1,   // 簡化 YouTube Logo
                        'cc_load_policy': 0,   // 預設關閉字幕
                        'iv_load_policy': 3,   // 關閉影片註解
                        'fs': 1,               // 允許全螢幕
                        'disablekb': 0,        // 允許鍵盤控制
                        'playsinline': 1       // 行動裝置內嵌播放
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }

            function onPlayerReady(event) {
                console.log('Player ready');
                
                // 強制關閉字幕
                try {
                    if (player && player.unloadModule) {
                        player.unloadModule('captions');
                        player.unloadModule('cc');
                        console.log('YouTube captions disabled');
                    }
                } catch (error) {
                    console.log('Could not unload captions:', error);
                }
                
                updateUI();
                
                // 如果有當前歌曲，載入它
                if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                    const currentSong = queue[currentSongIndex];
                    const videoId = extractVideoId(currentSong.url);
                    if (videoId) {
                        player.loadVideoById(videoId);
                    }
                }
            }

            function onPlayerStateChange(event) {
                // 當影片結束時自動播放下一首
                if (event.data === YT.PlayerState.ENDED) {
                    playNext();
                    stopLyricsSync();
                }
                
                // 更新播放狀態
                if (event.data === YT.PlayerState.PLAYING) {
                    isPlaying = true;
                    updatePlayPauseButton();
                    // 開始歌詞同步
                    if (currentLyrics.length > 0) {
                        startLyricsSync();
                    }
                } else if (event.data === YT.PlayerState.PAUSED) {
                    isPlaying = false;
                    updatePlayPauseButton();
                    // 暫停歌詞同步
                    stopLyricsSync();
                }
            }

            // 更新 UI
            function updateUI() {
                updateCurrentSong();
                updateNextSong();
                updateQueue();
                updateAllSongs();
                updateHistory();
                updateControlPanel();
            }

            // 更新當前播放的歌曲顯示
            function updateCurrentSong() {
                const currentSongDiv = document.getElementById('currentSong');
                const controlCurrentSong = document.getElementById('controlCurrentSong');
                const controlThumbnail = document.getElementById('controlThumbnail');
                
                if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                    const song = queue[currentSongIndex];
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    currentSongDiv.innerHTML = `
                        <div class="song-info" style="display: flex; align-items: center; gap: 20px;">
                            ${thumbnailUrl ? `
                                <div class="current-song-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}">
                                </div>
                            ` : ''}
                            <h3 style="font-size: 1.5em; flex: 1;">${song.songName}</h3>
                        </div>
                    `;
                    
                    // 更新控制面板中的正在播放
                    if (controlCurrentSong) {
                        controlCurrentSong.textContent = song.songName;
                    }
                    
                    // 更新控制面板中的縮圖
                    if (controlThumbnail) {
                        if (thumbnailUrl) {
                            controlThumbnail.innerHTML = `
                                <img src="${thumbnailUrl}" alt="${song.songName}" 
                                     style="width: 140px; height: 105px; border-radius: 12px; object-fit: cover; border: 2px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);">
                            `;
                        } else {
                            controlThumbnail.innerHTML = `
                                <div style="width: 140px; height: 105px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                                    無縮圖
                                </div>
                            `;
                        }
                    }
                } else {
                    currentSongDiv.innerHTML = '<div class="no-song">目前沒有歌曲播放</div>';
                    
                    // 更新控制面板中的正在播放
                    if (controlCurrentSong) {
                        controlCurrentSong.textContent = '無';
                    }
                    
                    // 更新控制面板中的縮圖
                    if (controlThumbnail) {
                        controlThumbnail.innerHTML = `
                            <div style="width: 140px; height: 105px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                                無縮圖
                            </div>
                        `;
                    }
                }
            }

            // 更新下一首歌曲顯示
            function updateNextSong() {
                const nextSongDisplay = document.getElementById('nextSongDisplay');
                
                // 計算下一首歌曲（最多顯示3首）
                const nextSongs = queue.slice(currentSongIndex + 1, currentSongIndex + 4);
                
                if (nextSongs.length === 0) {
                    nextSongDisplay.innerHTML = '<div class="empty-queue">沒有下一首歌曲</div>';
                    return;
                }
                
                nextSongDisplay.innerHTML = nextSongs.map((song, index) => {
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    return `
                        <div class="queue-item">
                            <span class="queue-item-number">${index + 1}</span>
                            ${thumbnailUrl ? `
                                <div class="queue-item-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}" draggable="false">
                                </div>
                            ` : ''}
                            <div class="queue-item-info">
                                <h4>${song.songName}</h4>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // 更新排隊列表
            function updateQueue() {
                const queueList = document.getElementById('queueList');
                const queueCount = document.getElementById('queueCount');
                
                // 計算排隊中的歌曲數量（不包括當前播放的）
                const waitingQueue = queue.slice(currentSongIndex + 1);
                queueCount.textContent = waitingQueue.length;
                
                if (waitingQueue.length === 0) {
                    queueList.innerHTML = '<div class="empty-queue">目前沒有排隊的歌曲</div>';
                    return;
                }
                
                queueList.innerHTML = waitingQueue.map((song, index) => {
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    const actualIndex = currentSongIndex + 1 + index;
                    
                    return `
                        <div class="queue-item" data-index="${actualIndex}">
                            <span class="queue-item-drag-handle">☰</span>
                            <span class="queue-item-number">${index + 1}</span>
                            ${thumbnailUrl ? `
                                <div class="queue-item-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}" draggable="false">
                                </div>
                            ` : ''}
                            <div class="queue-item-info">
                                <h4>${song.songName}</h4>
                            </div>
                            <div class="queue-item-actions">
                                <button onclick="event.stopPropagation(); removeSong(${actualIndex})">刪除</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // 初始化 SortableJS
                setupSortable();
            }

            // 設置 SortableJS
            let sortableInstance = null;
            function setupSortable() {
                const queueList = document.getElementById('queueList');
                
                // 銷毀舊的實例
                if (sortableInstance) {
                    sortableInstance.destroy();
                }
                
                // 創建新的 Sortable 實例
                sortableInstance = Sortable.create(queueList, {
                    animation: 200,
                    easing: "cubic-bezier(1, 0, 0, 1)",
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    forceFallback: true,
                    fallbackTolerance: 3,
                    touchStartThreshold: 5,
                    delay: 50,
                    delayOnTouchOnly: true,
                    onEnd: async function(evt) {
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;
                        
                        if (oldIndex !== newIndex) {
                            // 計算實際在 queue 中的索引
                            const actualOldIndex = currentSongIndex + 1 + oldIndex;
                            const actualNewIndex = currentSongIndex + 1 + newIndex;
                            
                            // 移動歌曲
                            const movedSong = queue.splice(actualOldIndex, 1)[0];
                            queue.splice(actualNewIndex, 0, movedSong);
                            
                            // 保存到 Firebase
                            await saveToFirebase();
                            
                            // 立即更新 UI
                            updateUI();
                        }
                    }
                });
            }

            // 更新所有歌曲列表
            function updateAllSongs() {
                const allSongsList = document.getElementById('allSongsList');
                const allSongsCount = document.getElementById('allSongsCount');
                
                allSongsCount.textContent = queue.length;
                
                if (queue.length === 0) {
                    allSongsList.innerHTML = '<div class="empty-queue">目前沒有歌曲</div>';
                    return;
                }
                
                allSongsList.innerHTML = queue.map((song, index) => {
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    // 判斷狀態
                    let statusClass = '';
                    let statusText = '';
                    if (index < currentSongIndex) {
                        statusClass = 'completed';
                        statusText = '✓ 已播放';
                    } else if (index === currentSongIndex) {
                        statusClass = 'playing';
                        statusText = '▶ 播放中';
                    } else {
                        statusText = '⏳ 等待中';
                    }
                    
                    return `
                        <div class="queue-item ${statusClass}">
                            <span class="queue-item-number">${index + 1}</span>
                            ${thumbnailUrl ? `
                                <div class="queue-item-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}" draggable="false">
                                </div>
                            ` : ''}
                            <div class="queue-item-info">
                                <h4>${song.songName}</h4>
                                <p style="font-size: 0.85em; color: #666;">${statusText}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // 更新歷史記錄
            function updateHistory() {
                const historyList = document.getElementById('historyList');
                const historyCount = document.getElementById('historyCount');
                
                historyCount.textContent = history.length;
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="empty-queue">目前沒有歷史記錄</div>';
                    return;
                }
                
                // 倒序顯示（最新的在上面）
                const reversedHistory = [...history].reverse();
                
                historyList.innerHTML = reversedHistory.map((song, index) => {
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    // 檢查這首歌是否已經在排隊列表中
                    const isInQueue = queue.some(queueSong => extractVideoId(queueSong.url) === videoId);
                    
                    // 根據是否已存在設置按鈕狀態
                    let buttonHTML;
                    if (isInQueue) {
                        buttonHTML = `<button id="historyBtn-${index}" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); cursor: not-allowed;" disabled>⚠️ 已存在</button>`;
                    } else {
                        buttonHTML = `<button id="historyBtn-${index}" onclick="readdSong('${song.url.replace(/'/g, "\\'")}', '${song.songName.replace(/'/g, "\\'")}', 'historyBtn-${index}')">➕ 重新加入</button>`;
                    }
                    
                    return `
                        <div class="queue-item">
                            ${thumbnailUrl ? `
                                <div class="queue-item-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${song.songName}" draggable="false">
                                </div>
                            ` : ''}
                            <div class="queue-item-info">
                                <h4>${song.songName}</h4>
                            </div>
                            <div class="queue-item-actions">
                                ${buttonHTML}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // 更新控制面板
            function updateControlPanel() {
                const controlCurrentSong = document.getElementById('controlCurrentSong');
                const controlThumbnail = document.getElementById('controlThumbnail');
                
                if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                    const song = queue[currentSongIndex];
                    const videoId = extractVideoId(song.url);
                    const thumbnailUrl = videoId ? getThumbnailUrl(videoId) : '';
                    
                    controlCurrentSong.textContent = song.songName;
                    
                    if (thumbnailUrl) {
                        controlThumbnail.innerHTML = `
                            <div class="control-panel-thumbnail">
                                <img src="${thumbnailUrl}" alt="${song.songName}">
                            </div>
                        `;
                    } else {
                        controlThumbnail.innerHTML = `
                            <div class="control-panel-thumbnail" style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                                無縮圖
                            </div>
                        `;
                    }
                } else {
                    controlCurrentSong.textContent = '無';
                    controlThumbnail.innerHTML = `
                        <div class="control-panel-thumbnail" style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
                            無縮圖
                        </div>
                    `;
                }
                
                // 更新播放/暫停按鈕狀態
                updatePlayPauseButton();
            }

            // 添加歌曲
            async function addSong(songData, fromSearch = false, fromHistory = false) {
                queue.push(songData);
                
                // 添加到歷史記錄
                addToHistory(songData);
                
                // 如果這是第一首歌，設置當前索引並自動播放
                const isFirstSong = queue.length === 1 && currentSongIndex === -1;
                if (isFirstSong) {
                    currentSongIndex = 0;
                }
                
                // 等待 Firebase 保存完成
                await saveToFirebase();
                
                // 如果是從歷史記錄加入，只更新數字，不重新渲染列表
                if (fromHistory) {
                    // 只更新排隊數字
                    const queueCount = document.getElementById('queueCount');
                    if (queueCount) {
                        queueCount.textContent = Math.max(0, queue.length - currentSongIndex - 1);
                    }
                    const allSongsCount = document.getElementById('allSongsCount');
                    if (allSongsCount) {
                        allSongsCount.textContent = queue.length;
                    }
                    // 更新排隊列表和當前播放
                    updateCurrentSong();
                    updateNextSong();
                    updateQueue();
                    updateAllSongs();
                    updateControlPanel();
                } else {
                    // 其他情況正常更新整個 UI
                    updateUI();
                }
                
                // 如果是第一首歌，開始播放
                if (isFirstSong) {
                    // 延遲一下確保 UI 更新完成
                    setTimeout(() => {
                        playSong(0);
                    }, 500);
                }
            }

            // 從歷史記錄重新加入
            async function readdSong(url, songName, buttonId) {
                const button = document.getElementById(buttonId);
                
                // 檢查是否已經在隊列中
                const videoId = extractVideoId(url);
                const isDuplicate = queue.some(song => extractVideoId(song.url) === videoId);
                
                if (isDuplicate) {
                    // 視覺反饋：已存在（永久保持）
                    button.innerHTML = '⚠️ 已存在';
                    button.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    button.style.cursor = 'not-allowed';
                    button.disabled = true;
                    return;
                }
                
                // 先更新按鈕狀態（在 UI 重新渲染之前）
                button.classList.add('added');
                button.innerHTML = '✓ 已加入';
                button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                button.disabled = true;
                
                // 然後才加入歌曲（不會重新渲染歷史記錄）
                await addSong({
                    songName: songName,
                    url: url,
                    addedAt: new Date().toISOString()
                }, false, true); // fromSearch = false, fromHistory = true
                
                // 保持動畫效果 2 秒後移除 class（但按鈕保持綠色和已加入狀態）
                setTimeout(() => {
                    button.classList.remove('added');
                }, 2000);
            }

            // 播放指定歌曲
            async function playSong(index) {
                if (index < 0 || index >= queue.length) {
                    console.log('Invalid song index:', index);
                    return;
                }
                
                currentSongIndex = index;
                const song = queue[index];
                const videoId = extractVideoId(song.url);
                
                console.log('Playing song:', song.songName, 'videoId:', videoId);
                
                if (!videoId) {
                    console.error('Invalid video ID');
                    return;
                }
                
                if (!player) {
                    console.error('Player not ready');
                    return;
                }
                
                // 顯示倒數提醒 3...2...1...
                // showCountdown(); // 已移除入歌倒數提醒
                
                // 清除舊歌詞
                clearLyrics();
                
                // 重置歌詞按鈕狀態（每次切歌都重置）
                const toggleBtn = document.getElementById('toggleLyricsBtn');
                const statusText = document.getElementById('lyricsStatusText');
                if (toggleBtn) {
                    toggleBtn.disabled = false;
                    toggleBtn.style.opacity = '1';
                    toggleBtn.style.cursor = 'pointer';
                }
                if (statusText) {
                    statusText.style.display = 'none';
                }
                
                // 提前檢查歌詞是否可用（靜默檢查）
                setTimeout(() => {
                    checkLyricsAvailability(song.songName).catch(err => {
                        console.error('檢查歌詞失敗:', err);
                    });
                }, 100);
                
                // 載入影片
                try {
                    // 根據自動播放設定使用不同的方法
                    if (autoplayEnabled) {
                        console.log('🎬 自動播放已開啟，使用 loadVideoById');
                        player.loadVideoById(videoId); // 載入並自動播放
                    } else {
                        console.log('⏸️ 自動播放已關閉，使用 cueVideoById');
                        player.cueVideoById(videoId); // 載入但不自動播放
                    }
                    
                    // 強制關閉字幕
                    setTimeout(() => {
                        try {
                            if (player.unloadModule) {
                                player.unloadModule('captions');
                                player.unloadModule('cc');
                            }
                        } catch (error) {
                            console.log('Could not unload captions on play:', error);
                        }
                    }, 500);
                    
                    console.log('Video loaded');
                } catch (error) {
                    console.error('Error playing video:', error);
                }
                
                // 在後台載入歌詞（如果已開啟）
                if (lyricsEnabled) {
                    setTimeout(() => {
                        loadLyrics(song.songName).catch(err => {
                            console.error('載入歌詞失敗:', err);
                        });
                    }, 100);
                }
                
                await saveToFirebase();
                
                // 更新 UI 顯示當前播放歌曲
                updateCurrentSong();
                updateNextSong();
            }

            // 顯示入歌倒數提醒
            function showCountdown() {
                const playerContainer = document.getElementById('player-container');
                const dots = ['...', '..', '.'];
                let index = 0;
                
                const showDots = () => {
                    if (index >= dots.length) return;
                    
                    const countdownDiv = document.createElement('div');
                    countdownDiv.className = 'countdown-overlay';
                    countdownDiv.textContent = dots[index];
                    playerContainer.appendChild(countdownDiv);
                    
                    setTimeout(() => {
                        countdownDiv.remove();
                    }, 800);
                    
                    index++;
                    if (index < dots.length) {
                        setTimeout(showDots, 800);
                    }
                };
                
                showDots();
            }

            // 切換歌詞顯示
            async function toggleLyrics() {
                const lyricsSection = document.getElementById('lyricsSection');
                const toggleBtn = document.getElementById('toggleLyricsBtn');
                
                if (lyricsEnabled) {
                    // 關閉歌詞
                    lyricsEnabled = false;
                    lyricsSection.classList.remove('show');
                    toggleBtn.classList.remove('active');
                    clearLyrics();
                } else {
                    // 開啟歌詞前先檢測
                    if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                        const song = queue[currentSongIndex];
                        
                        // 先開啟歌詞面板並顯示載入中
                        lyricsEnabled = true;
                        lyricsSection.classList.add('show');
                        toggleBtn.classList.add('active');
                        
                        const lyricsContainer = document.getElementById('lyricsContainer');
                        lyricsContainer.innerHTML = '<div class="lyrics-loading"><span class="loading"></span> 正在載入歌詞...</div>';
                        
                        try {
                            // 嘗試載入歌詞
                            await loadLyrics(song.songName);
                            
                            // 檢查是否成功載入歌詞
                            if (currentLyrics.length === 0 && lyricsContainer.innerHTML === '') {
                                // 沒有找到歌詞，自動關閉
                                lyricsEnabled = false;
                                lyricsSection.classList.remove('show');
                                toggleBtn.classList.remove('active');
                            }
                        } catch (err) {
                            console.error('載入歌詞失敗:', err);
                            lyricsEnabled = false;
                            lyricsSection.classList.remove('show');
                            toggleBtn.classList.remove('active');
                        }
                    }
                }
            }
            
            // 切換假全螢幕
            function toggleFakeFullscreen() {
                const playerSection = document.querySelector('.player-section');
                const btn = document.getElementById('fakeFullscreenBtn');
                
                if (playerSection.classList.contains('fake-fullscreen')) {
                    // 退出假全螢幕
                    playerSection.classList.remove('fake-fullscreen');
                    btn.innerHTML = '<div style="font-size: 1.3em; margin-bottom: 5px;">⛶</div><div>大螢幕</div>';
                    btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                } else {
                    // 進入假全螢幕
                    playerSection.classList.add('fake-fullscreen');
                    btn.innerHTML = '<div style="font-size: 1.3em; margin-bottom: 5px;">✕</div><div>退出</div>';
                    btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
                }
            }

            // 切換自動播放
            function toggleAutoplay() {
                autoplayEnabled = !autoplayEnabled;
                localStorage.setItem('autoplayEnabled', autoplayEnabled.toString());
                
                const toggleBtn = document.getElementById('toggleAutoplayBtn');
                if (autoplayEnabled) {
                    toggleBtn.classList.add('active');
                } else {
                    toggleBtn.classList.remove('active');
                }
                
                console.log('🎬 自動播放設定:', autoplayEnabled ? '開啟' : '關閉');
            }

            // 播放下一首
            async function playNext() {
                console.log('playNext called, current index:', currentSongIndex, 'queue length:', queue.length);
                if (currentSongIndex < queue.length - 1) {
                    await playSong(currentSongIndex + 1);
                    updateCurrentSong();
                    updateNextSong();
                } else {
                    // 已經是最後一首，停止播放
                    console.log('Already at last song');
                    currentSongIndex = queue.length - 1;
                    if (player && player.stopVideo) {
                        player.stopVideo();
                    }
                    await saveToFirebase();
                }
            }

            // 播放上一首
            async function playPrevious() {
                console.log('playPrevious called, current index:', currentSongIndex);
                if (currentSongIndex > 0) {
                    await playSong(currentSongIndex - 1);
                    updateCurrentSong();
                    updateNextSong();
                } else {
                    console.log('Already at first song');
                }
            }

            // 隨機播放
            async function playRandom() {
                console.log('playRandom called, queue length:', queue.length);
                if (queue.length === 0) {
                    return;
                }
                
                if (queue.length === 1) {
                    return;
                }
                
                if (currentSongIndex < 0 || currentSongIndex >= queue.length) {
                    // 如果沒有正在播放的歌曲，打亂整個列表
                    queue = shuffleArray(queue);
                    currentSongIndex = -1;
                } else {
                    // 保留正在播放的歌曲，打亂其他歌曲
                    const currentSong = queue[currentSongIndex];
                    
                    // 移除正在播放的歌曲
                    const otherSongs = queue.filter((song, index) => index !== currentSongIndex);
                    
                    // 打亂其他歌曲
                    const shuffledOthers = shuffleArray(otherSongs);
                    
                    // 重建列表：正在播放的歌曲放在第一位，後面接打亂後的其他歌曲
                    queue = [currentSong, ...shuffledOthers];
                    currentSongIndex = 0;
                }
                
                await saveToFirebase();
                updateUI();
                console.log('Queue shuffled, current index:', currentSongIndex);
            }
            
            // Fisher-Yates 洗牌演算法
            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }

            // 播放/暫停
            function togglePlayPause() {
                if (!player || !player.getPlayerState) {
                    console.log('播放器尚未準備好');
                    return;
                }
                
                const state = player.getPlayerState();
                console.log('Current player state:', state);
                
                if (state === YT.PlayerState.PLAYING) {
                    player.pauseVideo();
                    isPlaying = false;
                } else if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.CUED) {
                    player.playVideo();
                    isPlaying = true;
                } else {
                    // 如果沒有影片或其他狀態，嘗試播放當前歌曲
                    if (currentSongIndex >= 0 && currentSongIndex < queue.length) {
                        playSong(currentSongIndex);
                    } else {
                        console.log('沒有可播放的歌曲');
                    }
                }
                
                updatePlayPauseButton();
            }

            // 更新播放/暫停按鈕
            function updatePlayPauseButton() {
                const btn = document.getElementById('playPauseBtn');
                if (btn) {
                    if (player && player.getPlayerState) {
                        const state = player.getPlayerState();
                        if (state === YT.PlayerState.PLAYING) {
                            btn.innerHTML = '<div style="font-size: 1.4em;">⏸️</div><div style="font-size: 0.75em; margin-top: 4px;">暫停</div>';
                        } else {
                            btn.innerHTML = '<div style="font-size: 1.4em;">▶️</div><div style="font-size: 0.75em; margin-top: 4px;">播放</div>';
                        }
                    } else {
                        btn.innerHTML = '<div style="font-size: 1.4em;">▶️</div><div style="font-size: 0.75em; margin-top: 4px;">播放</div>';
                    }
                }
            }

            // 重播當前歌曲
            function replaySong() {
                if (player && player.seekTo) {
                    player.seekTo(0);
                    player.playVideo();
                } else {
                    console.log('播放器尚未準備好');
                }
            }

            // 快進10秒
            function forward() {
                if (player && player.getCurrentTime && player.seekTo) {
                    const currentTime = player.getCurrentTime();
                    player.seekTo(currentTime + 10);
                } else {
                    console.log('播放器尚未準備好');
                }
            }

            // 後退10秒
            function backward() {
                if (player && player.getCurrentTime && player.seekTo) {
                    const currentTime = player.getCurrentTime();
                    player.seekTo(Math.max(0, currentTime - 10));
                } else {
                    console.log('播放器尚未準備好');
                }
            }

            // 停止播放
            function stopVideo() {
                if (player && player.stopVideo) {
                    player.stopVideo();
                } else {
                    console.log('播放器尚未準備好');
                }
            }

            // 刪除歌曲
            async function removeSong(index) {
                const songName = queue[index]?.songName || '歌曲';
                queue.splice(index, 1);
                
                // 調整當前播放索引
                if (index < currentSongIndex) {
                    currentSongIndex--;
                } else if (index === currentSongIndex) {
                    // 如果刪除的是當前播放的歌，播放下一首
                    if (currentSongIndex >= queue.length) {
                        currentSongIndex = queue.length - 1;
                    }
                    if (currentSongIndex >= 0) {
                        playSong(currentSongIndex);
                    } else {
                        if (player && player.stopVideo) {
                            player.stopVideo();
                        }
                    }
                }
                
                await saveToFirebase();
                
                // 立即更新 UI
                updateUI();
            }

            // 清空排隊列表
            async function clearQueue() {
                if (confirm('確定要清空所有排隊的歌曲嗎？（包括當前播放的歌曲）')) {
                    // 完全清空排隊列表
                    queue = [];
                    currentSongIndex = -1;
                    
                    // 停止播放器
                    if (player && player.stopVideo) {
                        player.stopVideo();
                    }
                    
                    // 停止歌詞同步
                    stopLyricsSync();
                    currentLyrics = [];
                    
                    // 保存到 Firebase
                    await saveToFirebase();
                    
                    // 立即更新 UI
                    updateUI();
                }
            }

            // 清除歷史記錄
            function clearHistory() {
                if (confirm('確定要清除所有歷史記錄嗎？此操作無法復原！')) {
                    history = [];
                    historyRef.set(null).then(() => {
                        // 立即更新 UI
                        updateUI();
                    });
                }
            }

            // Modal 控制
            const addSongModal = document.getElementById('addSongModal');
            const controlModal = document.getElementById('controlModal');
            const qrCodeModal = document.getElementById('qrCodeModal');
            const songListModal = document.getElementById('songListModal');
            const addSongBtn = document.getElementById('addSongBtn');
            const controlPanelBtn = document.getElementById('controlPanelBtn');
            const qrCodeBtn = document.getElementById('qrCodeBtn');
            const songListBtn = document.getElementById('songListBtn');
            const closeBtns = document.getElementsByClassName('close');

            addSongBtn.onclick = () => {
                addSongModal.style.display = 'block';
            };

            songListBtn.onclick = () => {
                songListModal.style.display = 'block';
                updateUI();
            };

            controlPanelBtn.onclick = () => {
                controlModal.style.display = 'block';
                updateControlPanel();
            };

            qrCodeBtn.onclick = () => {
                qrCodeModal.style.display = 'block';
            };

            // Tab 切換
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // 檢查是否是加入歌曲 Modal 的 Tab
                    if (tabName === 'url' || tabName === 'search') {
                        // 加入歌曲 Modal 的 Tab 切換
                        document.querySelectorAll('#addSongModal .tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.add-song-tab-content').forEach(c => c.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.getElementById(tabName + 'TabContent').classList.add('active');
                    } else {
                        // 歌曲列表 Modal 的 Tab 切換
                        document.querySelectorAll('#songListModal .tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.getElementById(tabName + 'Tab').classList.add('active');
                        
                        currentTab = tabName;
                    }
                });
            });

            // YouTube 搜尋功能
            let searchResultsData = [];
            let currentPage = 1;
            let nextPageToken = null;
            let prevPageToken = null;
            let currentSearchQuery = '';

            async function searchYouTube(query, pageToken = null) {
                if (!query.trim()) {
                    return;
                }

                currentSearchQuery = query;
                const searchBtn = document.getElementById('searchBtnText');
                const originalText = searchBtn.textContent;
                searchBtn.innerHTML = '<span class="loading"></span> 搜尋中...';

                try {
                    let apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=20&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}`;
                    if (pageToken) {
                        apiUrl += `&pageToken=${pageToken}`;
                    }
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error('搜尋失敗');
                    }

                    const data = await response.json();
                    searchResultsData = data.items;
                    nextPageToken = data.nextPageToken || null;
                    prevPageToken = data.prevPageToken || null;
                    
                    displaySearchResults(data.items);
                    updatePagination();
                } catch (error) {
                    console.error('Search error:', error);
                    document.getElementById('searchResults').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">搜尋失敗，請稍後再試</div>';
                } finally {
                    searchBtn.textContent = originalText;
                }
            }

            // 換頁
            function changePage(direction) {
                if (direction > 0 && nextPageToken) {
                    currentPage++;
                    searchYouTube(currentSearchQuery, nextPageToken);
                } else if (direction < 0 && prevPageToken) {
                    currentPage--;
                    searchYouTube(currentSearchQuery, prevPageToken);
                }
            }

            // 更新分頁按鈕
            function updatePagination() {
                const pagination = document.getElementById('pagination');
                const prevBtn = document.getElementById('prevPageBtn');
                const nextBtn = document.getElementById('nextPageBtn');
                const pageInfo = document.getElementById('pageInfo');

                if (searchResultsData.length > 0) {
                    pagination.style.display = 'flex';
                    prevBtn.disabled = !prevPageToken;
                    nextBtn.disabled = !nextPageToken;
                    pageInfo.textContent = `第 ${currentPage} 頁`;
                } else {
                    pagination.style.display = 'none';
                }
            }

            // 顯示搜尋結果
            function displaySearchResults(items) {
                const searchResults = document.getElementById('searchResults');
                
                if (!items || items.length === 0) {
                    searchResults.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">沒有找到相關影片</div>';
                    document.getElementById('pagination').style.display = 'none';
                    return;
                }

                searchResults.innerHTML = items.map(item => {
                    const videoId = item.id.videoId;
                    const title = item.snippet.title.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    const channelTitle = item.snippet.channelTitle.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    const thumbnailUrl = item.snippet.thumbnails.medium.url;
                    const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                    
                    // 檢查這首歌是否已經在排隊列表中
                    const isInQueue = queue.some(song => extractVideoId(song.url) === videoId);
                    
                    // 根據是否已存在設置按鈕
                    let buttonHTML;
                    if (isInQueue) {
                        buttonHTML = `<button class="search-result-add-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); cursor: not-allowed;" disabled>⚠️ 已存在</button>`;
                    } else {
                        buttonHTML = `<button class="search-result-add-btn" data-video-id="${videoId}" data-video-url="${videoUrl}" data-video-title="${title}">➕ 加入</button>`;
                    }

                    return `
                        <div class="search-result-item">
                            <div class="search-result-thumbnail" data-video-url="${videoUrl}" style="cursor: pointer;">
                                <img src="${thumbnailUrl}" alt="${title}">
                            </div>
                            <div class="search-result-info">
                                <h4>${title}</h4>
                                <p>${channelTitle}</p>
                            </div>
                            ${buttonHTML}
                        </div>
                    `;
                }).join('');
                
                // 為縮圖添加點擊事件 - 在 YouTube 預覽
                document.querySelectorAll('.search-result-thumbnail').forEach(thumbnail => {
                    thumbnail.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const url = this.getAttribute('data-video-url');
                        if (url) {
                            // 使用 <a> 標籤模擬點擊，更可靠
                            const link = document.createElement('a');
                            link.href = url;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }
                    });
                });
                
                // 為每個按鈕添加事件監聽器
                document.querySelectorAll('.search-result-add-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const url = this.getAttribute('data-video-url');
                        const title = this.getAttribute('data-video-title');
                        addSongFromSearch(url, title, this);
                    });
                });
            }

            // 從搜尋結果加入歌曲
            function addSongFromSearch(url, title, button) {
                // 檢查是否已經在隊列中
                const videoId = extractVideoId(url);
                const isDuplicate = queue.some(song => extractVideoId(song.url) === videoId);
                
                if (isDuplicate) {
                    // 視覺反饋：已存在（永久保持）
                    button.innerHTML = '⚠️ 已存在';
                    button.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    button.style.cursor = 'not-allowed';
                    button.disabled = true;
                    return;
                }

                addSong({
                    songName: title,
                    url: url,
                    addedAt: new Date().toISOString()
                }, true); // 傳遞 fromSearch = true

                // 成功動畫
                button.classList.add('added');
                button.innerHTML = '✓ 已加入';
                button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                button.disabled = true;
                
                // 添加成功的視覺反饋
                setTimeout(() => {
                    button.classList.remove('added');
                }, 600);
            }

            // 搜尋按鈕點擊事件
            document.getElementById('searchBtn').onclick = () => {
                const query = document.getElementById('searchInput').value;
                searchYouTube(query);
            };

            // 搜尋輸入框按 Enter 鍵
            document.getElementById('searchInput').onkeypress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = document.getElementById('searchInput').value;
                    searchYouTube(query);
                }
            };

            // 密碼驗證（已移除）

            // 關閉 modal
            Array.from(closeBtns).forEach(btn => {
                btn.onclick = function() {
                    const modal = this.parentElement.parentElement;
                    modal.style.display = 'none';
                };
            });

            window.onclick = (event) => {
                if (event.target === addSongModal) {
                    addSongModal.style.display = 'none';
                }
                if (event.target === controlModal) {
                    controlModal.style.display = 'none';
                }
                if (event.target === qrCodeModal) {
                    qrCodeModal.style.display = 'none';
                }
                if (event.target === songListModal) {
                    songListModal.style.display = 'none';
                }
            };

            // 表單提交
            document.getElementById('addSongForm').onsubmit = async (e) => {
                e.preventDefault();
                
                const youtubeUrl = document.getElementById('youtubeUrl').value;
                const submitBtn = document.getElementById('addBtnText');
                const originalText = submitBtn.textContent;
                
                // 驗證 URL
                const videoId = extractVideoId(youtubeUrl);
                if (!videoId) {
                    return;
                }
                
                console.log('Adding song with video ID:', videoId);
                
                // 自動獲取歌曲名稱
                submitBtn.innerHTML = '<span class="loading"></span> 正在獲取歌曲資訊...';
                
                let songName;
                try {
                    console.log('Calling getVideoTitle...');
                    songName = await getVideoTitle(videoId);
                    console.log('Got song name:', songName);
                    
                    // 如果獲取失敗（返回預設名稱），提示用戶
                    if (songName.startsWith('YouTube 影片')) {
                        submitBtn.textContent = originalText;
                        return;
                    }
                } catch (error) {
                    console.error('Error fetching title:', error);
                    submitBtn.textContent = originalText;
                    return;
                }
                
                try {
                    // 添加歌曲
                    addSong({
                        songName,
                        url: youtubeUrl,
                        addedAt: new Date().toISOString()
                    });
                    
                    // 清空表單
                    e.target.reset();
                    addSongModal.style.display = 'none';
                } catch (error) {
                    console.error('Error adding song:', error);
                } finally {
                    submitBtn.textContent = originalText;
                }
            };

            // 初始化
            document.addEventListener('DOMContentLoaded', () => {
                console.log('KTV System initialized');
                // 立即設置 Firebase 監聽器，不等待 YouTube Player
                setupFirebaseListeners();
                
                // 控制面板按鈕
                document.getElementById('prevBtn').onclick = playPrevious;
                document.getElementById('nextBtn').onclick = playNext;
                document.getElementById('randomBtn').onclick = playRandom;
                document.getElementById('clearQueueBtn').onclick = clearQueue;
                document.getElementById('clearHistoryBtn').onclick = clearHistory;

                // 假全螢幕按鈕
                document.getElementById('fakeFullscreenBtn').onclick = toggleFakeFullscreen;

                // 自動播放開關按鈕
                const toggleAutoplayBtn = document.getElementById('toggleAutoplayBtn');
                if (toggleAutoplayBtn) {
                    toggleAutoplayBtn.onclick = toggleAutoplay;
                    // 初始化按鈕狀態
                    if (autoplayEnabled) {
                        toggleAutoplayBtn.classList.add('active');
                    }
                    console.log('🎬 自動播放初始設定:', autoplayEnabled ? '開啟' : '關閉');
                }

                // 歌詞開關按鈕
                document.getElementById('toggleLyricsBtn').onclick = toggleLyrics;
                
                // 搜尋按鈕點擊事件
                document.getElementById('searchBtn').onclick = () => {
                    const query = document.getElementById('searchInput').value;
                    searchYouTube(query);
                };

                // 搜尋輸入框按 Enter 鍵
                document.getElementById('searchInput').onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const query = document.getElementById('searchInput').value;
                        searchYouTube(query);
                    }
                };
            });
        </script>
    </body>
    </html>
